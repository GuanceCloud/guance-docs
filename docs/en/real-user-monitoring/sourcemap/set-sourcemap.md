# SourceMap Configuration
---

Sourcemap (source code mapping) is used to map the compressed code in the production environment back to the original source code. RUM supports this source code file information mapping by zipping and uploading the corresponding symbol table files, which can automatically transform the reported `error` measurement data.

## Zip Package Packaging Notes {#sourcemap-zip}

<!-- markdownlint-disable MD046 -->
=== "Web"

    After obfuscating and compressing js files via webpack, zip the generated *.map* files. It is essential to ensure that the file paths after unzipping the package match the URL paths in the `error_stack`. Assuming the following `error_stack`:

    ```
    ReferenceError
      at a.hideDetail @ http://localhost:8080/static/js/app.7fb548e3d065d1f48f74.js:1:1037
      at a.showDetail @ http://localhost:8080/static/js/app.7fb548e3d065d1f48f74.js:1:986
      at <anonymous> @ http://localhost:8080/static/js/app.7fb548e3d065d1f48f74.js:1:1174
    ```

    The path to be converted is */static/js/app.7fb548e3d065d1f48f74.js*, and its corresponding sourcemap path is */static/js/app.7fb548e3d065d1f48f74.js.map*. The directory structure after unzipping the package should look like this:

    ```
    static/
    └── js
    └── app.7fb548e3d065d1f48f74.js.map
    
    ```

    The converted `error_stack_source`:
    
    ```
    
    ReferenceError
      at a.hideDetail @ webpack:///src/components/header/header.vue:94:0
      at a.showDetail @ webpack:///src/components/header/header.vue:91:0
      at <anonymous> @ webpack:///src/components/header/header.vue:101:0
    ```

=== "Mini Programs"

    The packaging method for mini programs is basically consistent with Web.

=== "Android"

    Android currently has two types of `sourcemap` files: one is the mapping file generated by Java bytecode compression and obfuscation using `R8`/`Proguard`, and the other is the unstripped `.so` file containing native C/C++ code symbols and debugging information. If your Android application includes both types of `sourcemap` files, you need to include both files in the zip package. The directory structure after unzipping the zip package looks similar to this:
    
    ```
    <app_id>-<env>-<version>/
    ├── mapping.txt
    ├── armeabi-v7a/
    │   ├── libgameengine.so
    │   ├── libothercode.so
    │   └── libvideocodec.so
    ├── arm64-v8a/
    │   ├── libgameengine.so
    │   ├── libothercode.so
    │   └── libvideocodec.so
    ├── x86/
    │   ├── libgameengine.so
    │   ├── libothercode.so
    │   └── libvideocodec.so
    └── x86_64/
        ├── libgameengine.so
        ├── libothercode.so
        └── libvideocodec.so
    ```

    By default, the mapping file will be located at: *<project folder\>/<Module\>/build/outputs/mapping/<build-type\>/*, while `.so` files are located at: *<project folder\>/<Module\>/build/intermediates/cmake/debug/obj/* when compiled with CMake or at: *<project folder\>/<Module\>/build/intermediates/ndk/debug/obj/* (debug compilation) or *<project folder\>/<Module\>/build/intermediates/ndk/release/obj/* (release compilation).

    The conversion effect is as follows:

    === "Java/Kotlin"

        Original `error_stack` :

        ```
        java.lang.ArithmeticException: divide by zero
            at prof.wang.activity.TeamInvitationActivity.o0(Unknown Source:1)
            at prof.wang.activity.TeamInvitationActivity.k0(Unknown Source:0)
            at j9.f7.run(Unknown Source:0)
            at java.lang.Thread.run(Thread.java:1012)
        ```
        
        Converted `error_stack_source` :
    
        ```
        java.lang.ArithmeticException: divide by zero
        at prof.wang.activity.TeamInvitationActivity.onClick$lambda-0(TeamInvitationActivity.java:1)
        at java.lang.Thread.run(Thread.java:1012)
        ```

    === "C/C++ Native Code"

        Original `error_stack` :
    
        ```
        backtrace:
        #00 pc 00000000000057fc  /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_4+12)
        #01 pc 00000000000058a4  /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_3+8)
        #02 pc 00000000000058b4  /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_2+12)
        #03 pc 00000000000058c4  /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_1+12)
        #04 pc 0000000000005938  /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_crash+112)
        ...
        ```
        
        Converted `error_stack_source` :
    
        ```
        backtrace:
        
        Abort message: 'abort message for ftNative internal testing'
        #00 0x00000000000057fc /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_4+12)
        xc_test_call_4
        /Users/Brandon/Documents/workplace/working/StudioPlace/xCrash/xcrash_lib/src/main/cpp/xcrash/xc_test.c:65:9
        #01 0x00000000000058a4 /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_3+8)
        xc_test_call_3
        /Users/Brandon/Documents/workplace/working/StudioPlace/xCrash/xcrash_lib/src/main/cpp/xcrash/xc_test.c:73:13
        #02 0x00000000000058b4 /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_2+12)
        xc_test_call_2
        /Users/Brandon/Documents/workplace/working/StudioPlace/xCrash/xcrash_lib/src/main/cpp/xcrash/xc_test.c:79:13
        #03 0x00000000000058c4 /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_1+12)
        xc_test_call_1
        /Users/Brandon/Documents/workplace/working/StudioPlace/xCrash/xcrash_lib/src/main/cpp/xcrash/xc_test.c:85:13
        #04 0x0000000000005938 /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_crash+112)
        xc_test_crash
        /Users/Brandon/Documents/workplace/working/StudioPlace/xCrash/xcrash_lib/src/main/cpp/xcrash/xc_test.c:126:9
        ...
        ```

=== "iOS"

    On the iOS platform, the `sourcemap` file is a symbol table file with a `.dSYM` extension that contains debugging information. Normally, after the project is compiled, it is in the same directory as the `.app` file, as shown below:

    ``` shell
    $ ls -l Build/Products/Debug-iphonesimulator/
    total 0
    drwxr-xr-x   6 zy  staff  192  8  9 15:27 Fishing.app
    drwxr-xr-x   3 zy  staff   96  8  9 14:02 Fishing.app.dSYM
    drwxr-xr-x  15 zy  staff  480  8  9 15:27 Fishing.doccarchive
    drwxr-xr-x   6 zy  staff  192  8  9 13:55 Fishing.swiftmodule
    ```

    Note that XCode Release compilation generates `.dSYM` files by default, but Debug compilation does not generate them unless configured accordingly:

    ```not-set
    Build Settings -> Code Generation -> Generate Debug Symbols -> Yes
    Build Settings -> Build Option -> Debug Information Format -> DWARF with dSYM File
    ```

    When zipping the package, include the corresponding `.dSYM` files into the zip package. If your project involves multiple `.dSYM` files, they should all be included in the zip package, then copy the zip package to *<DataKit installation directory\>/data/rum/ios*. The directory structure after unzipping the zip package looks similar to the following (`.dSYM` files are essentially directories, similar to macOS executable programs *.app*):

    ```
    <app_id>-<env>-<version>/
    ├── AFNetworking.framework.dSYM
    │   └── Contents
    │       ├── Info.plist
    │       └── Resources
    │           └── DWARF
    │               └── AFNetworking
    └── App.app.dSYM
        └── Contents
            ├── Info.plist
            └── Resources
                └── DWARF
                    └── App
    
    ```

=== "React Native"

    React Native's `sourcemap` includes native iOS, Android, and JS parts, resulting in three types of source maps.
    
    The `sourcemap` acquisition for native iOS and Android follows the methods described in their respective packaging instructions.

    The acquisition of the JS part of the sourcemap is as follows:
    
    **For Android**, source mapping is enabled by default. The source map file is located at `android/app/build/generated/sourcemaps/react/release/index.android.bundle.map`
   
    **For iOS**, enabling source map generation requires additional configuration. Open Xcode and edit the build phase "Bundle React Native code and images". Add an entry for `SOURCEMAP_FILE` with the required output path above other export items.
    
    ```shell
    set -e
    # output source maps
    export SOURCEMAP_FILE="./main.jsbundle.map";
    ```
    
    **With Hermes, React Native <0.71**
    
    ```shell
    set -e
    # output source maps
    export SOURCEMAP_FILE="./main.jsbundle.map";
    # React Native 0.70, if Hermes is used, you need to set USE_HERMES to true, otherwise the source maps won't be generated.
    export USE_HERMES=true 
    
    # keep the rest of the script unchanged
    
    # When React Native (0.69,0.71) and using Hermes
    # add these lines to compose the packager and compiler source maps into one file
    REACT_NATIVE_DIR=../node_modules/react-native
    
    if [ -f "$REACT_NATIVE_DIR/scripts/find-node-for-xcode.sh" ]; then
        source "$REACT_NATIVE_DIR/scripts/find-node-for-xcode.sh"
    else
        # Before RN 0.70, the script was named find-node.sh
        source "$REACT_NATIVE_DIR/scripts/find-node.sh"
    fi
    source "$REACT_NATIVE_DIR/scripts/node-binary.sh"
    "$NODE_BINARY" "$REACT_NATIVE_DIR/scripts/compose-source-maps.js" "$CONFIGURATION_BUILD_DIR/main.jsbundle.map" "$CONFIGURATION_BUILD_DIR/$UNLOCALIZED_RESOURCES_FOLDER_PATH/main.jsbundle.map" -o "../$SOURCEMAP_FILE"
    ```
    
    After obtaining the JS sourcemap file, zip it together with the corresponding native sourcemap according to the format below.
    
    
    ```
    // Android
    <app_id>-<env>-<version>/
    ├── js/
        ├── main.jsbundle.map 
    └── android/
        ├── mapping.txt
        ├── armeabi-v7a/
        │   ├── libgameengine.so
        │   ├── libothercode.so
        │   └── libvideocodec.so
        └── arm64-v8a/
            ├── libgameengine.so
            ├── libothercode.so
            └── libvideocodec.so	
    ```
    
    ```
    // iOS
    <app_id>-<env>-<version>/
    ├── js/
        ├── main.jsbundle.map 
    └── ios/
        ├── AFNetworking.framework.dSYM
        │   └── Contents
        │       ├── Info.plist
        │       └── Resources
        │           └── DWARF
        │               └── AFNetworking
        └── App.app.dSYM
            └── Contents
                ├── Info.plist
                └── Resources
                    └── DWARF
                        └── App
    ```

<!-- markdownlint-enable -->

---

You can use tools such as [**source-map-visualization**](https://evanw.github.io/source-map-visualization/) to verify the availability of the files.


## File Upload and Deletion {#upload}

After completing the configuration and packaging, users can go to the front-end page **[Synthetic Tests]** > **[Application List]** > **[Click on the More Icon in the Top Right Corner of the Application]** > **[SourceMap]** to perform file upload and deletion operations. Please ensure that the current account has "Edit" or higher permissions.


<img src="../../img/sourcemap_06.png" width="80%" >
<img src="../../img/sourcemap_01.png" width="60%" >

Below the 🔍 bar, you can view the names of uploaded files and application types. You may search by entering the file name; clicking :fontawesome-regular-trash-can: deletes the current file.

**Upload Notes**:

1. File size must not exceed 500M;
2. File format must be `.zip`;
3. Ensure that the file paths after unzipping the package match the URL paths in the `error_stack`;
4. Do not upload multiple files simultaneously;
5. Uploading files with the same name will result in an overwrite prompt, so please take note.

Additionally, Datakit collector configurations support SourceMap transformation.

> For more details, see [SourceMap Transformation](../../integrations/rum.md#sourcemap).