# Sourcemap Upload
---

When the application is released in the production environment, in order to prevent code leakage and other security issues, the file will be converted and compressed in the packaging process. The above measures not only ensure the code security, but also cause the collected error stack information to be confused, which makes it impossible to directly locate the problem, and brings inconvenience to the subsequent Bug troubleshooting.

Guance provides sourcemap function for Web applications, supports restoring confused code, facilitates locating source code during error troubleshooting, and helps users solve problems faster.

**Note**: Currently only JS error restores generated by Web applications are supported.

## Steps Overview

To start Sourcemap, you need to upload the map file corresponding to the application to the Guance, and Guance will automatically complete the mapping restoration according to the obtained map file. By accessing Guance and RUM, you can find error stack information (where real code errors occur) in time, quickly locate the corresponding code and troubleshoot. The specific operation steps are as follows:：

1. Configure the Javascript bundler: To map the transformed, compressed js code
2. Sourcemap packaging and compression: Get zip format file
3. Upload: Upload the zip file to datakit
4. View in Guance: You can view the error positioning after resolution

## Major Steps

### Step 1: Configure the Javascript bundler

To use webpackJS as an example, use the built-in plug-in `SourceMapDevToolPlugin` to generate the source map, and see how to configure it in the `webpack.config.js` file below:

```javascript
// ...
const webpack = require('webpack');
module.exports = {
  mode: 'production',
  devtool: false,
  plugins: [
    new webpack.SourceMapDevToolPlugin({
      noSources: false,
      filename: '[file].map'
    }),
    // ...
  ],
  optimization: {
    minimize: true,
    // ...
  },
  // ...
};

```

Note: If you are using TypeScript, set `compilerOptions.sourceMap` to `true` when configuring `tsconfig.json`.

### **Step 2: Compress Packaging**


Zip the folder with the path corresponding to sourcemap into a zip named `< app_id >-< env >-< version >. zip` and ensure that the unzipped file path matches the URL path in `error_stack`.

```shell
zip -q -r <app_id>--.zip sourcemap file directory
```

Assume the following error_stack：

```shell
ReferenceError
at a.hideDetail @ http://localhost:8080/static/js/app.7fb548e3d065d1f48f74.js:1:1037
at a.showDetail @ http://localhost:8080/static/js/app.7fb548e3d065d1f48f74.js:1:986
at <anonymous> @ http://localhost:8080/static/js/app.7fb548e3d065d1f48f74.js:1:1174
```

The path to be converted is `/static/js/app.7fb548e3d065d1f48f74.js`, and its corresponding sourcemap path is `/static/js/app.7fb548e3d065d1f48f74.js.map`, so the directory structure of the corresponding compressed package after decompression is as follows:

```shell
static/js/app.7fb548e3d065d1f48f74.js.map
```

Converted error_stack_source:

```shell
at a.hideDetail @ webpack:///src/components/header/header.vue:94:0
at a.showDetail @ webpack:///src/components/header/header.vue:91:0
at <anonymous> @ webpack:///src/components/header/header.vue:101:0
```

Variable description:

- `<app_id>`: applicationId corresponding to RUM
- `<dea_address>`: The address of the DCA service, such as http://localhost:9531
- `<sourcemap_path>`: sourcemap zip file path to upload
- `<env>`: The env corresponding to the RUM
- `<version>`: The version corresponding to the RUM

### **Step 3: Upload and Delete**

You can manually upload to the Datakit-related directory, `<Datakit Installation Directory >/data/rum/web`, so that the reported error data can be automatically converted and the error_stack_source field appended to the metric set. You can also upload and delete the file using the http interface, provided the DCA service is turned on.
Upload:

```shell
curl -X POST '<dca_address>/v1/rum/sourcemap?app_id=<app_id>&env=<env>&version=<version>' -F "file=@<sourcemap_path>" -H "Content-Type: multipart/form-data"
```

Delete:

```shell
curl -X DELETE '<dca_address>/v1/rum/sourcemap?app_id=<app_id>&env=<env>&version=<version>'
```

### **Step 4: View in Guance**

By visiting Guance and RUM, clicking **View Error Details** on the **Page Performance Data** (view) and **Session Data** (session) details pages, you can find the error stack information (where the real code went wrong) in time and quickly locate the corresponding code.

![](img/image.png)

## Notes:

- This conversion process is for error data only.
- Currently only js sourcemap transformations are supported.
- The name of the sourcemap file needs to be the same as the original file. If the corresponding sourcemap file is not found, no conversion will be made.
- The sourcemap compressed package uploaded through the interface can take effect without restarting DataKit, but if it is uploaded manually, it needs to restart DataKit before it can take effect.

## Sourcemap Upload of iOS & Android

- [iOS sourcemap Upload](../datakit/rum.md#sourcemap)
- [Android sourcemap Upload](../datakit/rum.md#sourcemap)

