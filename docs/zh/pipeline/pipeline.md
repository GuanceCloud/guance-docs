
# Pipeline æ•°æ®å¤„ç†å™¨è¯­è¨€å®šä¹‰

---

ä»¥ä¸‹æ˜¯ Pipeline æ•°æ®å¤„ç†å™¨è¯­è¨€å®šä¹‰ã€‚éšç€ä¸åŒè¯­æ³•çš„é€æ­¥æ”¯æŒï¼Œè¯¥æ–‡æ¡£ä¼šåšä¸åŒç¨‹åº¦çš„è°ƒæ•´å’Œå¢åˆ ã€‚

## åŸºæœ¬è§„åˆ™ {#basic-syntax}

### æ ‡è¯†ç¬¦ä¸å…³é”®å­— {#identifier-and-keyword}

#### æ ‡è¯†ç¬¦ {#identifier}

æ ‡è¯†ç¬¦ç”¨äºæ ‡è¯†å¯¹è±¡ï¼Œå¯ä»¥ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªå˜é‡ã€å‡½æ•°ç­‰ï¼Œæ ‡è¯†ç¬¦åŒ…å«å…³é”®å­—

è‡ªå®šä¹‰çš„æ ‡è¯†ç¬¦ä¸èƒ½ä¸ Pipeline æ•°æ®å¤„ç†å™¨è¯­è¨€çš„å…³é”®å­—é‡å¤

æ ‡è¯†ç¬¦å¯ä»¥ç”±æ•°å­—ï¼ˆ`0-9`ï¼‰ã€å­—æ¯ï¼ˆ`A-Z a-z`ï¼‰ã€ä¸‹åˆ’çº¿ï¼ˆ`_`ï¼‰æ„æˆï¼Œä½†é¦–å­—ç¬¦ä¸èƒ½æ˜¯æ•°å­—ä¸”åŒºåˆ†å¤§å°å†™ï¼š

- `_abc`
- `abc`
- `abc1`
- `abc_1_`

å¦‚æœéœ€è¦ä»¥å­—æ¯å¼€å¤´æˆ–åœ¨æ ‡è¯†ç¬¦ä¸­ä½¿ç”¨ä¸Šè¿°å­—ç¬¦å¤–éœ€è¦ä½¿ç”¨åå¼•å·ï¼š

- `` `1abc` ``
- `` `@some-variable` ``
- `` `this-is-a-emoji-ğŸ‘` ``

#### ç‰¹æ®Šæ ‡è¯†ç¬¦ {#special-identifier}

ä¸ºä¿æŒ Pipeline è¯­ä¹‰çš„å‰å‘å…¼å®¹ï¼Œ`_` ä¸º `message` çš„åˆ«åã€‚

#### å…³é”®å­— {#keyword}

å…³é”®å­—æ˜¯å…·æœ‰ç‰¹æ®Šæ„ä¹‰çš„å•è¯ï¼Œå¦‚ `if`, `elif`, `else`, `for`, `in`, `break`, `continue` ç­‰

### æ³¨é‡Š {#code-comments}

ä»¥ `#` ä¸ºè¡Œæ³¨é‡Šå­—ç¬¦ï¼Œä¸æ”¯æŒè¡Œå†…æ³¨é‡Š

```python
# è¿™æ˜¯ä¸€è¡Œæ³¨é‡Š
a = 1 # è¿™æ˜¯ä¸€è¡Œæ³¨é‡Š

"""
è¿™æ˜¯ä¸€ä¸ªï¼ˆå¤šè¡Œï¼‰å­—ç¬¦ä¸²ï¼Œæ›¿ä»£æ³¨é‡Š
"""
a = 2

"å­—ç¬¦ä¸²"
a = 3
```

### æ•°æ®ç±»å‹ {#data-type}

åœ¨ DataKit Pipeline çš„æ•°æ®å¤„ç†è¯­è¨€ä¸­ï¼Œå˜é‡çš„å€¼çš„ç±»å‹å¯ä»¥åŠ¨æ€å˜åŒ–ï¼Œä½†æ¯ä¸€ä¸ªå€¼éƒ½æœ‰å…¶æ•°æ®ç±»å‹ï¼Œå…¶å¯ä»¥æ˜¯**åŸºæœ¬ç±»å‹**çš„å…¶ä¸­ä¸€ç§ï¼Œä¹Ÿå¯ä»¥æ˜¯**å¤åˆç±»å‹**

#### åŸºæœ¬ç±»å‹ {#basic-type}

##### æ•´å‹ {#int}

æ•´å‹çš„ç±»å‹é•¿åº¦ä¸º 64bitï¼Œæœ‰ç¬¦å·ï¼Œå½“å‰ä»…æ”¯æŒä»¥åè¿›åˆ¶çš„æ–¹å¼ç¼–å†™æ•´æ•°å­—é¢é‡ï¼Œå¦‚ `-1`, `0`, `1`, `+19`

##### æµ®ç‚¹ç±»å‹ {#float}

æµ®ç‚¹å‹çš„ç±»å‹é•¿åº¦ä¸º 64-bitï¼Œæœ‰ç¬¦å·ï¼Œå½“å‰ä»…æ”¯æŒä»¥åè¿›åˆ¶çš„æ–¹å¼ç¼–å†™æµ®ç‚¹æ•°å­—é¢é‡ï¼Œå¦‚ `-1.00001`, `0.0`, `1.0`, `+19.0`

##### å¸ƒå°”ç±»å‹ {#bool}

å¸ƒå°”ç±»å‹å€¼ä»…æœ‰ `true` å’Œ `false` ä¸¤ç§

##### å­—ç¬¦ä¸²ç±»å‹ {#str}

å­—ç¬¦ä¸²å€¼å¯ç”¨åŒå¼•å·æˆ–å•å¼•å·ï¼Œå¤šè¡Œå­—ç¬¦ä¸²å¯ä»¥ä½¿ç”¨ä¸‰åŒå¼•å·æˆ–ä¸‰å•å¼•å·å°†å†…å®¹æ‹¬èµ·æ¥è¿›è¡Œç¼–å†™

- åŒå¼•å·å­—ç¬¦ä¸² `"hello world"`
- å•å¼•å·å­—ç¬¦ä¸² `'hello world'`
- å¤šè¡Œå­—ç¬¦ä¸²

```python
"""hello
world"""
```

- å•å¼•å·å½¢å¼çš„å¤šè¡Œå­—ç¬¦ä¸²

```python
'''
hello
world
'''
```

##### nil ç±»å‹ {#nil}

nil ä¸ºä¸€ç§ç‰¹æ®Šçš„æ•°æ®ç±»å‹ï¼Œè¡¨ç¤ºç©ºï¼Œå½“ä¸€ä¸ªå˜é‡æœªèµ‹å€¼å°±ä½¿ç”¨æ—¶ï¼Œå…¶å€¼ä¸º nil

#### å¤åˆç±»å‹ {#composite-type}

å­—å…¸ç±»å‹ä¸åˆ—è¡¨ç±»å‹ä¸åŸºæœ¬ç±»å‹ä¸åŒï¼Œå¤šä¸ªå˜é‡å¯ä»¥æŒ‡å‘åŒä¸€ä¸ª map æˆ– list å¯¹è±¡ï¼Œåœ¨èµ‹å€¼æ—¶å¹¶ä¸ä¼šè¿›è¡Œåˆ—è¡¨æˆ–å­—å…¸çš„å†…å­˜æ‹·è´ï¼Œè€Œæ˜¯è¿›è¡Œå¼•ç”¨

- å­—å…¸ç±»å‹

å­—å…¸ç±»å‹ä¸º key-value ç»“æ„ï¼Œåªæœ‰å­—ç¬¦ä¸²ç±»å‹æ‰èƒ½ä½œä¸º keyï¼Œä¸é™åˆ¶ value çš„æ•°æ®ç±»å‹ï¼Œå…¶å¯é€šè¿‡ç´¢å¼•è¡¨è¾¾å¼è¯»å†™ map ä¸­çš„å…ƒç´ ï¼š

```python
a = {
  "1": [1, "2", 3, nil],
  "2": 1.1,
  "abc": nil,
  "def": true
}

# ç”±äº a["1"] æ˜¯åˆ—è¡¨ï¼Œæ­¤æ—¶ b åªæ˜¯å¼•ç”¨äº† a["1"] çš„å€¼
b = a["1"]


# æ­¤æ—¶ a çš„è¿™ä¸€å€¼ä¹Ÿå˜ä¸º 1.1
b[0] = 1.1
```

- åˆ—è¡¨ç±»å‹

åˆ—è¡¨ç±»å‹å¯ä»¥åœ¨åˆ—è¡¨ä¸­å­˜å‚¨ä»»æ„æ•°é‡ã€ä»»æ„ç±»å‹çš„å€¼
å…¶å¯é€šè¿‡ç´¢å¼•è¡¨è¾¾å¼è¯»å†™ list ä¸­çš„å…ƒç´ 

```python
a = [1, "2", 3.0, false, nil, {"a": 1}]

a = a[0] # a == 1
```

## å¿«é€Ÿå¼€å§‹ {#quick-start}

- åœ¨ DataKit ä¸­é…ç½® Pipelineï¼Œç¼–å†™å¦‚ä¸‹ Pipeline æ–‡ä»¶ï¼Œå‡å®šåä¸º *nginx.p*ã€‚å°†å…¶å­˜æ”¾åœ¨ *[Datakit å®‰è£…ç›®å½•]/pipeline* ç›®å½•ä¸‹ã€‚

```python
# å‡å®šè¾“å…¥æ˜¯ä¸€ä¸ª Nginx æ—¥å¿—
# æ³¨æ„ï¼Œè„šæœ¬æ˜¯å¯ä»¥åŠ æ³¨é‡Šçš„

grok(_, "some-grok-patterns")  # å¯¹è¾“å…¥çš„æ–‡æœ¬ï¼Œè¿›è¡Œ grok æå–
rename('client_ip', ip)        # å°† ip å­—æ®µæ”¹åæˆ client_ip
rename("ç½‘ç»œåè®®", protocol)   # å°† protocol å­—æ®µæ”¹åæˆ "ç½‘ç»œåè®®"

# å°†æ—¶é—´æˆ³(å¦‚ 1610967131)æ¢æˆ RFC3339 æ—¥æœŸæ ¼å¼ï¼š2006-01-02T15:04:05Z07:00
datetime(access_time, "s", "RFC3339")

url_decode(request_url)      # å°† HTTP è¯·æ±‚è·¯ç”±ç¿»è¯‘æˆæ˜æ–‡

# å½“ status_code ä»‹äº 200 ~ 300 ä¹‹é—´ï¼Œæ–°å»ºä¸€ä¸ª http_status = "HTTP_OK" çš„å­—æ®µ
group_between(status_code, [200, 300], "HTTP_OK", "http_status")

# ä¸¢å¼ƒåŸå†…å®¹
drop_origin_data()
```

<!-- markdownlint-disable MD046 -->
???+ warning "æ³¨æ„"

    åˆ‡å‰²è¿‡ç¨‹ä¸­ï¼Œéœ€é¿å…[å¯èƒ½å‡ºç°çš„è·Ÿ tag key é‡åçš„é—®é¢˜](./use-pipeline/pipeline-quick-start.md#naming)ã€‚
<!-- markdownlint-enable -->

- é…ç½®å¯¹åº”çš„é‡‡é›†å™¨æ¥ä½¿ç”¨ä¸Šé¢çš„ Pipeline

ä»¥ logging é‡‡é›†å™¨ä¸ºä¾‹ï¼Œé…ç½®å­—æ®µ `pipeline_path` å³å¯ï¼Œæ³¨æ„ï¼Œè¿™é‡Œé…ç½®çš„æ˜¯ pipeline çš„è„šæœ¬åç§°ï¼Œè€Œä¸æ˜¯è·¯å¾„ã€‚æ‰€æœ‰è¿™é‡Œå¼•ç”¨çš„ pipeline è„šæœ¬ï¼Œå¿…é¡»å­˜æ”¾åœ¨ `<DataKit å®‰è£…ç›®å½•/pipeline>` ç›®å½•ä¸‹ï¼š

```python
[[inputs.logging]]
    logfiles = ["/path/to/nginx/log"]

    # required
    source = "nginx"

    # æ‰€æœ‰è„šæœ¬å¿…é¡»æ”¾åœ¨ /path/to/datakit/pipeline ç›®å½•ä¸‹
    # å¦‚æœå¼€å¯äº† gitrepos åŠŸèƒ½ï¼Œåˆ™ä¼˜å…ˆä»¥ gitrepos ä¸­çš„åŒåæ–‡ä»¶ä¸ºå‡†
    # å¦‚æœ pipeline æœªé…ç½®ï¼Œåˆ™åœ¨ pipeline ç›®å½•ä¸‹å¯»æ‰¾è·Ÿ source åŒå
    # çš„è„šæœ¬ï¼ˆå¦‚ nginx -> nginx.pï¼‰ï¼Œä½œä¸ºå…¶é»˜è®¤ pipeline é…ç½®
    pipeline = "nginx.p"

    ... # å…¶å®ƒé…ç½®
```

é‡å¯é‡‡é›†å™¨ï¼Œå³å¯åˆ‡å‰²å¯¹åº”çš„æ—¥å¿—ã€‚

<!-- markdownlint-disable MD046 -->
???+ abstract

    å…³äº Pipeline ç¼–å†™ã€è°ƒè¯•ä»¥åŠæ³¨æ„äº‹é¡¹ï¼Œå‚è§[å¦‚ä½•ç¼–å†™ Pipeline è„šæœ¬](./use-pipeline/pipeline-quick-start.md)ã€‚
<!-- markdownlint-enable -->

## Grok æ¨¡å¼åˆ†ç±» {#grok}

DataKit ä¸­ grok æ¨¡å¼å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š

- å…¨å±€æ¨¡å¼ï¼š*pattern* ç›®å½•ä¸‹çš„æ¨¡å¼æ–‡ä»¶éƒ½æ˜¯å…¨å±€æ¨¡å¼ï¼Œæ‰€æœ‰ Pipeline è„šæœ¬éƒ½å¯ä½¿ç”¨ï¼›
- å±€éƒ¨æ¨¡å¼ï¼šåœ¨ Pipeline è„šæœ¬ä¸­é€šè¿‡ [add_pattern()](pipeline.md#fn-add-pattern) å‡½æ•°æ–°å¢çš„æ¨¡å¼ä¸ºå±€éƒ¨æ¨¡å¼ï¼Œåªé’ˆå¯¹å½“å‰ Pipeline è„šæœ¬æœ‰æ•ˆã€‚

ä»¥ä¸‹ä»¥ Nginx access-log ä¸ºä¾‹ï¼Œè¯´æ˜ä¸€ä¸‹å¦‚ä½•ç¼–å†™å¯¹åº”çš„ grokï¼ŒåŸå§‹ nginx access log å¦‚ä¸‹ï¼š

```log
127.0.0.1 - - [26/May/2022:20:53:52 +0800] "GET /server_status HTTP/1.1" 404 134 "-" "Go-http-client/1.1"
```

å‡è®¾æˆ‘ä»¬éœ€è¦ä»è¯¥è®¿é—®æ—¥å¿—ä¸­è·å– client_ipã€time (request)ã€http_methodã€http_urlã€http_versionã€status_code è¿™äº›å†…å®¹ï¼Œé‚£ä¹ˆ grok pattern åˆæ­¥å¯ä»¥å†™æˆï¼š

```python
grok(_,"%{NOTSPACE:client_ip} %{NOTSPACE} %{NOTSPACE} \\[%{HTTPDATE:time}\\] \"%{DATA:http_method} %{GREEDYDATA:http_url} HTTP/%{NUMBER:http_version}\" %{INT:status_code} %{INT} \"%{NOTSPACE}\" \"%{NOTSPACE}\"")

cast(status_code, "int")
group_between(status_code, [200,299], "OK", status)
group_between(status_code, [300,399], "notice", status)
group_between(status_code, [400,499], "warning", status)
group_between(status_code, [500,599], "error", status)
default_time(time)
```

å†ä¼˜åŒ–ä¸€ä¸‹ï¼Œåˆ†åˆ«å°†å¯¹åº”çš„ç‰¹å¾æå–ä¸€ä¸‹ï¼š

```python
# æ—¥å¿—é¦–éƒ¨çš„ client_ipã€http_identã€http_auth ä½œä¸ºä¸€ä¸ª pattern
add_pattern("p1", "%{NOTSPACE:client_ip} %{NOTSPACE} %{NOTSPACE}")

# ä¸­é—´çš„ http_methodã€http_urlã€http_versionã€status_code ä½œä¸ºä¸€ä¸ª patternï¼Œ
# å¹¶åœ¨ pattern å†…æŒ‡å®š status_code çš„æ•°æ®ç±»å‹ int æ¥æ›¿ä»£ä½¿ç”¨çš„ cast å‡½æ•°
add_pattern("p3", '"%{DATA:http_method} %{GREEDYDATA:http_url} HTTP/%{NUMBER:http_version}" %{INT:status_code:int}')

grok(_, "%{p1} \\[%{HTTPDATE:time}\\] %{p3} %{INT} \"%{NOTSPACE}\" \"%{NOTSPACE}\"")

group_between(status_code, [200,299], "OK", status)
group_between(status_code, [300,399], "notice", status)
group_between(status_code, [400,499], "warning", status)
group_between(status_code, [500,599], "error", status)

default_time(time)
```

ä¼˜åŒ–ä¹‹åçš„åˆ‡å‰²ï¼Œç›¸è¾ƒäºåˆæ­¥çš„å•è¡Œ pattern æ¥è¯´å¯è¯»æ€§æ›´å¥½ã€‚ç”±äº grok è§£æå‡ºçš„å­—æ®µé»˜è®¤æ•°æ®ç±»å‹æ˜¯ stringï¼Œåœ¨æ­¤å¤„æŒ‡å®šå­—æ®µçš„æ•°æ®ç±»å‹åï¼Œå¯ä»¥é¿å…åç»­å†ä½¿ç”¨ [cast()](pipeline.md#fn-cast) å‡½æ•°æ¥è¿›è¡Œç±»å‹è½¬æ¢ã€‚

### grok ç»„åˆ {#grok-compose}

grok æœ¬è´¨æ˜¯é¢„å®šä¹‰ä¸€äº›æ­£åˆ™è¡¨è¾¾å¼æ¥è¿›è¡Œæ–‡æœ¬åŒ¹é…æå–ï¼Œå¹¶ä¸”ç»™é¢„å®šä¹‰çš„æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œå‘½åï¼Œæ–¹ä¾¿ä½¿ç”¨ä¸åµŒå¥—å¼•ç”¨æ‰©å±•å‡ºæ— æ•°ä¸ªæ–°æ¨¡å¼ã€‚æ¯”å¦‚ DataKit æœ‰ 3 ä¸ªå¦‚ä¸‹å†…ç½®æ¨¡å¼ï¼š

```python
_second (?:(?:[0-5]?[0-9]|60)(?:[:.,][0-9]+)?)    # åŒ¹é…ç§’æ•°ï¼Œ_second ä¸ºæ¨¡å¼å
_minute (?:[0-5][0-9])                            # åŒ¹é…åˆ†é’Ÿæ•°ï¼Œ_minute ä¸ºæ¨¡å¼å
_hour (?:2[0123]|[01]?[0-9])                      # åŒ¹é…å¹´ä»½ï¼Œ_hour ä¸ºæ¨¡å¼å
```

åŸºäºä¸Šé¢ä¸‰ä¸ªå†…ç½®æ¨¡å¼ï¼Œå¯ä»¥æ‰©å±•å‡ºè‡ªå·±å†…ç½®æ¨¡å¼ä¸”å‘½åä¸º `time`ï¼š

```python
# æŠŠ time åŠ åˆ° pattern ç›®å½•ä¸‹æ–‡ä»¶ä¸­ï¼Œæ­¤æ¨¡å¼ä¸ºå…¨å±€æ¨¡å¼ï¼Œä»»ä½•åœ°æ–¹éƒ½èƒ½å¼•ç”¨ time
time ([^0-9]?)%{hour:hour}:%{minute:minute}(?::%{second:second})([^0-9]?)

# ä¹Ÿå¯ä»¥é€šè¿‡ add_pattern() æ·»åŠ åˆ° pipeline æ–‡ä»¶ä¸­ï¼Œåˆ™æ­¤æ¨¡å¼å˜ä¸ºå±€éƒ¨æ¨¡å¼ï¼Œåªæœ‰å½“å‰ pipeline è„šæœ¬èƒ½ä½¿ç”¨ time
add_pattern(time, "([^0-9]?)%{HOUR:hour}:%{MINUTE:minute}(?::%{SECOND:second})([^0-9]?)")

# é€šè¿‡ grok æå–åŸå§‹è¾“å…¥ä¸­çš„æ—¶é—´å­—æ®µã€‚å‡å®šè¾“å…¥ä¸º 12:30:59ï¼Œåˆ™æå–åˆ° {"hour": 12, "minute": 30, "second": 59}
grok(_, %{time})
```

<!-- markdownlint-disable MD046 -->
???+ warning "æ³¨æ„"

    - å¦‚æœå‡ºç°åŒåæ¨¡å¼ï¼Œåˆ™ä»¥å±€éƒ¨æ¨¡å¼ä¼˜å…ˆï¼ˆå³å±€éƒ¨æ¨¡å¼è¦†ç›–å…¨å±€æ¨¡å¼ï¼‰ï¼›
    - Pipeline è„šæœ¬ä¸­ï¼Œ[add_pattern()](pipeline.md#fn-add-pattern) éœ€åœ¨ [grok()](pipeline.md#fn-grok) å‡½æ•°å‰é¢è°ƒç”¨ï¼Œå¦åˆ™ä¼šå¯¼è‡´ç¬¬ä¸€æ¡æ•°æ®æå–å¤±è´¥ã€‚
<!-- markdownlint-enable -->

### å†…ç½®çš„ Pattern åˆ—è¡¨ {#builtin-patterns}

DataKit å†…ç½®äº†ä¸€äº›å¸¸ç”¨çš„ Patternï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ Grok åˆ‡å‰²çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

<!-- markdownlint-disable MD046 -->
???- "å†…ç½® Patterns"

    ``` not-set
    USERNAME             : [a-zA-Z0-9._-]+
    USER                 : %{USERNAME}
    EMAILLOCALPART       : [a-zA-Z][a-zA-Z0-9_.+-=:]+
    EMAILADDRESS         : %{EMAILLOCALPART}@%{HOSTNAME}
    HTTPDUSER            : %{EMAILADDRESS}|%{USER}
    INT                  : (?:[+-]?(?:[0-9]+))
    BASE10NUM            : (?:[+-]?(?:[0-9]+(?:\.[0-9]+)?)|\.[0-9]+)
    NUMBER               : (?:%{BASE10NUM})
    BASE16NUM            : (?:0[xX]?[0-9a-fA-F]+)
    POSINT               : \b(?:[1-9][0-9]*)\b
    NONNEGINT            : \b(?:[0-9]+)\b
    WORD                 : \b\w+\b
    NOTSPACE             : \S+
    SPACE                : \s*
    DATA                 : .*?
    GREEDYDATA           : .*
    GREEDYLINES          : (?s).*
    QUOTEDSTRING         : "(?:[^"\\]*(?:\\.[^"\\]*)*)"|\'(?:[^\'\\]*(?:\\.[^\'\\]*)*)\'
    UUID                 : [A-Fa-f0-9]{8}-(?:[A-Fa-f0-9]{4}-){3}[A-Fa-f0-9]{12}
    MAC                  : (?:%{CISCOMAC}|%{WINDOWSMAC}|%{COMMONMAC})
    CISCOMAC             : (?:(?:[A-Fa-f0-9]{4}\.){2}[A-Fa-f0-9]{4})
    WINDOWSMAC           : (?:(?:[A-Fa-f0-9]{2}-){5}[A-Fa-f0-9]{2})
    COMMONMAC            : (?:(?:[A-Fa-f0-9]{2}:){5}[A-Fa-f0-9]{2})
    IPV6                 : (?:(?:(?:[0-9A-Fa-f]{1,4}:){7}(?:[0-9A-Fa-f]{1,4}|:))|(?:(?:[0-9A-Fa-f]{1,4}:){6}(?::[0-9A-Fa-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(?:(?:[0-9A-Fa-f]{1,4}:){5}(?:(?:(?::[0-9A-Fa-f]{1,4}){1,2})|:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(?:(?:[0-9A-Fa-f]{1,4}:){4}(?:(?:(?::[0-9A-Fa-f]{1,4}){1,3})|(?:(?::[0-9A-Fa-f]{1,4})?:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?:(?:[0-9A-Fa-f]{1,4}:){3}(?:(?:(?::[0-9A-Fa-f]{1,4}){1,4})|(?:(?::[0-9A-Fa-f]{1,4}){0,2}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?:(?:[0-9A-Fa-f]{1,4}:){2}(?:(?:(?::[0-9A-Fa-f]{1,4}){1,5})|(?:(?::[0-9A-Fa-f]{1,4}){0,3}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?:(?:[0-9A-Fa-f]{1,4}:){1}(?:(?:(?::[0-9A-Fa-f]{1,4}){1,6})|(?:(?::[0-9A-Fa-f]{1,4}){0,4}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(?::(?:(?:(?::[0-9A-Fa-f]{1,4}){1,7})|(?:(?::[0-9A-Fa-f]{1,4}){0,5}:(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(?:%.+)?
    IPV4                 : (?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)
    IP                   : (?:%{IPV6}|%{IPV4})
    HOSTNAME             : \b(?:[0-9A-Za-z][0-9A-Za-z-]{0,62})(?:\.(?:[0-9A-Za-z][0-9A-Za-z-]{0,62}))*(?:\.?|\b)
    HOST                 : %{HOSTNAME}
    IPORHOST             : (?:%{IP}|%{HOSTNAME})
    HOSTPORT             : %{IPORHOST}:%{POSINT}
    PATH                 : (?:%{UNIXPATH}|%{WINPATH})
    UNIXPATH             : (?:/[\w_%!$@:.,-]?/?)(?:\S+)?
    TTY                  : (?:/dev/(?:pts|tty(?:[pq])?)(?:\w+)?/?(?:[0-9]+))
    WINPATH              : (?:[A-Za-z]:|\\)(?:\\[^\\?*]*)+
    URIPROTO             : [A-Za-z]+(?:\+[A-Za-z+]+)?
    URIHOST              : %{IPORHOST}(?::%{POSINT:port})?
    URIPATH              : (?:/[A-Za-z0-9$.+!*'(){},~:;=@#%_\-]*)+
    URIPARAM             : \?[A-Za-z0-9$.+!*'|(){},~@#%&/=:;_?\-\[\]<>]*
    URIPATHPARAM         : %{URIPATH}(?:%{URIPARAM})?
    URI                  : %{URIPROTO}://(?:%{USER}(?::[^@]*)?@)?(?:%{URIHOST})?(?:%{URIPATHPARAM})?
    MONTH                : \b(?:Jan(?:uary|uar)?|Feb(?:ruary|ruar)?|M(?:a|Ã¤)?r(?:ch|z)?|Apr(?:il)?|Ma(?:y|i)?|Jun(?:e|i)?|Jul(?:y)?|Aug(?:ust)?|Sep(?:tember)?|O(?:c|k)?t(?:ober)?|Nov(?:ember)?|De(?:c|z)(?:ember)?)\b
    MONTHNUM             : (?:0?[1-9]|1[0-2])
    MONTHNUM2            : (?:0[1-9]|1[0-2])
    MONTHDAY             : (?:(?:0[1-9])|(?:[12][0-9])|(?:3[01])|[1-9])
    DAY                  : (?:Mon(?:day)?|Tue(?:sday)?|Wed(?:nesday)?|Thu(?:rsday)?|Fri(?:day)?|Sat(?:urday)?|Sun(?:day)?)
    YEAR                 : (\d\d){1,2}
    HOUR                 : (?:2[0123]|[01]?[0-9])
    MINUTE               : (?:[0-5][0-9])
    SECOND               : (?:(?:[0-5]?[0-9]|60)(?:[:.,][0-9]+)?)
    TIME                 : (?:[^0-9]?)%{HOUR}:%{MINUTE}(?::%{SECOND})(?:[^0-9]?)
    DATE_US              : %{MONTHNUM}[/-]%{MONTHDAY}[/-]%{YEAR}
    DATE_EU              : %{MONTHDAY}[./-]%{MONTHNUM}[./-]%{YEAR}
    ISO8601_TIMEZONE     : (?:Z|[+-]%{HOUR}(?::?%{MINUTE}))
    ISO8601_SECOND       : (?:%{SECOND}|60)
    TIMESTAMP_ISO8601    : %{YEAR}-%{MONTHNUM}-%{MONTHDAY}[T ]%{HOUR}:?%{MINUTE}(?::?%{SECOND})?%{ISO8601_TIMEZONE}?
    DATE                 : %{DATE_US}|%{DATE_EU}
    DATESTAMP            : %{DATE}[- ]%{TIME}
    TZ                   : (?:[PMCE][SD]T|UTC)
    DATESTAMP_RFC822     : %{DAY} %{MONTH} %{MONTHDAY} %{YEAR} %{TIME} %{TZ}
    DATESTAMP_RFC2822    : %{DAY}, %{MONTHDAY} %{MONTH} %{YEAR} %{TIME} %{ISO8601_TIMEZONE}
    DATESTAMP_OTHER      : %{DAY} %{MONTH} %{MONTHDAY} %{TIME} %{TZ} %{YEAR}
    DATESTAMP_EVENTLOG   : %{YEAR}%{MONTHNUM2}%{MONTHDAY}%{HOUR}%{MINUTE}%{SECOND}
    HTTPDERROR_DATE      : %{DAY} %{MONTH} %{MONTHDAY} %{TIME} %{YEAR}
    SYSLOGTIMESTAMP      : %{MONTH} +%{MONTHDAY} %{TIME}
    PROG                 : [\x21-\x5a\x5c\x5e-\x7e]+
    SYSLOGPROG           : %{PROG:program}(?:\[%{POSINT:pid}\])?
    SYSLOGHOST           : %{IPORHOST}
    SYSLOGFACILITY       : <%{NONNEGINT:facility}.%{NONNEGINT:priority}>
    HTTPDATE             : %{MONTHDAY}/%{MONTH}/%{YEAR}:%{TIME} %{INT}
    QS                   : %{QUOTEDSTRING}
    SYSLOGBASE           : %{SYSLOGTIMESTAMP:timestamp} (?:%{SYSLOGFACILITY} )?%{SYSLOGHOST:logsource} %{SYSLOGPROG}:
    COMMONAPACHELOG      : %{IPORHOST:clientip} %{HTTPDUSER:ident} %{USER:auth} \[%{HTTPDATE:timestamp}\] "(?:%{WORD:verb} %{NOTSPACE:request}(?: HTTP/%{NUMBER:httpversion})?|%{DATA:rawrequest})" %{NUMBER:response} (?:%{NUMBER:bytes}|-)
    COMBINEDAPACHELOG    : %{COMMONAPACHELOG} %{QS:referrer} %{QS:agent}
    HTTPD20_ERRORLOG     : \[%{HTTPDERROR_DATE:timestamp}\] \[%{LOGLEVEL:loglevel}\] (?:\[client %{IPORHOST:clientip}\] ){0,1}%{GREEDYDATA:errormsg}
    HTTPD24_ERRORLOG     : \[%{HTTPDERROR_DATE:timestamp}\] \[%{WORD:module}:%{LOGLEVEL:loglevel}\] \[pid %{POSINT:pid}:tid %{NUMBER:tid}\]( \(%{POSINT:proxy_errorcode}\)%{DATA:proxy_errormessage}:)?( \[client %{IPORHOST:client}:%{POSINT:clientport}\])? %{DATA:errorcode}: %{GREEDYDATA:message}
    HTTPD_ERRORLOG       : %{HTTPD20_ERRORLOG}|%{HTTPD24_ERRORLOG}
    LOGLEVEL             : (?:[Aa]lert|ALERT|[Tt]race|TRACE|[Dd]ebug|DEBUG|[Nn]otice|NOTICE|[Ii]nfo|INFO|[Ww]arn?(?:ing)?|WARN?(?:ING)?|[Ee]rr?(?:or)?|ERR?(?:OR)?|[Cc]rit?(?:ical)?|CRIT?(?:ICAL)?|[Ff]atal|FATAL|[Ss]evere|SEVERE|EMERG(?:ENCY)?|[Ee]merg(?:ency)?)
    COMMONENVOYACCESSLOG : \[%{TIMESTAMP_ISO8601:timestamp}\] \"%{DATA:method} (?:%{URIPATH:uri_path}(?:%{URIPARAM:uri_param})?|%{DATA:}) %{DATA:protocol}\" %{NUMBER:status_code} %{DATA:response_flags} %{NUMBER:bytes_received} %{NUMBER:bytes_sent} %{NUMBER:duration} (?:%{NUMBER:upstream_service_time}|%{DATA:tcp_service_time}) \"%{DATA:forwarded_for}\" \"%{DATA:user_agent}\" \"%{DATA:request_id}\" \"%{DATA:authority}\" \"%{DATA:upstream_service}\"
    ```
<!-- markdownlint-enable -->

## if/else åˆ†æ”¯ {#if-else}

Pipeline æ”¯æŒ `if/elif/else` è¯­æ³•ï¼Œ`if` åé¢çš„è¯­å¥ä»…æ”¯æŒæ¡ä»¶è¡¨è¾¾å¼ï¼Œå³ `<`ã€`<=`ã€`==`ã€`>`ã€`>=` å’Œ `!=`ï¼Œ ä¸”æ”¯æŒå°æ‹¬å·ä¼˜å…ˆçº§å’Œå¤šä¸ªæ¡ä»¶è¡¨è¾¾å¼çš„ `AND` å’Œ `OR` è¿æ¥ã€‚

è¡¨è¾¾å¼ä¸¤è¾¹å¯ä»¥æ˜¯å·²å­˜åœ¨çš„ key æˆ–å›ºå®šå€¼ï¼ˆæ•°å€¼ã€å¸ƒå°”å€¼ã€å­—ç¬¦ä¸²å’Œ nil ï¼‰ï¼Œä¾‹å¦‚ï¼š

```python
# æ•°å€¼æ¯”è¾ƒ
add_key(score, 95)

if score == 100  {
  add_key(level, "S")
} elif score >= 90 && score < 100 {
  add_key(level, "A")
} elif score >= 60 {
  add_key(level, "C")
} else {
  add_key(level, "D")
}

# å­—ç¬¦ä¸²æ¯”è¾ƒ
add_key(name, "å¼ ä¸‰")

if name == "æ³•å¤–ç‹‚å¾’" {
  # è¿™æ˜¯ä¸å¯èƒ½çš„ï¼Œä¸è¦æ±¡è”‘æˆ‘
}
```

å’Œå¤§å¤šæ•°ç¼–ç¨‹/è„šæœ¬è¯­è¨€ç›¸åŒï¼Œæ ¹æ® `if/elif` çš„æ¡ä»¶æ˜¯å¦æˆç«‹ï¼Œæ¥å†³å®šå…¶æ‰§è¡Œé¡ºåºã€‚

æ³¨æ„ï¼šå¦‚æœæ˜¯è¿›è¡Œæ•°å€¼æ¯”è¾ƒï¼Œéœ€è¦å…ˆç”¨ `cast()` è¿›è¡Œç±»å‹è½¬æ¢ï¼Œæ¯”å¦‚ï¼š

``` python
# status_code æ˜¯ grok åˆ‡å‡ºæ¥çš„ string ç±»å‹
cast(status_code, "int")

if status == 200 {
  add_key(level, "OK")
} elif status >= 400 && status < 500 {
  add_key(level, "ERROR")
} elif stauts > 500 {
  add_key(level, "FATAL")
}
```

## for å¾ªç¯ {#for-loop}
å…è®¸é€šè¿‡ for éå† mapã€list å’Œå­—ç¬¦ä¸²ï¼Œå¹¶å¯é€šè¿‡ `continue` å’Œ `break` è¿›è¡Œå¾ªç¯æ§åˆ¶

```python
# ç¤ºä¾‹ 1
b = "2"
for a in ["1", "a" ,"2"] {
  b = b + a
}
add_key(b)
# å¤„ç†ç»“æœ
{
  "b": "21a2"
}


# ç¤ºä¾‹ 2
d = 0
map_a = {"a": 1, "b":2}
for x in map_a {
  d = d + map_a[x]
}
add_key(d)
# å¤„ç†ç»“æœ
{
  "d": 3
}
```

## Pipeline è„šæœ¬å­˜æ”¾ç›®å½• {#pl-dirs}

Pipeline çš„ç›®å½•æœç´¢ä¼˜å…ˆçº§æ˜¯ï¼š

1. Remote Pipeline ç›®å½•
2. Git ç®¡ç†çš„ *pipeline* ç›®å½•
3. å†…ç½®çš„ *pipeline* ç›®å½•

ç”± 1 å¾€ 3 æ–¹å‘æŸ¥æ‰¾ï¼ŒåŒ¹é…åˆ°äº†ç›´æ¥è¿”å›ã€‚

ä¸å…è®¸ç»å¯¹è·¯å¾„çš„å†™æ³•ã€‚

### Remote Pipeline ç›®å½• {#remote-pl}

åœ¨ Datakit çš„å®‰è£…ç›®å½•ä¸‹é¢çš„ `pipeline_remote` ç›®å½•ä¸‹ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š

```shell
.
â”œâ”€â”€ conf.d
â”œâ”€â”€ datakit
â”œâ”€â”€ pipeline
â”‚Â Â  â”œâ”€â”€ root_apache.p
â”‚Â Â  â””â”€â”€ root_consul.p
â”œâ”€â”€ pipeline_remote
â”‚Â Â  â”œâ”€â”€ remote_elasticsearch.p
â”‚Â Â  â””â”€â”€ remote_jenkins.p
â”œâ”€â”€ gitrepos
â”‚Â Â  â””â”€â”€ mygitproject
â”‚Â Â      â”œâ”€â”€ conf.d
â”‚Â Â      â”œâ”€â”€ pipeline
â”‚Â Â      â”‚Â Â  â””â”€â”€ git_kafka.p
â”‚Â Â      â”‚Â Â  â””â”€â”€ git_mongod.p
â”‚Â Â      â””â”€â”€ python.d
â””â”€â”€ ...
```

### Git ç®¡ç†çš„ Pipeline ç›®å½• {#git-pl}

åœ¨ *gitrepos* ç›®å½•ä¸‹çš„ *project-name/pipeline* ç›®å½•ä¸‹ï¼Œç›®å½•ç»“æ„å¦‚ä¸Šæ‰€ç¤ºã€‚

### å†…ç½®çš„ Pipeline ç›®å½• {#internal-pl}

åœ¨ Datakit çš„å®‰è£…ç›®å½•ä¸‹é¢çš„ *pipeline* ç›®å½•ä¸‹ï¼Œç›®å½•ç»“æ„å¦‚ä¸Šæ‰€ç¤ºã€‚

## è„šæœ¬è¾“å…¥æ•°æ®ç»“æ„ {#input-data}

æ‰€æœ‰ç±»åˆ«çš„æ•°æ®åœ¨è¢« Pipeline è„šæœ¬å¤„ç†å‰å‡ä¼šå°è£…æˆ Point ç»“æ„ï¼Œå…¶ç»“æ„å¤§è‡´ä¸ºï¼š

``` not-set
struct Point {
    Name:    str
    Tags:    map[str]str
    Fields:  map[str]any
    Time:    int64
}
```

ä»¥ä¸€æ¡ nginx æ—¥å¿—æ•°æ®ä¸ºä¾‹ï¼Œå…¶è¢«æ—¥å¿—é‡‡é›†å™¨é‡‡é›†åˆ°åç”Ÿæˆçš„æ•°æ®ä½œä¸º Pipeline è„šæœ¬çš„è¾“å…¥å¤§è‡´ä¸ºï¼š

``` not-set
Point {
    Name: "nginx"
    Tags: map[str]str {
        "host": "your_hostname"
    },
    Fields: map[str]any {
        "message": "127.0.0.1 - - [12/Jan/2023:11:51:38 +0800] \"GET / HTTP/1.1\" 200 612 \"-\" \"curl/7.81.0\""
    },
    Time: 1673495498000123456
}
```

æç¤ºï¼š

- å…¶ä¸­ `Name` å¯ä»¥é€šè¿‡å‡½æ•° `set_measurement()` ä¿®æ”¹ã€‚

- å¯¹äº `Tags` å’Œ `Fields`ï¼Œä»»æ„ä¸€ä¸ª key ä¸èƒ½åŒæ—¶å‡ºç°åœ¨è¿™ä¸¤ä¸ª map ä¸­ï¼›å¯ä»¥åœ¨ pipeline ä¸­é€šè¿‡è‡ªå®šä¹‰æ ‡è¯†ç¬¦æˆ–å‡½æ•° `get_key()` è¯»å–ï¼Œä¿®æ”¹ `Tags` æˆ– `Fields` ä¸­ key çš„å€¼éœ€è¦é€šè¿‡å…¶ä»–**å†…ç½®å‡½æ•°**è¿›è¡Œã€‚å…¶ä¸­ **`_`** å¯ä»¥è§†ä¸º `message` è¿™ä¸ª key çš„åˆ«åã€‚

- åœ¨è„šæœ¬è¿è¡Œç»“æŸåï¼Œå¦‚æœåœ¨ `Tags` æˆ– `Fields` ä¸­å­˜åœ¨åä¸º `time` çš„ keyï¼Œå°†è¢«åˆ é™¤ï¼›å½“å…¶å€¼ä¸º int64 ç±»å‹ï¼Œåˆ™å°†å…¶å€¼è¢«èµ‹äºˆ Point çš„ time ååˆ é™¤ã€‚å¦‚æœ time ä¸ºå­—ç¬¦ä¸²ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨å‡½æ•° `default_time()` å°†å…¶è½¬æ¢ä¸º int64ã€‚

## è„šæœ¬å‡½æ•° {#functions}

å‡½æ•°å‚æ•°è¯´æ˜ï¼š

- å‡½æ•°å‚æ•°ä¸­ï¼ŒåŒ¿åå‚æ•°ï¼ˆ`_`ï¼‰æŒ‡åŸå§‹çš„è¾“å…¥æ–‡æœ¬æ•°æ®
- JSON è·¯å¾„ï¼Œç›´æ¥è¡¨ç¤ºæˆ `x.y.z` è¿™ç§å½¢å¼ï¼Œæ— éœ€å…¶å®ƒä¿®é¥°ã€‚ä¾‹å¦‚ `{"a":{"first":2.3, "second":2, "third":"abc", "forth":true}, "age":47}`ï¼Œjson è·¯å¾„ä¸º `a.thrid` è¡¨ç¤ºå¾…æ“ä½œæ•°æ®ä¸º `abc`
- æ‰€æœ‰å‡½æ•°å‚æ•°çš„ç›¸å¯¹é¡ºåºï¼Œéƒ½æ˜¯å›ºå®šçš„ï¼Œå¼•æ“ä¼šå¯¹å…¶åšå…·ä½“æ£€æŸ¥
- ä»¥ä¸‹æåˆ°çš„æ‰€æœ‰ `key` å‚æ•°ï¼Œéƒ½æŒ‡å·²ç»è¿‡åˆæ¬¡æå–ï¼ˆé€šè¿‡ `grok()` æˆ– `json()`ï¼‰ä¹‹åï¼Œç”Ÿæˆçš„ `key`
- å¾…å¤„ç† JSON çš„è·¯å¾„ï¼Œæ”¯æŒæ ‡è¯†ç¬¦çš„å†™æ³•ï¼Œä¸èƒ½ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œå¦‚æœæ˜¯ç”Ÿæˆæ–° keyï¼Œéœ€è¦ä½¿ç”¨å­—ç¬¦ä¸²

### `add_key()` {#fn-add-key}

å‡½æ•°åŸå‹ï¼š`fn add_key(key, value)`

å‡½æ•°è¯´æ˜ï¼šå¾€ point ä¸­å¢åŠ ä¸€ä¸ªå­—æ®µ

å‡½æ•°å‚æ•°ï¼š

- `key`: æ–°å¢çš„ key åç§°
- `value`ï¼šä½œä¸º key çš„å€¼

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š{"age": 17, "name": "zhangsan", "height": 180}

# å¤„ç†è„šæœ¬
add_key(city, "shanghai")

# å¤„ç†ç»“æœ
{
    "age": 17,
    "height": 180,
    "name": "zhangsan",
    "city": "shanghai"
}
```


### `add_pattern()` {#fn-add-pattern}

å‡½æ•°åŸå‹ï¼š`fn add_pattern(name: str, pattern: str)`

å‡½æ•°è¯´æ˜ï¼šåˆ›å»ºè‡ªå®šä¹‰ grok æ¨¡å¼ã€‚grok æ¨¡å¼æœ‰ä½œç”¨åŸŸé™åˆ¶ï¼Œå¦‚åœ¨ if else è¯­å¥å†…å°†äº§ç”Ÿæ–°çš„ä½œç”¨åŸŸï¼Œè¯¥ pattern ä»…åœ¨æ­¤ä½œç”¨åŸŸå†…æœ‰æ•ˆã€‚è¯¥å‡½æ•°ä¸å¯è¦†ç›–åŒä¸€ä½œç”¨åŸŸæˆ–è€…ä¸Šä¸€ä½œç”¨åŸŸå·²ç»å­˜åœ¨çš„ grok æ¨¡å¼ã€‚

å‚æ•°ï¼š

- `name`ï¼šæ¨¡å¼å‘½å
- `pattern`: è‡ªå®šä¹‰æ¨¡å¼å†…å®¹

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š"11,abc,end1", "22,abc,end1", "33,abc,end3"

# pipline è„šæœ¬
add_pattern("aa", "\\d{2}")
grok(_, "%{aa:aa}")
if false {

} else {
    add_pattern("bb", "[a-z]{3}")
    if aa == "11" {
        add_pattern("cc", "end1")
        grok(_, "%{aa:aa},%{bb:bb},%{cc:cc}")
    } elif aa == "22" {
        # æ­¤å¤„ä½¿ç”¨ pattern cc å°†å¯¼è‡´ç¼–è¯‘å¤±è´¥ï¼šno pattern found for %{cc}
        grok(_, "%{aa:aa},%{bb:bb},%{INT:cc}")
    } elif aa == "33" {
        add_pattern("bb", "[\\d]{5}") # æ­¤å¤„è¦†ç›– bb å¤±è´¥
        add_pattern("cc", "end3")
        grok(_, "%{aa:aa},%{bb:bb},%{cc:cc}")
    }
}

# å¤„ç†ç»“æœ
{
    "aa":      "11"
    "bb":      "abc"
    "cc":      "end1"
    "message": "11,abc,end1"
}
{
    "aa":      "22"
    "message": "22,abc,end1"
}
{
    "aa":      "33"
    "bb":      "abc"
    "cc":      "end3"
    "message": "33,abc,end3"
}
```


### `adjust_timezone()` {#fn-adjust-timezone}

å‡½æ•°åŸå‹ï¼š`fn adjust_timezone(key: int, minute: int)`

å‡½æ•°å‚æ•°ï¼š

- `key`: çº³ç§’æ—¶é—´æˆ³ï¼Œå¦‚ `default_time(time)` å‡½æ•°å¤„ç†åå¾—åˆ°çš„æ—¶é—´æˆ³ï¼›
- `minute`: è¿”å›å€¼å…è®¸è¶…å‡ºå½“å‰æ—¶é—´çš„åˆ†é’Ÿæ•°ï¼ˆæ•´æ•°ï¼‰ï¼Œå–å€¼èŒƒå›´ [0, 15], é»˜è®¤å€¼ä¸º 2 åˆ†é’Ÿã€‚

å‡½æ•°è¯´æ˜ï¼šä½¿å¾—ä¼ å…¥çš„æ—¶é—´æˆ³å‡å»å‡½æ•°æ‰§è¡Œæ—¶åˆ»çš„æ—¶é—´æˆ³çš„å·®å€¼åœ¨ï¼ˆ-60+minute, minute] åˆ†é’Ÿå†…ï¼›ä¸é€‚ç”¨äºæ—¶é—´å·®è¶…å‡ºæ­¤èŒƒå›´çš„æ•°æ®ï¼Œå¦åˆ™å°†å¯¼è‡´è·å–åˆ°é”™è¯¯çš„æ•°æ®ã€‚è®¡ç®—æµç¨‹ï¼š

1. ä¸º key çš„å€¼åŠ ä¸Šæ•°å°æ—¶ä½¿å…¶å¤„äºå½“å‰å°æ—¶å†…ï¼›
2. æ­¤æ—¶è®¡ç®—ä¸¤è€…åˆ†é’Ÿå·®ï¼Œä¸¤è€…åˆ†é’Ÿæ•°å€¼èŒƒå›´ä¸º [0, 60)ï¼Œå·®å€¼èŒƒå›´åœ¨ (-60,0] å’Œ [0, 60)ï¼›
3. å·®å€¼å°äºç­‰äº -60 + minute çš„åŠ  1 å°æ—¶ï¼Œå¤§äº minute çš„å‡ 1 å°æ—¶ï¼›
4. minute é»˜è®¤å€¼ä¸º 2ï¼Œåˆ™å·®çš„èŒƒå›´å…è®¸åœ¨ (-58, 2]ï¼Œè‹¥æ­¤æ—¶ä¸º 11:10ï¼Œæ—¥å¿—æ—¶é—´ä¸º 3:12:00.001ï¼Œæœ€ç»ˆç»“æœä¸º 10:12:00.001ï¼›è‹¥æ­¤æ—¶ä¸º 11:59:1.000, æ—¥å¿—æ—¶é—´ä¸º 3:01:1.000ï¼Œæœ€ç»ˆç»“æœä¸º 12:01:1.000ã€‚

ç¤ºä¾‹ï¼š

```json
# è¾“å…¥ 1 
{
    "time":"11 Jul 2022 12:49:20.937", 
    "second":2,
    "third":"abc",
    "forth":true
}
```

è„šæœ¬ï¼š

```python
json(_, time)      # æå– time å­—æ®µ (è‹¥å®¹å™¨ä¸­æ—¶åŒº UTC+0000)
default_time(time) # å°†æå–åˆ°çš„ time å­—æ®µè½¬æ¢æˆæ—¶é—´æˆ³
                   # (å¯¹æ— æ—¶åŒºæ•°æ®ä½¿ç”¨æœ¬åœ°æ—¶åŒº UTC+0800/UTC+0900..ã€‚è§£æ)
adjust_timezone(time)
                   # è‡ªåŠ¨(é‡æ–°)é€‰æ‹©æ—¶åŒºï¼Œæ ¡å‡†æ—¶é—´åå·®
```

æ‰§è¡Œ `datakit pipeline -P <name>.p -F <input_file_name>  --date`:

```json
# è¾“å‡º 1
{
  "message": "{\n    \"time\":\"11 Jul 2022 12:49:20.937\",\n    \"second\":2,\n    \"third\":\"abc\",\n    \"forth\":true\n}",
  "status": "unknown",
  "time": "2022-07-11T20:49:20.937+08:00"
}
```

æœ¬æœºæ—¶é—´ï¼š`2022-07-11T20:55:10.521+08:00`

ä»…ä½¿ç”¨ `default_time` æŒ‰ç…§é»˜è®¤æœ¬æœºæ—¶åŒºï¼ˆUTC+8ï¼‰è§£æå¾—åˆ°çš„æ—¶é—´åˆ†åˆ«ä¸ºï¼š

- è¾“å…¥ 1 ç»“æœï¼š `2022-07-11T12:49:20.937+08:00`

ä½¿ç”¨ `adjust_timezone` åå°†å¾—åˆ°ï¼š

- è¾“å…¥ 1 ç»“æœï¼š `2022-07-11T20:49:20.937+08:00`


### `agg_create()` {#fn-agg-create}

[:octicons-tag-24: Version-1.5.10](../datakit/changelog.md#cl-1.5.10)

å‡½æ•°åŸå‹ï¼š`fn agg_create(bucket: str, on_interval: str = "60s", on_count: int = 0, keep_value: bool = false, const_tags: map[string]string = nil)`

å‡½æ•°è¯´æ˜ï¼šåˆ›å»ºä¸€ä¸ªç”¨äºèšåˆçš„æŒ‡æ ‡é›†ï¼Œé€šè¿‡ `on_interval` æˆ– `on_count` è®¾ç½®æ—¶é—´æˆ–æ¬¡æ•°ä½œä¸ºèšåˆå‘¨æœŸï¼Œèšåˆç»“æŸåå°†ä¸Šä¼ èšåˆæ•°æ®ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦ä¿ç•™ä¸Šä¸€æ¬¡èšåˆçš„æ•°æ®ã€‚

å‡½æ•°å‚æ•°ï¼š

- `bucket`: å­—ç¬¦ä¸²ç±»å‹ï¼Œä½œä¸ºèšåˆå‡ºçš„æŒ‡æ ‡çš„æŒ‡æ ‡é›†åï¼Œå¦‚æœè¯¥ bucket å·²ç»åˆ›å»ºï¼Œåˆ™å‡½æ•°ä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼›
- `on_interval`ï¼šé»˜è®¤å€¼ `60s`, ä»¥æ—¶é—´ä½œä¸ºèšåˆå‘¨æœŸï¼Œå•ä½ `s`ï¼Œå€¼å¤§äº `0` æ—¶å‚æ•°ç”Ÿæ•ˆï¼›ä¸èƒ½åŒæ—¶ä¸ `on_count` å°äºç­‰äº 0ï¼›
- `on_count`: é»˜è®¤å€¼ `0`ï¼Œä»¥å¤„ç†çš„ç‚¹æ•°ä½œä¸ºèšåˆå‘¨æœŸï¼Œå€¼å¤§äº `0` æ—¶å‚æ•°ç”Ÿæ•ˆï¼›
- `keep_value`: é»˜è®¤å€¼ `false`ï¼›
- `const_tags`: è‡ªå®šä¹‰çš„ tagsï¼Œé»˜è®¤ä¸ºç©ºã€‚

ç¤ºä¾‹ï¼š

```python
agg_create("cpu_agg_info", on_interval = "30s")
```


### `agg_metric()` {#fn-agg-metric}

[:octicons-tag-24: Version-1.5.10](../datakit/changelog.md#cl-1.5.10)

å‡½æ•°åŸå‹ï¼š`fn agg_metric(bucket: str, new_field: str, agg_fn: str, agg_by: []string, agg_field: str)`

å‡½æ•°è¯´æ˜ï¼šæ ¹æ®è¾“å…¥çš„æ•°æ®ä¸­çš„å­—æ®µçš„åï¼Œè‡ªåŠ¨å–å€¼åä½œä¸ºèšåˆæ•°æ®çš„ tagï¼Œå¹¶å°†è¿™äº›èšåˆæ•°æ®å­˜å‚¨åœ¨å¯¹åº”çš„ bucket ä¸­

å‡½æ•°å‚æ•°ï¼š

- `bucket`: å­—ç¬¦ä¸²ç±»å‹ï¼Œå‡½æ•° `agg_create` åˆ›å»ºå‡ºçš„å¯¹åº”æŒ‡æ ‡é›†åˆçš„ bucketï¼Œå¦‚æœè¯¥ bucket æœªè¢«åˆ›å»ºï¼Œåˆ™å‡½æ•°ä¸æ‰§è¡Œä»»ä½•æ“ä½œï¼›
- `new_field`ï¼š èšåˆå‡ºçš„æ•°æ®ä¸­çš„æŒ‡æ ‡åï¼Œå…¶å€¼çš„æ•°æ®ç±»å‹ä¸º `float`ï¼›
- `agg_fn`: èšåˆå‡½æ•°ï¼Œå¯ä»¥æ˜¯ `"avg"`,`"sum"`,`"min"`,`"max"`,`"set"` ä¸­çš„ä¸€ç§ï¼›
- `agg_by`: è¾“å…¥çš„æ•°æ®ä¸­çš„å­—æ®µçš„åï¼Œå°†ä½œä¸ºèšåˆå‡ºçš„æ•°æ®çš„ tagï¼Œè¿™äº›å­—æ®µçš„å€¼åªèƒ½æ˜¯å­—ç¬¦ä¸²ç±»å‹çš„æ•°æ®
- `agg_field`: è¾“å…¥çš„æ•°æ®ä¸­çš„å­—æ®µåï¼Œè‡ªåŠ¨è·å–å­—æ®µå€¼è¿›è¡Œèšåˆã€‚

ç¤ºä¾‹ï¼š

ä»¥æ—¥å¿—ç±»åˆ«æ•°æ®ä¸ºä¾‹ï¼š

å¤šä¸ªè¾“å…¥æ—¥å¿—ï¼š

``` not-set
1
```

``` not-set
2
```

``` not-set
3
```

è„šæœ¬ï¼š

```python
agg_create("cpu_agg_info", interval=10, const_tags={"tag1":"value_user_define_tag"})

set_tag("tag1", "value1")

field1 = _

cast(field1, "int")

agg_metric("cpu_agg_info", "agg_field_1", "sum", ["tag1", "host"], "field1")
```

æŒ‡æ ‡è¾“å‡ºï¼š

``` not-set
{
    "host": "your_hostname",
    "tag1": "value1",
    "agg_field_1": 6,
}
```


### `append()` {#fn-append}

å‡½æ•°åŸå‹ï¼š`fn append(arr, elem) arr`

å‡½æ•°è¯´æ˜ï¼šå¾€æ•°ç»„ arr æœ«å°¾æ·»åŠ å…ƒç´  elemã€‚

å‚æ•°ï¼š

- `arr`: è¦æ·»åŠ å…ƒç´ çš„æ•°ç»„ã€‚
- `elem`: æ·»åŠ çš„å…ƒç´ ã€‚

ç¤ºä¾‹ï¼š

```python
# ä¾‹ 1
abc = ["1", "2"]
abc = append(abc, 5.1)
# abc = ["1", "2", 5.1]

# ä¾‹ 2
a = [1, 2]
b = [3, 4]
c = append(a, b)
# c = [1, 2, [3, 4]]
```


### `b64dec()` {#fn-b64dec}

å‡½æ•°åŸå‹ï¼š`fn b64dec(key: str)`

å‡½æ•°è¯´æ˜ï¼šå¯¹æŒ‡å®šå­—æ®µä¸Šè·å–çš„å­—ç¬¦ä¸²æ•°æ®è¿›è¡Œ base64 è§£ç ã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: å¾…æå–å­—æ®µ

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ® {"str": "aGVsbG8sIHdvcmxk"}
json(_, `str`)
b64enc(`str`)

# å¤„ç†ç»“æœ
# {
#   "str": "hello, world"
# }
```


### `b64enc()` {#fn-b64enc}

å‡½æ•°åŸå‹ï¼š`fn b64enc(key: str)`

å‡½æ•°è¯´æ˜ï¼šå¯¹æŒ‡å®šå­—æ®µä¸Šè·å–çš„å­—ç¬¦ä¸²æ•°æ®è¿›è¡Œ base64 ç¼–ç ã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: å¾…æå–å­—æ®µ

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ® {"str": "hello, world"}
json(_, `str`)
b64enc(`str`)

# å¤„ç†ç»“æœ
# {
#   "str": "aGVsbG8sIHdvcmxk"
# }
```


### `cast()` {#fn-cast}

å‡½æ•°åŸå‹ï¼š`fn cast(key, dst_type: str)`

å‡½æ•°è¯´æ˜ï¼šå°† key å€¼è½¬æ¢æˆæŒ‡å®šç±»å‹ã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: å·²æå–çš„æŸå­—æ®µï¼›
- `type`ï¼šè½¬æ¢çš„ç›®æ ‡ç±»å‹ï¼Œæ”¯æŒ `\"str\", \"float\", \"int\", \"bool\"` è¿™å‡ ç§ï¼Œç›®æ ‡ç±»å‹éœ€è¦ç”¨è‹±æ–‡çŠ¶æ€åŒå¼•å·æ‹¬èµ·æ¥ã€‚

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š{"first": 1,"second":2,"third":"aBC","forth":true}

# å¤„ç†è„šæœ¬
json(_, first) 
cast(first, "str")

# å¤„ç†ç»“æœ
{
  "first": "1"
}
```


### `cidr()` {#fn-cidr}

å‡½æ•°åŸå‹ï¼š`fn cidr(ip: str, prefix: str) bool`

å‡½æ•°è¯´æ˜ï¼š åˆ¤æ–­ IP æ˜¯å¦åœ¨æŸä¸ª CIDR å—ã€‚

å‡½æ•°å‚æ•°ï¼š

- `ip`: IP åœ°å€
- `prefix`ï¼š IP å‰ç¼€ï¼Œå¦‚ `192.0.2.1/24`

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š

# å¤„ç†è„šæœ¬

ip = "192.0.2.233"
if cidr(ip, "192.0.2.1/24") {
    add_key(ip_prefix, "192.0.2.1/24")
}

# å¤„ç†ç»“æœ
{
  "ip_prefix": "192.0.2.1/24"
}
```


### `cover()` {#fn-cover}

å‡½æ•°åŸå‹ï¼š`fn cover(key: str, range: list)`

å‡½æ•°è¯´æ˜ï¼šå¯¹æŒ‡å®šå­—æ®µä¸Šè·å–çš„å­—ç¬¦ä¸²æ•°æ®ï¼ŒæŒ‰èŒƒå›´è¿›è¡Œæ•°æ®è„±æ•å¤„ç†ã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`ï¼šå¾…æå–å­—æ®µï¼›
- `range`ï¼šè„±æ•å­—ç¬¦ä¸²çš„ç´¢å¼•èŒƒå›´ï¼ˆ`[start,end]`ï¼‰ start å’Œ end å‡æ”¯æŒè´Ÿæ•°ä¸‹æ ‡ï¼Œç”¨æ¥è¡¨è¾¾ä»å°¾éƒ¨å¾€å‰è¿½æº¯çš„è¯­ä¹‰ã€‚åŒºé—´åˆç†å³å¯ï¼Œend å¦‚æœå¤§äºå­—ç¬¦ä¸²æœ€å¤§é•¿åº¦ä¼šé»˜è®¤æˆæœ€å¤§é•¿åº¦ã€‚

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ® {"str": "13789123014"}
json(_, `str`)
cover(`str`, [8, 9])

# å¾…å¤„ç†æ•°æ® {"abc": "13789123014"}
json(_, abc)
cover(abc, [2, 4])
```


### `datetime()` {#fn-datetime}

[:octicons-tag-24: Version-1.5.7](../datakit/changelog.md#cl-1.5.7)

å‡½æ•°åŸå‹ï¼š`fn datetime(key, precision: str, fmt: str, tz: str = "")`

å‡½æ•°è¯´æ˜ï¼šå°†æ—¶é—´æˆ³è½¬æˆæŒ‡å®šæ—¥æœŸæ ¼å¼ã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: å·²ç»æå–çš„æ—¶é—´æˆ³ï¼›
- `precision`ï¼šè¾“å…¥çš„æ—¶é—´æˆ³ç²¾åº¦(s, ms, us, ns)ï¼›
- `fmt`ï¼šæ—¥æœŸæ ¼å¼ï¼Œæä¾›å†…ç½®æ—¥æœŸæ ¼å¼ä¸”æ”¯æŒè‡ªå®šä¹‰æ—¥æœŸæ ¼å¼ï¼›
- `tz`: æ—¶åŒº (å¯é€‰å‚æ•°)ï¼Œå°†æ—¶é—´æˆ³è½¬æ¢ä¸ºæŒ‡å®šæ—¶åŒºçš„æ—¶é—´ï¼Œé»˜è®¤ä½¿ç”¨ä¸»æœºçš„æ—¶åŒºã€‚

å†…ç½®æ—¥æœŸæ ¼å¼ï¼š

| å†…ç½®æ ¼å¼      | æ—¥æœŸ                                  | æè¿°                      |
| ---           | ---                                   | ---                       |
| "ANSI-C"      | "Mon Jan _2 15:04:05 2006"            |                           |
| "UnixDate"    | "Mon Jan _2 15:04:05 MST 2006"        |                           |
| "RubyDate"    | "Mon Jan 02 15:04:05 -0700 2006"      |                           |
| "RFC822"      | "02 Jan 06 15:04 MST"                 |                           |
| "RFC822Z"     | "02 Jan 06 15:04 -0700"               | RFC822 with numeric zone  |
| "RFC850"      | "Monday, 02-Jan-06 15:04:05 MST"      |                           |
| "RFC1123"     | "Mon, 02 Jan 2006 15:04:05 MST"       |                           |
| "RFC1123Z"    | "Mon, 02 Jan 2006 15:04:05 -0700"     | RFC1123 with numeric zone |
| "RFC3339"     | "2006-01-02T15:04:05Z07:00"           |                           |
| "RFC3339Nano" | "2006-01-02T15:04:05.999999999Z07:00" |                           |
| "Kitchen"     | "3:04PM"                              |                           |

è‡ªå®šä¹‰æ—¥æœŸæ ¼å¼ï¼š

å¯é€šè¿‡å ä½ç¬¦çš„ç»„åˆè‡ªå®šä¹‰è¾“å‡ºæ—¥æœŸæ ¼å¼

| å­—ç¬¦  | ç¤ºä¾‹ | æè¿°                                                          |
| ---   | ---  | ---                                                           |
| a     | %a   | æ˜ŸæœŸçš„ç¼©å†™ï¼Œå¦‚ `Wed`                                          |
| A     | %A   | æ˜ŸæœŸçš„å…¨å†™ï¼Œå¦‚ `Wednesday`                                    |
| b     | %b   | æœˆä»½ç¼©å†™ï¼Œå¦‚ `Mar`                                            |
| B     | %B   | æœˆä»½çš„å…¨å†™ï¼Œå¦‚ `March`                                        |
| C     | %c   | ä¸–çºªæ•°ï¼Œå½“å‰å¹´ä»½é™¤ 100                                        |
| **d** | %d   | ä¸€ä¸ªæœˆå†…çš„ç¬¬å‡ å¤©ï¼›èŒƒå›´ `[01, 31]`                             |
| e     | %e   | ä¸€ä¸ªæœˆå†…çš„ç¬¬å‡ å¤©ï¼›èŒƒå›´ `[1, 31]`ï¼Œä½¿ç”¨ç©ºæ ¼å¡«å……                |
| **H** | %H   | å°æ—¶ï¼Œä½¿ç”¨ 24 å°æ—¶åˆ¶ï¼› èŒƒå›´ `[00, 23]`                        |
| I     | %I   | å°æ—¶ï¼Œä½¿ç”¨ 12 å°æ—¶åˆ¶ï¼› èŒƒå›´ `[01, 12]`                        |
| j     | %j   | ä¸€å¹´å†…çš„ç¬¬å‡ å¤©ï¼ŒèŒƒå›´ `[001, 365]`                             |
| k     | %k   | å°æ—¶ï¼Œä½¿ç”¨ 24 å°æ—¶åˆ¶ï¼› èŒƒå›´ `[0, 23]`                         |
| l     | %l   | å°æ—¶ï¼Œä½¿ç”¨ 12 å°æ—¶åˆ¶ï¼› èŒƒå›´ `[1, 12]`ï¼Œä½¿ç”¨ç©ºæ ¼å¡«å……           |
| **m** | %m   | æœˆä»½ï¼ŒèŒƒå›´ `[01, 12]`                                         |
| **M** | %M   | åˆ†é’Ÿï¼ŒèŒƒå›´ `[00, 59]`                                         |
| n     | %n   | è¡¨ç¤ºæ¢è¡Œç¬¦ `\n`                                               |
| p     | %p   | `AM` æˆ– `PM`                                                  |
| P     | %P   | `am` æˆ– `pm`                                                  |
| s     | %s   | è‡ª 1970-01-01 00:00:00 UTC æ¥çš„çš„ç§’æ•°                         |
| **S** | %S   | ç§’æ•°ï¼ŒèŒƒå›´ `[00, 60]`                                         |
| t     | %t   | è¡¨ç¤ºåˆ¶è¡¨ç¬¦ `\t`                                               |
| u     | %u   | æ˜ŸæœŸå‡ ï¼Œæ˜ŸæœŸä¸€ä¸º 1ï¼ŒèŒƒå›´ `[1, 7]`                             |
| w     | %w   | æ˜ŸæœŸå‡ ï¼Œæ˜ŸæœŸå¤©ä¸º 0, èŒƒå›´ `[0, 6]`                             |
| y     | %y   | å¹´ä»½ï¼ŒèŒƒå›´ `[00, 99]`                                         |
| **Y** | %Y   | å¹´ä»½çš„åè¿›åˆ¶è¡¨ç¤º                                              |
| **z** | %z   | RFC 822/ISO 8601:1988 é£æ ¼çš„æ—¶åŒº (å¦‚ï¼š `-0600` æˆ– `+0100` ç­‰) |
| Z     | %Z   | æ—¶åŒºç¼©å†™ï¼Œå¦‚ `CST`                                            |
| %     | %%   | è¡¨ç¤ºå­—ç¬¦ `%`                                                  |

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š
#    {
#        "a":{
#            "timestamp": "1610960605000",
#            "second":2
#        },
#        "age":47
#    }

# å¤„ç†è„šæœ¬
json(_, a.timestamp)
datetime(a.timestamp, 'ms', 'RFC3339')
```

```python
# å¤„ç†è„šæœ¬
ts = timestamp()
datetime(ts, 'ns', fmt='%Y-%m-%d %H:%M:%S', tz="UTC")

# è¾“å‡º
{
  "ts": "2023-03-08 06:43:39"
}
```

```python
# å¤„ç†è„šæœ¬
ts = timestamp()
datetime(ts, 'ns', '%m/%d/%y  %H:%M:%S %z', "Asia/Tokyo")

# è¾“å‡º
{
  "ts": "03/08/23  15:44:59 +0900"
}
```


### `decode()` {#fn-decode}

å‡½æ•°åŸå‹ï¼š`fn decode(text: str, text_encode: str)`

å‡½æ•°è¯´æ˜ï¼šæŠŠ text å˜æˆ UTF8 ç¼–ç ï¼Œä»¥å¤„ç†åŸå§‹æ—¥å¿—ä¸ºé UTF8 ç¼–ç çš„é—®é¢˜ã€‚ç›®å‰æ”¯æŒçš„ç¼–ç ä¸º utf-16le/utf-16be/gbk/gb18030ï¼ˆè¿™äº›ç¼–ç ååªèƒ½å°å†™ï¼‰ã€‚

```python
decode("wwwwww", "gbk")

# Extracted data(drop: false, cost: 33.279Âµs):
# {
#   "message": "wwwwww",
# }
```


### `default_time()` {#fn-defalt-time}

å‡½æ•°åŸå‹ï¼š`fn default_time(key: str, timezone: str = "")`

å‡½æ•°è¯´æ˜ï¼šä»¥æå–çš„æŸä¸ªå­—æ®µä½œä¸ºæœ€ç»ˆæ•°æ®çš„æ—¶é—´æˆ³ã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: æŒ‡å®šçš„ keyï¼Œ key çš„æ•°æ®ç±»å‹éœ€è¦ä¸ºå­—ç¬¦ä¸²ç±»å‹ï¼›
- `timezone`: æŒ‡å®šå¾…æ ¼å¼åŒ–çš„æ—¶é—´æ–‡æœ¬æ‰€ä½¿ç”¨çš„æ—¶åŒºï¼Œå¯é€‰å‚æ•°ï¼Œé»˜è®¤ä¸ºå½“å‰ç³»ç»Ÿæ—¶åŒºï¼Œæ—¶åŒºç¤ºä¾‹ `+8/-8/+8:30`ã€‚

å¾…å¤„ç†æ•°æ®æ”¯æŒä»¥ä¸‹æ ¼å¼åŒ–æ—¶é—´ï¼š

<!-- markdownlint-disable MD038 -->
| æ—¥æœŸæ ¼å¼                                           | æ—¥æœŸæ ¼å¼                                                | æ—¥æœŸæ ¼å¼                                       | æ—¥æœŸæ ¼å¼                          |
| -----                                              | ----                                                    | ----                                           | ----                              |
| `2014-04-26 17:24:37.3186369`                      | `May 8, 2009 5:57:51 PM`                                | `2012-08-03 18:31:59.257000000`                | `oct 7, 1970`                     |
| `2014-04-26 17:24:37.123`                          | `oct 7, '70`                                            | `2013-04-01 22:43`                             | `oct. 7, 1970`                    |
| `2013-04-01 22:43:22`                              | `oct. 7, 70`                                            | `2014-12-16 06:20:00 UTC`                      | `Mon Jan  2 15:04:05 2006`        |
| `2014-12-16 06:20:00 GMT`                          | `Mon Jan  2 15:04:05 MST 2006`                          | `2014-04-26 05:24:37 PM`                       | `Mon Jan 02 15:04:05 -0700 2006`  |
| `2014-04-26 13:13:43 +0800`                        | `Monday, 02-Jan-06 15:04:05 MST`                        | `2014-04-26 13:13:43 +0800 +08`                | `Mon, 02 Jan 2006 15:04:05 MST`   |
| `2014-04-26 13:13:44 +09:00`                       | `Tue, 11 Jul 2017 16:28:13 +0200 (CEST)`                | `2012-08-03 18:31:59.257000000 +0000 UTC`      | `Mon, 02 Jan 2006 15:04:05 -0700` |
| `2015-09-30 18:48:56.35272715 +0000 UTC`           | `Thu, 4 Jan 2018 17:53:36 +0000`                        | `2015-02-18 00:12:00 +0000 GMT`                | `Mon 30 Sep 2018 09:09:09 PM UTC` |
| `2015-02-18 00:12:00 +0000 UTC`                    | `Mon Aug 10 15:44:11 UTC+0100 2015`                     | `2015-02-08 03:02:00 +0300 MSK m=+0.000000001` | `Thu, 4 Jan 2018 17:53:36 +0000`  |
| `2015-02-08 03:02:00.001 +0300 MSK m=+0.000000001` | `Fri Jul 03 2015 18:04:07 GMT+0100 (GMT Daylight Time)` | `2017-07-19 03:21:51+00:00`                    | `September 17, 2012 10:09am`      |
| `2014-04-26`                                       | `September 17, 2012 at 10:09am PST-08`                  | `2014-04`                                      | `September 17, 2012, 10:10:09`    |
| `2014`                                             | `2014:3:31`                                             | `2014-05-11 08:20:13,787`                      | `2014:03:31`                      |
| `3.31.2014`                                        | `2014:4:8 22:05`                                        | `03.31.2014`                                   | `2014:04:08 22:05`                |
| `08.21.71`                                         | `2014:04:2 03:00:51`                                    | `2014.03`                                      | `2014:4:02 03:00:51`              |
| `2014.03.30`                                       | `2012:03:19 10:11:59`                                   | `20140601`                                     | `2012:03:19 10:11:59.3186369`     |
| `20140722105203`                                   | `2014 å¹´ 04 æœˆ 08 æ—¥ `                                  | `1332151919`                                   | `2006-01-02T15:04:05+0000`        |
| `1384216367189`                                    | `2009-08-12T22:15:09-07:00`                             | `1384216367111222`                             | `2009-08-12T22:15:09`             |
| `1384216367111222333`                              | `2009-08-12T22:15:09Z`                                  |
<!-- markdownlint-enable -->

JSON æå–ç¤ºä¾‹ï¼š

```python
# åŸå§‹ json
{
    "time":"06/Jan/2017:16:16:37 +0000",
    "second":2,
    "third":"abc",
    "forth":true
}

# pipeline è„šæœ¬
json(_, time)      # æå– time å­—æ®µ
default_time(time) # å°†æå–åˆ°çš„ time å­—æ®µè½¬æ¢æˆæ—¶é—´æˆ³

# å¤„ç†ç»“æœ
{
  "time": 1483719397000000000,
}
```

æ–‡æœ¬æå–ç¤ºä¾‹ï¼š

```python
# åŸå§‹æ—¥å¿—æ–‡æœ¬
2021-01-11T17:43:51.887+0800  DEBUG io  io/io.go:458  post cost 6.87021ms

# pipeline è„šæœ¬
grok(_, '%{TIMESTAMP_ISO8601:log_time}')   # æå–æ—¥å¿—æ—¶é—´ï¼Œå¹¶å°†å­—æ®µå‘½åä¸º log_time
default_time(log_time)                     # å°†æå–åˆ°çš„ log_time å­—æ®µè½¬æ¢æˆæ—¶é—´æˆ³

# å¤„ç†ç»“æœ
{
  "log_time": 1610358231887000000,
}

# å¯¹äº logging é‡‡é›†çš„æ•°æ®ï¼Œæœ€å¥½å°†æ—¶é—´å­—æ®µå‘½åä¸º timeï¼Œå¦åˆ™ logging é‡‡é›†å™¨ä¼šä»¥å½“å‰æ—¶é—´å¡«å……
rename("time", log_time)

# å¤„ç†ç»“æœ
{
  "time": 1610358231887000000,
}
```



### `delete()` {#fn-delete}
[:octicons-tag-24: Version-1.5.8](../datakit/changelog.md#cl-1.5.8)

å‡½æ•°åŸå‹ï¼š`fn delete(src: map[string]any, key: str)`

å‡½æ•°è¯´æ˜ï¼š åˆ é™¤ JSON map ä¸­çš„ keyã€‚

```python

# input
# {"a": "b", "b":[0, {"c": "d"}], "e": 1}

# script
j_map = load_json(_)

delete(j_map["b"][-1], "c")

delete(j_map, "a")

add_key("j_map", j_map)

# result:
# {
#   "j_map": "{\"b\":[0,{}],\"e\":1}",
# }
```


### `drop()` {#fn-drop}

å‡½æ•°åŸå‹ï¼š`fn drop()`

å‡½æ•°è¯´æ˜ï¼šä¸¢å¼ƒæ•´æ¡æ—¥å¿—ï¼Œä¸è¿›è¡Œä¸Šä¼ ã€‚

```python
# in << {"str_a": "2", "str_b": "3"}
json(_, str_a)
if str_a == "2"{
  drop()
  exit()
}
json(_, str_b)

# Extracted data(drop: true, cost: 30.02Âµs):
# {
#   "message": "{\"str_a\": \"2\", \"str_b\": \"3\"}",
#   "str_a": "2"
# }
```



### `drop_key()` {#fn-drop-key}

å‡½æ•°åŸå‹ï¼š`fn drop_key(key)`

å‡½æ•°è¯´æ˜ï¼šåˆ é™¤å·²æå–å­—æ®µã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: å¾…åˆ é™¤å­—æ®µå

ç¤ºä¾‹ï¼š

```python
# data = `{\"age\": 17, \"name\": \"zhangsan\", \"height\": 180}`

# å¤„ç†è„šæœ¬
json(_, age,)
json(_, name)
json(_, height)
drop_key(height)

# å¤„ç†ç»“æœ
{
    "age": 17,
    "name": "zhangsan"
}
```



### `drop_origin_data()` {#fn-drop-origin-data}

å‡½æ•°åŸå‹ï¼š`fn drop_origin_data()`

å‡½æ•°è¯´æ˜ï¼šä¸¢å¼ƒåˆå§‹åŒ–æ–‡æœ¬ï¼Œå¦åˆ™åˆå§‹æ–‡æœ¬æ”¾åœ¨ message å­—æ®µä¸­ã€‚

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š{"age": 17, "name": "zhangsan", "height": 180}

# ç»“æœé›†ä¸­åˆ é™¤ message å†…å®¹
drop_origin_data()
```



### `duration_precision()` {#fn-duration-precision}

å‡½æ•°åŸå‹ï¼š`fn duration_precision(key, old_precision: str, new_precision: str)`

å‡½æ•°è¯´æ˜ï¼šè¿›è¡Œ duration ç²¾åº¦çš„è½¬æ¢ï¼Œé€šè¿‡å‚æ•°æŒ‡å®šå½“å‰ç²¾åº¦å’Œç›®æ ‡ç²¾åº¦ã€‚æ”¯æŒåœ¨ s, ms, us, ns é—´è½¬æ¢ã€‚

```python
# in << {"ts":12345}
json(_, ts)
cast(ts, "int")
duration_precision(ts, "ms", "ns")

# Extracted data(drop: false, cost: 33.279Âµs):
# {
#   "message": "{\"ts\":12345}",
#   "ts": 12345000000
# }
```


### `exit()` {#fn-exit}

å‡½æ•°åŸå‹ï¼š`fn exit()`

å‡½æ•°è¯´æ˜ï¼šç»“æŸå½“å‰ä¸€æ¡æ—¥å¿—çš„è§£æï¼Œè‹¥æœªè°ƒç”¨å‡½æ•° drop() ä»ä¼šè¾“å‡ºå·²ç»è§£æçš„éƒ¨åˆ†ã€‚

```python
# in << {"str_a": "2", "str_b": "3"}
json(_, str_a)
if str_a == "2"{
  exit()
}
json(_, str_b)

# Extracted data(drop: false, cost: 48.233Âµs):
# {
#   "message": "{\"str_a\": \"2\", \"str_b\": \"3\"}",
#   "str_a": "2"
# }
```



### `geoip()` {#fn-geoip}

å‡½æ•°åŸå‹ï¼š`fn geoip(ip: str)`

å‡½æ•°è¯´æ˜ï¼šåœ¨ IP ä¸Šè¿½åŠ æ›´å¤š IP ä¿¡æ¯ã€‚ `geoip()` ä¼šé¢å¤–äº§ç”Ÿå¤šä¸ªå­—æ®µï¼Œå¦‚ï¼š

- `isp`: è¿è¥å•†
- `city`: åŸå¸‚
- `province`: çœä»½
- `country`: å›½å®¶

å‚æ•°ï¼š

- `ip`: å·²ç»æå–å‡ºæ¥çš„ IP å­—æ®µï¼Œæ”¯æŒ IPv4 å’Œ IPv6ã€‚

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š{"ip":"1.2.3.4"}

# å¤„ç†è„šæœ¬
json(_, ip)
geoip(ip)

# å¤„ç†ç»“æœ
{
  "city"     : "Brisbane",
  "country"  : "AU",
  "ip"       : "1.2.3.4",
  "province" : "Queensland",
  "isp"      : "unknown"
  "message"  : "{\"ip\": \"1.2.3.4\"}",
}
```


### `get_key()` {#fn-get-key}

å‡½æ•°åŸå‹ï¼š`fn get_key(key)`

å‡½æ•°è¯´æ˜ï¼šä»è¾“å…¥ point ä¸­è¯»å– key çš„å€¼ï¼Œè€Œä¸æ˜¯å †æ ˆä¸Šçš„å˜é‡çš„å€¼ã€‚

å‡½æ•°å‚æ•°ï¼š

- `key_name`: key çš„åç§°ã€‚

ç¤ºä¾‹ï¼š

```python
add_key("city", "shanghai")

# æ­¤å¤„å¯ä»¥ç›´æ¥é€šè¿‡ city è®¿é—®è·å– point ä¸­çš„åŒå key çš„å€¼
if city == "shanghai" {
  add_key("city_1", city)
}

# ç”±äºèµ‹å€¼çš„å³ç»“åˆæ€§ï¼Œå…ˆè·å– key ä¸º "city" çš„å€¼ï¼Œ
# è€Œååˆ›å»ºåä¸º city çš„å˜é‡
city = city + " --- ningbo" + " --- " +
    "hangzhou" + " --- suzhou ---" + ""

# get_key ä» point ä¸­è·å– "city" çš„å€¼
# å­˜åœ¨åä¸º city çš„å˜é‡ï¼Œåˆ™æ— æ³•ç›´æ¥ä» point ä¸­è·å–
if city != get_key("city") {
  add_key("city_2", city)
}

# å¤„ç†ç»“æœ
"""
{
  "city": "shanghai",
  "city_1": "shanghai",
  "city_2": "shanghai --- ningbo --- hangzhou --- suzhou ---"
}
"""
```


### `grok()` {#fn-grok}

å‡½æ•°åŸå‹ï¼š`fn grok(input: str, pattern: str, trim_space: bool = true) bool`

å‡½æ•°è¯´æ˜ï¼šé€šè¿‡ `pattern` æå–æ–‡æœ¬ä¸² `input` ä¸­çš„å†…å®¹ï¼Œå½“ pattern åŒ¹é… input æˆåŠŸæ—¶è¿”å› true å¦åˆ™è¿”å› falseã€‚

å‚æ•°ï¼š

- `input`ï¼šå¾…æå–æ–‡æœ¬ï¼Œå¯ä»¥æ˜¯åŸå§‹æ–‡æœ¬ï¼ˆ`_`ï¼‰æˆ–ç»è¿‡åˆæ¬¡æå–ä¹‹åçš„æŸä¸ª `key`ï¼›
- `pattern`: grok è¡¨è¾¾å¼ï¼Œè¡¨è¾¾å¼ä¸­æ”¯æŒæŒ‡å®š key çš„æ•°æ®ç±»å‹ï¼šbool, float, int, string(å¯¹åº” ppl çš„ strï¼Œäº¦å¯å†™ä¸º str)ï¼Œé»˜è®¤ä¸º stringï¼›
- `trim_space`: åˆ é™¤æå–å‡ºçš„å­—ç¬¦ä¸­çš„ç©ºç™½é¦–å°¾å­—ç¬¦ï¼Œé»˜è®¤å€¼ä¸º trueã€‚

```python
grok(_, pattern)    # ç›´æ¥ä½¿ç”¨è¾“å…¥çš„æ–‡æœ¬ä½œä¸ºåŸå§‹æ•°æ®
grok(key, pattern)  # å¯¹ä¹‹å‰å·²ç»æå–å‡ºæ¥çš„æŸä¸ª keyï¼Œåšå†æ¬¡ grok
```

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š"12/01/2021 21:13:14.123"

# pipline è„šæœ¬
add_pattern("_second", "(?:(?:[0-5]?[0-9]|60)(?:[:.,][0-9]+)?)")
add_pattern("_minute", "(?:[0-5][0-9])")
add_pattern("_hour", "(?:2[0123]|[01]?[0-9])")
add_pattern("time", "([^0-9]?)%{_hour:hour:string}:%{_minute:minute:int}(?::%{_second:second:float})([^0-9]?)")

grok_match_ok = grok(_, "%{DATE_US:date} %{time}")

add_key(grok_match_ok)

# å¤„ç†ç»“æœ
{
  "date": "12/01/2021",
  "hour": "21",
  "message": "12/01/2021 21:13:14.123",
  "minute": 13,
  "second": 14.123
}

{
  "date": "12/01/2021",
  "grok_match_ok": true,
  "hour": "21",
  "message": "12/01/2021 21:13:14.123",
  "minute": 13,
  "second": 14.123,
  "status": "unknown",
  "time": 1665994187473917724
}
```


### `group_between()` {#fn-group-between}

å‡½æ•°åŸå‹ï¼š`fn group_between(key: int, between: list, new_value: int|float|bool|str|map|list|nil, new_key)`

å‡½æ•°è¯´æ˜ï¼šå¦‚æœ `key` å€¼åœ¨æŒ‡å®šèŒƒå›´ `between` å†…ï¼ˆæ³¨æ„ï¼šåªèƒ½æ˜¯å•ä¸ªåŒºé—´ï¼Œå¦‚ `[0,100]`ï¼‰ï¼Œåˆ™å¯åˆ›å»ºä¸€ä¸ªæ–°å­—æ®µï¼Œå¹¶èµ‹äºˆæ–°å€¼ã€‚è‹¥ä¸æä¾›æ–°å­—æ®µï¼Œåˆ™è¦†ç›–åŸå­—æ®µå€¼ã€‚

ç¤ºä¾‹ä¸€ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š{"http_status": 200, "code": "success"}

json(_, http_status)

# å¦‚æœå­—æ®µ http_status å€¼åœ¨æŒ‡å®šèŒƒå›´å†…ï¼Œåˆ™å°†å…¶å€¼æ”¹ä¸º "OK"
group_between(http_status, [200, 300], "OK")

# å¤„ç†ç»“æœ
{
    "http_status": "OK"
}
```

ç¤ºä¾‹äºŒï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š{"http_status": 200, "code": "success"}

json(_, http_status)

# å¦‚æœå­—æ®µ http_status å€¼åœ¨æŒ‡å®šèŒƒå›´å†…ï¼Œåˆ™æ–°å»º status å­—æ®µï¼Œå…¶å€¼ä¸º "OK"
group_between(http_status, [200, 300], "OK", status)

# å¤„ç†ç»“æœ
{
    "http_status": 200,
    "status": "OK"
}
```


### `group_in()` {#fn-group-in}

å‡½æ•°åŸå‹ï¼š`fn group_in(key: int|float|bool|str, range: list, new_value: int|float|bool|str|map|list|nil, new-key = "")`

å‡½æ•°è¯´æ˜ï¼šå¦‚æœ `key` å€¼åœ¨åˆ—è¡¨ `in` ä¸­ï¼Œåˆ™å¯åˆ›å»ºä¸€ä¸ªæ–°å­—æ®µï¼Œå¹¶èµ‹äºˆæ–°å€¼ã€‚è‹¥ä¸æä¾›æ–°å­—æ®µï¼Œåˆ™è¦†ç›–åŸå­—æ®µå€¼ã€‚

ç¤ºä¾‹ï¼š

```python
# å¦‚æœå­—æ®µ log_level å€¼åœ¨åˆ—è¡¨ä¸­ï¼Œåˆ™å°†å…¶å€¼æ”¹ä¸º "OK"
group_in(log_level, ["info", "debug"], "OK")

# å¦‚æœå­—æ®µ http_status å€¼åœ¨æŒ‡å®šåˆ—è¡¨ä¸­ï¼Œåˆ™æ–°å»º status å­—æ®µï¼Œå…¶å€¼ä¸º "not-ok"
group_in(log_level, ["error", "panic"], "not-ok", status)
```


### `json()` {#fn-json}

å‡½æ•°åŸå‹ï¼š`fn json(input: str, json_path, newkey, trim_space: bool = true, delete_after_extract = false)`

å‡½æ•°è¯´æ˜ï¼šæå– JSON ä¸­çš„æŒ‡å®šå­—æ®µï¼Œå¹¶å¯å°†å…¶å‘½åæˆæ–°çš„å­—æ®µã€‚

å‚æ•°ï¼š

- `input`: å¾…æå– JSONï¼Œå¯ä»¥æ˜¯åŸå§‹æ–‡æœ¬ï¼ˆ`_`ï¼‰æˆ–ç»è¿‡åˆæ¬¡æå–ä¹‹åçš„æŸä¸ª `key`ï¼›
- `json_path`: JSON è·¯å¾„ä¿¡æ¯ï¼›
- `newkey`ï¼šæå–åæ•°æ®å†™å…¥æ–° keyï¼›
- `trim_space`: åˆ é™¤æå–å‡ºçš„å­—ç¬¦ä¸­çš„ç©ºç™½é¦–å°¾å­—ç¬¦ï¼Œé»˜è®¤å€¼ä¸º `true`ï¼›
- `delete_after_extract`: åœ¨æå–ç»“æŸååˆ é™¤å½“å‰å¯¹è±¡ï¼Œåœ¨é‡æ–°åºåˆ—åŒ–åå›å†™å¾…æå–å¯¹è±¡ï¼›åªèƒ½åº”ç”¨äº map çš„ key ä¸ value çš„åˆ é™¤ï¼Œä¸èƒ½ç”¨äºåˆ é™¤ list çš„å…ƒç´ ï¼›é»˜è®¤å€¼ä¸º `false`ï¼Œä¸è¿›è¡Œä»»ä½•æ“ä½œ[:octicons-tag-24: Version-1.5.7](../datakit/changelog.md#cl-1.5.7)ã€‚

```python
# ç›´æ¥æå–åŸå§‹è¾“å…¥ JSON ä¸­çš„ x.y å­—æ®µï¼Œå¹¶å¯å°†å…¶å‘½åæˆæ–°å­—æ®µ abc
json(_, x.y, abc)

# å·²æå–å‡ºçš„æŸä¸ª `key`ï¼Œå¯¹å…¶å†æå–ä¸€æ¬¡ `x.y`ï¼Œæå–åå­—æ®µåä¸º `x.y`
json(key, x.y) 
```

ç¤ºä¾‹ä¸€ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š
# {"info": {"age": 17, "name": "zhangsan", "height": 180}}

# å¤„ç†è„šæœ¬ï¼š
json(_, info, "zhangsan")
json(zhangsan, name)
json(zhangsan, age, "age")

# å¤„ç†ç»“æœï¼š
{
  "age": 17,
  "message": "{\"info\": {\"age\": 17, \"name\": \"zhangsan\", \"height\": 180}}",
  "name": "zhangsan",
  "zhangsan": "{\"age\":17,\"height\":180,\"name\":\"zhangsan\"}"
}
```

ç¤ºä¾‹äºŒï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š
#    data = {
#        "name": {"first": "Tom", "last": "Anderson"},
#        "age":37,
#        "children": ["Sara","Alex","Jack"],
#        "fav.movie": "Deer Hunter",
#        "friends": [
#            {"first": "Dale", "last": "Murphy", "age": 44, "nets": ["ig", "fb", "tw"]},
#            {"first": "Roger", "last": "Craig", "age": 68, "nets": ["fb", "tw"]},
#            {"first": "Jane", "last": "Murphy", "age": 47, "nets": ["ig", "tw"]}
#        ]
#    }

# å¤„ç†è„šæœ¬ï¼š
json(_, name) json(name, first)
```

ç¤ºä¾‹ä¸‰ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š
#    [
#            {"first": "Dale", "last": "Murphy", "age": 44, "nets": ["ig", "fb", "tw"]},
#            {"first": "Roger", "last": "Craig", "age": 68, "nets": ["fb", "tw"]},
#            {"first": "Jane", "last": "Murphy", "age": 47, "nets": ["ig", "tw"]}
#    ]
    
# å¤„ç†è„šæœ¬ï¼Œjson æ•°ç»„å¤„ç†ï¼š
json(_, [0].nets[-1])
```

ç¤ºä¾‹å››ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š
{"item": " not_space ", "item2":{"item3": [123]}}

# å¤„ç†è„šæœ¬ï¼š
json(_, item2.item3, item, delete_after_extract = true)

# è¾“å‡ºï¼š
{
  "item": "[123]",
  "message": "{\"item\":\" not_space \",\"item2\":{}}",
}
```


ç¤ºä¾‹äº”ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š
{"item": " not_space ", "item2":{"item3": [123]}}

# å¤„ç†è„šæœ¬ï¼š
# å¦‚æœå°è¯•åˆ é™¤åˆ—è¡¨å…ƒç´ å°†æ— æ³•é€šè¿‡è„šæœ¬æ£€æŸ¥
json(_, item2.item3[0], item, true, true)

# æœ¬åœ°æµ‹è¯•å‘½ä»¤ï¼š
# datakit pipeline -P j2.p -T '{"item": " not_space ", "item2":{"item3": [123]}}'
# æŠ¥é”™ï¼š
# [E] j2.p:1:37: does not support deleting elements in the list
```


### `kv_split()` {#fn-kv_split}

[:octicons-tag-24: Version-1.5.7](../datakit/changelog.md#cl-1.5.7)

å‡½æ•°åŸå‹ï¼š`fn kv_split(key, field_split_pattern = " ", value_split_pattern = "=", trim_key = "", trim_value = "", include_keys = [], prefix = "") -> bool`

å‡½æ•°è¯´æ˜ï¼šä»å­—ç¬¦ä¸²ä¸­æå–å‡ºæ‰€æœ‰çš„é”®å€¼å¯¹ã€‚

å‚æ•°ï¼š

- `key`: key åç§°ï¼›
- `include_keys`: åŒ…å«çš„ key åç§°åˆ—è¡¨ï¼Œä»…æå–åœ¨è¯¥åˆ—è¡¨å†…çš„ keyï¼›**é»˜è®¤å€¼ä¸º []ï¼Œä¸æå–ä»»ä½• key**ï¼›
- `field_split_pattern`: å­—ç¬¦ä¸²åˆ†å‰²ï¼Œç”¨äºæå–å‡ºæ‰€æœ‰é”®å€¼å¯¹çš„æ­£åˆ™è¡¨è¾¾å¼ï¼›é»˜è®¤å€¼ä¸º `" "`ï¼›
- `value_split_pattern`: ç”¨äºä»é”®å€¼å¯¹å­—ç¬¦ä¸²åˆ†å‰²å‡ºé”®å’Œå€¼ï¼Œéé€’å½’ï¼›é»˜è®¤å€¼ä¸º `"="`ï¼›
- `trim_key`: åˆ é™¤æå–å‡ºçš„ key çš„å‰å¯¼å’Œå°¾éšçš„æ‰€æœ‰æŒ‡å®šçš„å­—ç¬¦ï¼›é»˜è®¤å€¼ä¸º `""`ï¼›
- `trim_value`: åˆ é™¤æå–å‡ºçš„ value çš„å‰å¯¼å’Œå°¾éšçš„æ‰€æœ‰æŒ‡å®šçš„å­—ç¬¦ï¼›é»˜è®¤å€¼ä¸º `""`ï¼›
- `prefix`: ç»™æ‰€æœ‰çš„ key æ·»åŠ å‰ç¼€å­—ç¬¦ä¸²ã€‚

ç¤ºä¾‹ï¼š


```python
# input: "a=1, b=2 c=3"
kv_split(_)
 
'''output:
{
  "message": "a=1, b=2 c=3",
  "status": "unknown",
  "time": 1679558730846377132
}
'''
```

```python
# input: "a=1, b=2 c=3"
kv_split(_, include_keys=["a", "c", "b"])
 
'''output:
{
  "a": "1,",
  "b": "2",
  "c": "3",
  "message": "a=1 b=2 c=3",
  "status": "unknown",
  "time": 1678087119072769560
}
'''
```

```python
# input: "a=1, b=2 c=3"
kv_split(_, trim_value=",", include_keys=["a", "c", "b"])

'''output:
{
  "a": "1",
  "b": "2",
  "c": "3",
  "message": "a=1, b=2 c=3",
  "status": "unknown",
  "time": 1678087173651846101
}
'''
```


```python
# input: "a=1, b=2 c=3"
kv_split(_, trim_value=",", include_keys=["a", "c"])

'''output:
{
  "a": "1",
  "c": "3",
  "message": "a=1, b=2 c=3",
  "status": "unknown",
  "time": 1678087514906492912
}
'''
```

```python
# input: "a::1,+b::2+c::3" 
kv_split(_, field_split_pattern="\\+", value_split_pattern="[:]{2}",
    prefix="with_prefix_",trim_value=",", trim_key="a", include_keys=["a", "b", "c"])

'''output:
{
  "message": "a::1,+b::2+c::3",
  "status": "unknown",
  "time": 1678087473255241547,
  "with_prefix_b": "2",
  "with_prefix_c": "3"
}
'''
```


### `len()` {#fn-len}

å‡½æ•°åŸå‹ï¼š`fn len(val: str|map|list) int`

å‡½æ•°è¯´æ˜ï¼šè®¡ç®— string å­—èŠ‚æ•°ï¼Œmap å’Œ list çš„å…ƒç´ ä¸ªæ•°ã€‚

å‚æ•°ï¼š

- `val`: å¯ä»¥æ˜¯ mapã€list æˆ– stringã€‚

ç¤ºä¾‹ï¼š

```python
# ä¾‹ 1
add_key(abc, len("abc"))
# è¾“å‡º
{
 "abc": 3,
}

# ä¾‹ 2
add_key(abc, len(["abc"]))
#å¤„ç†ç»“æœ
{
  "abc": 1,
}
```


### `load_json()` {#fn-load_JSON}

å‡½æ•°åŸå‹ï¼š`fn load_json(val: str) nil|bool|float|map|list`

å‡½æ•°è¯´æ˜ï¼šå°† JSON å­—ç¬¦ä¸²è½¬æ¢æˆ mapã€listã€nilã€boolã€float çš„å…¶ä¸­ä¸€ç§ï¼Œå¯é€šè¿‡ index è¡¨è¾¾å¼å–å€¼åŠä¿®æ”¹å€¼ã€‚

å‚æ•°ï¼š

- `val`: è¦æ±‚æ˜¯ string ç±»å‹çš„æ•°æ®ã€‚

ç¤ºä¾‹ï¼š

```python
# _: {"a":{"first": [2.2, 1.1], "ff": "[2.2, 1.1]","second":2,"third":"aBC","forth":true},"age":47}
abc = load_json(_)

add_key(abc, abc["a"]["first"][-1])

abc["a"]["first"][-1] = 11

# éœ€è¦å°†å †æ ˆä¸Šçš„æ•°æ®åŒæ­¥åˆ° point ä¸­
add_key(abc, abc["a"]["first"][-1])

add_key(len_abc, len(abc))

add_key(len_abc, len(load_json(abc["a"]["ff"])))
```


### `lowercase()` {#fn-lowercase}

å‡½æ•°åŸå‹ï¼š`fn lowercase(key: str)`

å‡½æ•°è¯´æ˜ï¼šå°†å·²æå– key ä¸­å†…å®¹è½¬æ¢æˆå°å†™ã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: æŒ‡å®šå·²æå–çš„å¾…è½¬æ¢å­—æ®µåã€‚

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š{"first": "HeLLo","second":2,"third":"aBC","forth":true}

# å¤„ç†è„šæœ¬
json(_, first) lowercase(first)

# å¤„ç†ç»“æœ
{
    "first": "hello"
}
```



### `match()` {#fn-match}

å‡½æ•°åŸå‹ï¼š`fn match(pattern: str, s: str) bool`

å‡½æ•°è¯´æ˜ï¼šä½¿ç”¨æŒ‡å®šçš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å­—ç¬¦ä¸²ï¼ŒåŒ¹é…æˆåŠŸè¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚

å‚æ•°ï¼š

- `pattern`: æ­£åˆ™è¡¨è¾¾å¼ï¼›
- `s`: å¾…åŒ¹é…çš„å­—ç¬¦ä¸²ã€‚

ç¤ºä¾‹ï¼š

```python
# è„šæœ¬
test_1 = "pattern 1,a"
test_2 = "pattern -1,"

add_key(match_1, match('''\w+\s[,\w]+''', test_1)) 

add_key(match_2, match('''\w+\s[,\w]+''', test_2)) 

# å¤„ç†ç»“æœ
{
    "match_1": true,
    "match_2": false
}
```


### `mquery_refer_table()` {#fn-mquery-refer-table}

å‡½æ•°åŸå‹ï¼š`fn mquery_refer_table(table_name: str, keys: list, values: list)`

å‡½æ•°è¯´æ˜ï¼šé€šè¿‡æŒ‡å®šå¤šä¸ª key æŸ¥è¯¢å¤–éƒ¨å¼•ç”¨è¡¨ï¼Œå¹¶å°†æŸ¥è¯¢ç»“æœçš„é¦–è¡Œçš„æ‰€æœ‰åˆ—è¿½åŠ åˆ° field ä¸­ã€‚

å‚æ•°ï¼š

- `table_name`: å¾…æŸ¥æ‰¾çš„è¡¨åï¼›
- `keys`: å¤šä¸ªåˆ—åæ„æˆçš„åˆ—è¡¨ï¼›
- `values`: æ¯ä¸ªåˆ—å¯¹åº”çš„å€¼ã€‚

ç¤ºä¾‹ï¼š

```python
json(_, table)
json(_, key)
json(_, value)

# æŸ¥è¯¢å¹¶è¿½åŠ å½“å‰åˆ—çš„æ•°æ®ï¼Œé»˜è®¤ä½œä¸º field æ·»åŠ åˆ°æ•°æ®ä¸­
mquery_refer_table(table, values=[value, false], keys=[key, "col4"])
```

ç¤ºä¾‹ç»“æœï¼š

```json
{
  "col": "ab",
  "col2": 1234,
  "col3": 1235,
  "col4": false,
  "key": "col2",
  "message": "{\"table\": \"table_abc\", \"key\": \"col2\", \"value\": 1234.0}",
  "status": "unknown",
  "table": "table_abc",
  "time": "2022-08-16T16:23:31.940600281+08:00",
  "value": 1234
}

```


### `nullif()` {#fn-nullif}

å‡½æ•°åŸå‹ï¼š`fn nullif(key, value)`

å‡½æ•°è¯´æ˜ï¼šè‹¥å·²æå– `key` æŒ‡å®šçš„å­—æ®µå†…å®¹ç­‰äº `value` å€¼ï¼Œåˆ™åˆ é™¤æ­¤å­—æ®µã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: æŒ‡å®šå­—æ®µï¼›
- `value`: ç›®æ ‡å€¼ã€‚

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š{"first": 1,"second":2,"third":"aBC","forth":true}

# å¤„ç†è„šæœ¬
json(_, first) json(_, second) nullif(first, "1")

# å¤„ç†ç»“æœ
{
    "second":2
}
```

> æ³¨ï¼šè¯¥åŠŸèƒ½å¯é€šè¿‡ `if/else` è¯­ä¹‰æ¥å®ç°ï¼š

```python
if first == "1" {
    drop_key(first)
}
```



### `parse_date()` {#fn-parse-date}

å‡½æ•°åŸå‹ï¼š`fn parse_date(key: str, yy: str, MM: str, dd: str, hh: str, mm: str, ss: str, ms: str, zone: str)`

å‡½æ•°è¯´æ˜ï¼šå°†ä¼ å…¥çš„æ—¥æœŸå­—æ®µå„éƒ¨åˆ†çš„å€¼è½¬åŒ–ä¸ºæ—¶é—´æˆ³ã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: æ–°æ’å…¥çš„å­—æ®µ
- `yy` : å¹´ä»½æ•°å­—å­—ç¬¦ä¸²ï¼Œæ”¯æŒå››ä½æˆ–ä¸¤ä½æ•°å­—å­—ç¬¦ä¸²ï¼Œä¸ºç©ºå­—ç¬¦ä¸²ï¼Œåˆ™å¤„ç†æ—¶å–å½“å‰å¹´ä»½
- `MM`:  æœˆä»½å­—ç¬¦ä¸²ï¼Œæ”¯æŒæ•°å­—ï¼Œè‹±æ–‡ï¼Œè‹±æ–‡ç¼©å†™
- `dd`: æ—¥å­—ç¬¦ä¸²
- `hh`: å°æ—¶å­—ç¬¦ä¸²
- `mm`: åˆ†é’Ÿå­—ç¬¦ä¸²
- `ss`: ç§’å­—ç¬¦ä¸²
- `ms`: æ¯«ç§’å­—ç¬¦ä¸²
- `us`: å¾®ç§’å­—ç¬¦ä¸²
- `ns`: çº³ç§’å­—ç¬¦ä¸²
- `zone`: æ—¶åŒºå­—ç¬¦ä¸²ï¼Œâ€œ+8â€æˆ–\"Asia/Shanghai\"å½¢å¼

ç¤ºä¾‹ï¼š

```python
parse_date(aa, "2021", "May", "12", "10", "10", "34", "", "Asia/Shanghai") # ç»“æœ aa=1620785434000000000

parse_date(aa, "2021", "12", "12", "10", "10", "34", "", "Asia/Shanghai") # ç»“æœ aa=1639275034000000000

parse_date(aa, "2021", "12", "12", "10", "10", "34", "100", "Asia/Shanghai") # ç»“æœ aa=1639275034000000100

parse_date(aa, "20", "February", "12", "10", "10", "34", "", "+8") ç»“æœ aa=1581473434000000000
```


### `parse_duration()` {#fn-parse-duration}

å‡½æ•°åŸå‹ï¼š`fn parse_duration(key: str)`

å‡½æ•°è¯´æ˜ï¼šå¦‚æœ `key` çš„å€¼æ˜¯ä¸€ä¸ª golang çš„ duration å­—ç¬¦ä¸²ï¼ˆå¦‚ `123ms`ï¼‰ï¼Œåˆ™è‡ªåŠ¨å°† `key` è§£ææˆçº³ç§’ä¸ºå•ä½çš„æ•´æ•°ã€‚

ç›®å‰ golang ä¸­çš„ duration å•ä½å¦‚ä¸‹ï¼š

- `ns` çº³ç§’
- `us/Âµs` å¾®ç§’
- `ms` æ¯«ç§’
- `s` ç§’
- `m` åˆ†é’Ÿ
- `h` å°æ—¶

å‡½æ•°å‚æ•°ï¼š

- `key`: å¾…è§£æçš„å­—æ®µ

ç¤ºä¾‹ï¼š

```python
# å‡å®š abc = "3.5s"
parse_duration(abc) # ç»“æœ abc = 3500000000

# æ”¯æŒè´Ÿæ•°ï¼šabc = "-3.5s"
parse_duration(abc) # ç»“æœ abc = -3500000000

# æ”¯æŒæµ®ç‚¹ï¼šabc = "-2.3s"
parse_duration(abc) # ç»“æœ abc = -2300000000

```



### `query_refer_table()` {#fn-query-refer-table}

å‡½æ•°åŸå‹ï¼š`fn query_refer_table(table_name: str, key: str, value)`

å‡½æ•°è¯´æ˜ï¼šé€šè¿‡æŒ‡å®šçš„ key æŸ¥è¯¢å¤–éƒ¨å¼•ç”¨è¡¨ï¼Œå¹¶å°†æŸ¥è¯¢ç»“æœçš„é¦–è¡Œçš„æ‰€æœ‰åˆ—è¿½åŠ åˆ° field ä¸­ã€‚

å‚æ•°ï¼š

- `table_name`: å¾…æŸ¥æ‰¾çš„è¡¨å
- `key`: åˆ—å
- `value`: åˆ—å¯¹åº”çš„å€¼

ç¤ºä¾‹ï¼š

```python
# ä»è¾“å…¥ä¸­æå– è¡¨åï¼Œåˆ—åï¼Œåˆ—å€¼
json(_, table)
json(_, key)
json(_, value)

# æŸ¥è¯¢å¹¶è¿½åŠ å½“å‰åˆ—çš„æ•°æ®ï¼Œé»˜è®¤ä½œä¸º field æ·»åŠ åˆ°æ•°æ®ä¸­
query_refer_table(table, key, value)

```

ç¤ºä¾‹ç»“æœï¼š

```json
{
  "col": "ab",
  "col2": 1234,
  "col3": 123,
  "col4": true,
  "key": "col2",
  "message": "{\"table\": \"table_abc\", \"key\": \"col2\", \"value\": 1234.0}",
  "status": "unknown",
  "table": "table_abc",
  "time": "2022-08-16T15:02:14.158452592+08:00",
  "value": 1234
}
```


### `rename()` {#fn-rename}

å‡½æ•°åŸå‹ï¼š`fn rename(new_key, old_key)`

å‡½æ•°è¯´æ˜ï¼šå°†å·²æå–çš„å­—æ®µé‡æ–°å‘½åã€‚

å‚æ•°ï¼š

- `new_key`: æ–°å­—æ®µå
- `old_key`: å·²æå–çš„å­—æ®µå

ç¤ºä¾‹ï¼š

```python
# æŠŠå·²æå–çš„ abc å­—æ®µé‡æ–°å‘½åä¸º abc1
rename('abc1', abc)

# or 

rename(abc1, abc)
```

```python
# å¾…å¤„ç†æ•°æ®ï¼š{"info": {"age": 17, "name": "zhangsan", "height": 180}}

# å¤„ç†è„šæœ¬
json(_, info.name, "å§“å")

# å¤„ç†ç»“æœ
{
  "message": "{\"info\": {\"age\": 17, \"name\": \"zhangsan\", \"height\": 180}}",
  "zhangsan": {
    "age": 17,
    "height": 180,
    "å§“å": "zhangsan"
  }
}
```



### `replace()` {#fn-replace}

å‡½æ•°åŸå‹ï¼š`fn replace(key: str, regex: str, replace_str: str)`

å‡½æ•°è¯´æ˜ï¼šå¯¹æŒ‡å®šå­—æ®µä¸Šè·å–çš„å­—ç¬¦ä¸²æ•°æ®æŒ‰æ­£åˆ™è¿›è¡Œæ›¿æ¢ã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: å¾…æå–å­—æ®µ
- `regex`: æ­£åˆ™è¡¨è¾¾å¼
- `replace_str`: æ›¿æ¢çš„å­—ç¬¦ä¸²

ç¤ºä¾‹ï¼š

```python
# ç”µè¯å·ç ï¼š{"str_abc": "13789123014"}
json(_, str_abc)
replace(str_abc, "(1[0-9]{2})[0-9]{4}([0-9]{4})", "$1****$2")

# è‹±æ–‡å {"str_abc": "zhang san"}
json(_, str_abc)
replace(str_abc, "([a-z]*) \\w*", "$1 ***")

# èº«ä»½è¯å· {"str_abc": "362201200005302565"}
json(_, str_abc)
replace(str_abc, "([1-9]{4})[0-9]{10}([0-9]{4})", "$1**********$2")

# ä¸­æ–‡å {"str_abc": "å°é˜¿å¡"}
json(_, str_abc)
replace(str_abc, '([\u4e00-\u9fa5])[\u4e00-\u9fa5]([\u4e00-\u9fa5])', "$1ï¼Š$2")
```



### `sample()` {#fn-sample}

å‡½æ•°åŸå‹ï¼š`fn sample(p)`

å‡½æ•°è¯´æ˜ï¼šä»¥æ¦‚ç‡ p é€‰æ‹©é‡‡é›†/ä¸¢å¼ƒæ•°æ®ã€‚

å‡½æ•°å‚æ•°ï¼š

- `p`: sample å‡½æ•°è¿”å› true çš„æ¦‚ç‡ï¼Œå–å€¼èŒƒå›´ä¸º[0, 1]

ç¤ºä¾‹ï¼š

```python
# å¤„ç†è„šæœ¬
if !sample(0.3) { # sample(0.3) è¡¨ç¤ºé‡‡æ ·ç‡ä¸º 30%ï¼Œå³ä»¥ 30% æ¦‚ç‡è¿”å›çœŸï¼Œæ­¤å¤„å°†ä¸¢å¼ƒ 70% çš„æ•°æ®
  drop() # æ ‡è®°è¯¥æ•°æ®ä¸¢å¼ƒ
  exit() # é€€å‡ºåç»­å¤„ç†æµç¨‹
}
```


### `set_measurement()` {#fn-set-measurement}

å‡½æ•°åŸå‹ï¼š`fn set_measurement(name: str, delete_key: bool = false)`

å‡½æ•°è¯´æ˜ï¼šæ”¹å˜è¡Œåè®®çš„ nameã€‚

å‡½æ•°å‚æ•°ï¼š

- `name`: å€¼ä½œä¸º measurement nameï¼Œå¯ä¼ å…¥å­—ç¬¦ä¸²å¸¸é‡æˆ–å˜é‡ï¼›
- `delete_key`: å¦‚æœåœ¨ point ä¸­å­˜åœ¨ä¸å˜é‡åŒåçš„ tag æˆ– field åˆ™åˆ é™¤å®ƒã€‚

è¡Œåè®® name ä¸å„ä¸ªç±»å‹æ•°æ®å­˜å‚¨æ—¶çš„å­—æ®µæ˜ å°„å…³ç³»æˆ–å…¶ä»–ç”¨é€”ï¼š

| ç±»åˆ«          | å­—æ®µå | å…¶ä»–ç”¨é€” |
| -             | -      | -        |
| custom_object | class  | -        |
| keyevent      | -      | -        |
| logging       | source | -        |
| metric        | -      | æŒ‡æ ‡é›†å |
| network       | source | -        |
| object        | class  | -        |
| profiling     | source | -        |
| rum           | source | -        |
| security      | rule   | -        |
| tracing       | source | -        |


### `set_tag()` {#fn-set-tag}

å‡½æ•°åŸå‹ï¼š`fn set_tag(key, value: str)`

å‡½æ•°è¯´æ˜ï¼šå¯¹æŒ‡å®šå­—æ®µæ ‡è®°ä¸º tag è¾“å‡ºï¼Œè®¾ç½®ä¸º tag åï¼Œå…¶ä»–å‡½æ•°ä»å¯å¯¹è¯¥å˜é‡æ“ä½œã€‚å¦‚æœè¢«ç½®ä¸º tag çš„ key æ˜¯å·²ç»åˆ‡å‰²å‡ºæ¥çš„ fieldï¼Œé‚£ä¹ˆå®ƒå°†ä¸ä¼šåœ¨ field ä¸­å‡ºç°ï¼Œè¿™æ ·å¯ä»¥é¿å…åˆ‡å‰²å‡ºæ¥çš„ field key è·Ÿå·²æœ‰æ•°æ®ä¸Šçš„ tag key é‡åã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: å¾…æ ‡è®°ä¸º tag çš„å­—æ®µï¼›
- `value`: å¯ä»¥ä¸ºå­—ç¬¦ä¸²å­—é¢é‡æˆ–è€…å˜é‡ã€‚

```python
# in << {"str": "13789123014"}
set_tag(str)
json(_, str)          # str == "13789123014"
replace(str, "(1[0-9]{2})[0-9]{4}([0-9]{4})", "$1****$2")
# Extracted data(drop: false, cost: 49.248Âµs):
# {
#   "message": "{\"str\": \"13789123014\", \"str_b\": \"3\"}",
#   "str#": "137****3014"
# }
# * å­—ç¬¦ `#` ä»…ä¸º datakit --pl <path> --txt <str> è¾“å‡ºå±•ç¤ºæ—¶å­—æ®µä¸º tag çš„æ ‡è®°

# in << {"str_a": "2", "str_b": "3"}
json(_, str_a)
set_tag(str_a, "3")   # str_a == 3
# Extracted data(drop: false, cost: 30.069Âµs):
# {
#   "message": "{\"str_a\": \"2\", \"str_b\": \"3\"}",
#   "str_a#": "3"
# }


# in << {"str_a": "2", "str_b": "3"}
json(_, str_a)
json(_, str_b)
set_tag(str_a, str_b) # str_a == str_b == "3"
# Extracted data(drop: false, cost: 32.903Âµs):
# {
#   "message": "{\"str_a\": \"2\", \"str_b\": \"3\"}",
#   "str_a#": "3",
#   "str_b": "3"
# }
```


### `sql_cover()` {#fn-sql-cover}

å‡½æ•°åŸå‹ï¼š`fn sql_cover(sql_test: str)`

å‡½æ•°è¯´æ˜ï¼šè„±æ• SQL è¯­å¥ã€‚

```python
# in << {"select abc from def where x > 3 and y < 5"}
sql_cover(_)

# Extracted data(drop: false, cost: 33.279Âµs):
# {
#   "message": "select abc from def where x > ? and y < ?"
# }
```


### `strfmt()` {#fn-strfmt}

å‡½æ•°åŸå‹ï¼š`fn strfmt(key, fmt: str, args ...: int|float|bool|str|list|map|nil)`

å‡½æ•°è¯´æ˜ï¼šå¯¹å·²æå– `arg1, arg2, ...` æŒ‡å®šçš„å­—æ®µå†…å®¹æ ¹æ® `fmt` è¿›è¡Œæ ¼å¼åŒ–ï¼Œå¹¶æŠŠæ ¼å¼åŒ–åçš„å†…å®¹å†™å…¥ `key` å­—æ®µä¸­ã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: æŒ‡å®šæ ¼å¼åŒ–åæ•°æ®å†™å…¥å­—æ®µåï¼›
- `fmt`: æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¨¡æ¿ï¼›
- `args`ï¼šå¯å˜å‚æ•°ï¼Œå¯ä»¥æ˜¯å¤šä¸ªå·²æå–çš„å¾…æ ¼å¼åŒ–å­—æ®µåã€‚

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š{"a":{"first":2.3,"second":2,"third":"abc","forth":true},"age":47}

# å¤„ç†è„šæœ¬
json(_, a.second)
json(_, a.thrid)
cast(a.second, "int")
json(_, a.forth)
strfmt(bb, "%v %s %v", a.second, a.thrid, a.forth)
```


### `timestamp()` {#fn-timestamp}

å‡½æ•°åŸå‹ï¼š`fn timestamp(precision: str = "ns") -> int`

å‡½æ•°è¯´æ˜ï¼šè¿”å›å½“å‰ Unix æ—¶é—´æˆ³ï¼Œé»˜è®¤ç²¾åº¦ä¸º nsã€‚

å‡½æ•°å‚æ•°ï¼š

- `precision`: æ—¶é—´æˆ³ç²¾åº¦ï¼Œå–å€¼èŒƒå›´ä¸º "ns", "us", "ns", "s", é»˜è®¤å€¼ "ns"ã€‚

ç¤ºä¾‹ï¼š

```python
# å¤„ç†è„šæœ¬
add_key(time_now_record, timestamp())

datetime(time_now_record, "ns", 
    "%Y-%m-%d %H:%M:%S", "UTC")


# å¤„ç†ç»“æœ
{
  "time_now_record": "2023-03-07 10:41:12"
}

```

```python
# å¤„ç†è„šæœ¬
add_key(time_now_record, timestamp())

datetime(time_now_record, "ns", 
    "%Y-%m-%d %H:%M:%S", "Asia/Shanghai")


# å¤„ç†ç»“æœ
{
  "time_now_record": "2023-03-07 18:41:49"
}
```

```python
# å¤„ç†è„šæœ¬
add_key(time_now_record, timestamp("ms"))


# å¤„ç†ç»“æœ
{
  "time_now_record": 1678185980578
}
```


### `trim()` {#fn-trim}

å‡½æ•°åŸå‹ï¼š`fn trim(key, cutset: str = "")`

å‡½æ•°è¯´æ˜ï¼šåˆ é™¤ `key` ä¸­é¦–å°¾ä¸­æŒ‡å®šçš„å­—ç¬¦ï¼Œ`cutset` ä¸ºç©ºå­—ç¬¦ä¸²æ—¶é»˜è®¤åˆ é™¤æ‰€æœ‰ç©ºç™½ç¬¦ã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: å·²æå–çš„æŸå­—æ®µï¼Œå­—ç¬¦ä¸²ç±»å‹ï¼›
- `cutset`: åˆ é™¤ `key` ä¸­å‡ºç°åœ¨ `cutset` å­—ç¬¦ä¸²çš„ä¸­é¦–å°¾å­—ç¬¦ã€‚

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š"trim(key, cutset)"

# å¤„ç†è„šæœ¬
add_key(test_data, "ACCAA_test_DataA_ACBA")
trim(test_data, "ABC_")

# å¤„ç†ç»“æœ
{
  "test_data": "test_Data"
}
```


### `uppercase()` {#fn-uppercase}

å‡½æ•°åŸå‹ï¼š`fn uppercase(key: str)`

å‡½æ•°è¯´æ˜ï¼šå°†å·²æå– key ä¸­å†…å®¹è½¬æ¢æˆå¤§å†™ã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: æŒ‡å®šå·²æå–çš„å¾…è½¬æ¢å­—æ®µåï¼Œå°† `key` å†…å®¹è½¬æˆå¤§å†™ã€‚

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š{"first": "hello","second":2,"third":"aBC","forth":true}

# å¤„ç†è„šæœ¬
json(_, first) uppercase(first)

# å¤„ç†ç»“æœ
{
   "first": "HELLO"
}
```



### `url_decode()` {#fn-url-decode}

å‡½æ•°åŸå‹ï¼š`fn url_decode(key: str)`

å‡½æ•°è¯´æ˜ï¼šå°†å·²æå– `key` ä¸­çš„ URL è§£ææˆæ˜æ–‡ã€‚

å‚æ•°ï¼š

- `key`: å·²ç»æå–çš„æŸä¸ª `key`

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š{"url":"http%3a%2f%2fwww.baidu.com%2fs%3fwd%3d%e6%b5%8b%e8%af%95"}

# å¤„ç†è„šæœ¬
json(_, url) url_decode(url)

# å¤„ç†ç»“æœ
{
  "message": "{"url":"http%3a%2f%2fwww.baidu.com%2fs%3fwd%3d%e6%b5%8b%e8%af%95"}",
  "url": "http://www.baidu.com/s?wd=æµ‹è¯•"
}
```


### `url_parse()` {#fn-url-parse}

å‡½æ•°åŸå‹ï¼š`fn url_parse(key)`

å‡½æ•°è¯´æ˜ï¼šè§£æå­—æ®µåç§°ä¸º key çš„ urlã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: è¦è§£æçš„ url çš„å­—æ®µåç§°ã€‚

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š{"url": "https://www.baidu.com"}

# å¤„ç†è„šæœ¬
json(_, url)
m = url_parse(url)
add_key(scheme, m["scheme"])

# å¤„ç†ç»“æœ
{
    "url": "https://www.baidu.com",
    "scheme": "https"
}
```

ä¸Šè¿°ç¤ºä¾‹ä» url æå–äº†å…¶ schemeï¼Œé™¤æ­¤ä»¥å¤–ï¼Œè¿˜èƒ½ä» url æå–å‡º host, port, path, ä»¥åŠ url ä¸­æºå¸¦çš„å‚æ•°ç­‰ä¿¡æ¯ï¼Œå¦‚ä¸‹ä¾‹å­æ‰€ç¤ºï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š{"url": "https://www.google.com/search?q=abc&sclient=gws-wiz"}

# å¤„ç†è„šæœ¬
json(_, url)
m = url_parse(url)
add_key(sclient, m["params"]["sclient"])    # url ä¸­æºå¸¦çš„å‚æ•°è¢«ä¿å­˜åœ¨ params å­—æ®µä¸‹
add_key(h, m["host"])
add_key(path, m["path"])

# å¤„ç†ç»“æœ
{
    "url": "https://www.google.com/search?q=abc&sclient=gws-wiz",
    "h": "www.google.com",
    "path": "/search",
    "sclient": "gws-wiz"
}
```


### `use()` {#fn-use}

å‡½æ•°åŸå‹ï¼š`fn use(name: str)`

å‚æ•°ï¼š

- `name`: è„šæœ¬åï¼Œå¦‚ abp.p

å‡½æ•°è¯´æ˜ï¼šè°ƒç”¨å…¶ä»–è„šæœ¬ï¼Œå¯åœ¨è¢«è°ƒç”¨çš„è„šæœ¬è®¿é—®å½“å‰çš„æ‰€æœ‰æ•°æ®ã€‚
ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®ï¼š{"ip":"1.2.3.4"}

# å¤„ç†è„šæœ¬ a.p
use(\"b.p\")

# å¤„ç†è„šæœ¬ b.p
json(_, ip)
geoip(ip)

# æ‰§è¡Œè„šæœ¬ a.p çš„å¤„ç†ç»“æœ
{
  "city"     : "Brisbane",
  "country"  : "AU",
  "ip"       : "1.2.3.4",
  "province" : "Queensland",
  "isp"      : "unknown"
  "message"  : "{\"ip\": \"1.2.3.4\"}",
}
```


### `user_agent()` {#fn-user-agent}

å‡½æ•°åŸå‹ï¼š`fn user_agent(key: str)`

å‡½æ•°è¯´æ˜ï¼šå¯¹æŒ‡å®šå­—æ®µä¸Šè·å–å®¢æˆ·ç«¯ä¿¡æ¯ã€‚

å‡½æ•°å‚æ•°ï¼š

- `key`: å¾…æå–å­—æ®µ

`user_agent()` ä¼šç”Ÿäº§å¤šä¸ªå­—æ®µï¼Œå¦‚ï¼š

- `os`: æ“ä½œç³»ç»Ÿ
- `browser`: æµè§ˆå™¨

ç¤ºä¾‹ï¼š

```python
# å¾…å¤„ç†æ•°æ®
#    {
#        "userAgent" : "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1985.125 Safari/537.36",
#        "second"    : 2,
#        "third"     : "abc",
#        "forth"     : true
#    }

json(_, userAgent) user_agent(userAgent)
```


### `xml()` {#fn-xml}

å‡½æ•°åŸå‹ï¼š`fn xml(input: str, xpath_expr: str, key_name)`

å‡½æ•°è¯´æ˜ï¼šé€šè¿‡ xpath è¡¨è¾¾å¼ï¼Œä» XML ä¸­æå–å­—æ®µã€‚

å‚æ•°ï¼š

- input: å¾…æå–çš„ XMLï¼›
- xpath_expr: xpath è¡¨è¾¾å¼ï¼›
- key_name: æå–åæ•°æ®å†™å…¥æ–° keyã€‚

ç¤ºä¾‹ä¸€ï¼š

```python
# å¾…å¤„ç†æ•°æ®
       <entry>
        <fieldx>valuex</fieldx>
        <fieldy>...</fieldy>
        <fieldz>...</fieldz>
        <fieldarray>
            <fielda>element_a_1</fielda>
            <fielda>element_a_2</fielda>
        </fieldarray>
    </entry>

# å¤„ç†è„šæœ¬
xml(_, '/entry/fieldarray//fielda[1]/text()', field_a_1)

# å¤„ç†ç»“æœ
{
  "field_a_1": "element_a_1",  # æå–äº† element_a_1
  "message": "\t\t\u003centry\u003e\n        \u003cfieldx\u003evaluex\u003c/fieldx\u003e\n        \u003cfieldy\u003e...\u003c/fieldy\u003e\n        \u003cfieldz\u003e...\u003c/fieldz\u003e\n        \u003cfieldarray\u003e\n            \u003cfielda\u003eelement_a_1\u003c/fielda\u003e\n            \u003cfielda\u003eelement_a_2\u003c/fielda\u003e\n        \u003c/fieldarray\u003e\n    \u003c/entry\u003e",
  "status": "unknown",
  "time": 1655522989104916000
}
```

ç¤ºä¾‹äºŒï¼š

```python
# å¾…å¤„ç†æ•°æ®
<OrderEvent actionCode = "5">
 <OrderNumber>ORD12345</OrderNumber>
 <VendorNumber>V11111</VendorNumber>
</OrderEvent>

# å¤„ç†è„šæœ¬
xml(_, '/OrderEvent/@actionCode', action_code)
xml(_, '/OrderEvent/OrderNumber/text()', OrderNumber)

# å¤„ç†ç»“æœ
{
  "OrderNumber": "ORD12345",
  "action_code": "5",
  "message": "\u003cOrderEvent actionCode = \"5\"\u003e\n \u003cOrderNumber\u003eORD12345\u003c/OrderNumber\u003e\n \u003cVendorNumber\u003eV11111\u003c/VendorNumber\u003e\n\u003c/OrderEvent\u003e",
  "status": "unknown",
  "time": 1655523193632471000
}
```



