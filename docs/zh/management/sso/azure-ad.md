# Azure AD 单点登录示例
---

## 操作场景

Azure Active Directory （Azure AD） 是 Microsoft 推出的基于云的标识和访问管理服务，可帮助企业管理内外部资源。

观测云支持基于 SAML 2.0（安全断言标记语言 2.0）的联合身份验证，SAML 2.0 是许多身份验证提供商（Identity Provider， IdP）使用的一种开放标准。您可以通过基于 SAML 2.0 联合身份验证将 Azure AD 与观测云进行集成，从而实现 Azure AD 帐户自动登录（单一登录）观测云平台访问对应工作空间资源，不必为企业/团队单独创建观测云账号。


## 操作步骤

### 1、创建 Azure AD 应用程序

1）登录进入 [Azure Active Directory 管理中心](https://aad.portal.azure.com/)，点击**企业应用程序 > 所有应用程序 > 新建应用程序**。

![](../img/02_azure_01.png)

2）在**新建应用程序**页面，点击**创建你自己的应用程序**，在打开的页面输入**应用的名称**，并选择**非库应用程序**，点击**创建**，即可创建一个新的应用程序。

![](../img/02_azure_02.png)

### 2、为 Azure AD 应用程序配置 SAML {#step2}

???+ attention

    本步骤将 Azure AD 应用程序属性映射到观测云的属性，建立 Azure AD 和观测云之间的信任关系。

1）在新创建的应用程序，点击**单一登录**，选择 **SAML**。

![](../img/02_azure_03.png)

2）在**设置 SAML 单一登录**的第一步**基本 SAML 配置**部分，点击**编辑**。

![](../img/02_azure_04.png)

填入以下断言地址和实体 ID 示例。

- 标识符（实体 ID）：[https://auth.guance.com/saml/metadata.xml](https://auth.guance.com/saml/metadata.xml)
- 回复 URL（断言地址），临时使用：[https://auth.guance.com/saml/assertion](https://auth.guance.com/saml/assertion/)

???+ attention

    此次配置仅为获取下一步的元数据文档使用，需要在观测云中启用 SSO 单点登录后，获取到正确的**实体 ID** 和**断言地址**后重新替换。

![](../img/02_azure_05.png)

3）在**设置 SAML 单一登录**的第二步**属性和索赔**部分，添加关联身份提供商用户邮箱的声明，点击**编辑**。

![](../img/02_azure_06.png)

在属性和索赔编辑页面，点击**添加新的声明**。

![](../img/02_azure_07.png)

在管理声明页面，输入**名称**和**源属性**，并保存：

- 名称：必需填入 **Email**，此部分内容为必填项，如果不填，SSO单点登录时将提示无法登录；  
- 源属性：根据身份提供商实际邮箱选择“user.mail”。

???+ attention

    观测云定义了一个字段，必须填入 **Email** 用于关联身份提供商的用户邮箱（即身份提供商将登录用户的邮箱映射到 Email）。

![](../img/02_azure_08.png)

### 3、获取 Azure AD 元数据文档 {#step3}

???+ attention

    本步骤可获取在观测云创建身份提供商的元数据文档。

1）在**设置 SAML 单一登录**的第三步 **SAML 签名证书**部分，点击下载**联合元数据 XML**。

![](../img/02_azure_09.png)


### 4、在观测云启用 SSO 单点登录

1）启用 SSO 单点登录，在观测云工作空间**管理 > 成员管理 > SSO 管理**，点击**启用**即可。

> 可参考文档 [新建 SSO](../../management/sso/index.md) 。

???+ attention

    基于账号安全考虑，观测云支持工作空间仅配置一个 SSO，若您之前已经配置过 SAML 2.0，我们默认会将您最后一次更新的 SAML2.0 配置视为最终单点登录验证入口。

![](../img/1.sso_enable.png)

2）上传在[步骤 3](#step3)中下载的**元数据文档**，配置**域名（邮箱的后缀域名）**，选择**角色**，即可获取该身份提供商的**实体ID**和**断言地址**，支持直接复制**登录地址**进行登录。

???+ attention

    域名用于观测云和身份提供商进行邮箱域名映射来实现单点登录，即用户邮箱的后缀域名需和观测云中添加的域名保持一致。

![](../img/1.sso_enable_2.png)


### 5、在 Azure AD 替换 SAML 断言地址

1）返回 Azure AD，更新[步骤 2](#step2)中的**实体 ID** 和**断言地址**。

???+ attention

    在观测云配置单点登录时，身份提供商 SAML 中配置的断言地址必须和观测云中的保持一致，才能实现单点登录。

![](../img/02_azure_17.png)


### 6、配置 Azure AD 用户

???+ attention

    本步骤配置在观测云创建身份提供商的授权用户邮箱账号，通过配置的 Azure AD 用户邮箱账号可单点登录到观测云平台。

1）在新创建的应用程序，点击**用户和组**，点击**添加用户/组**。

![](../img/02_azure_10.png)

2）点击**未选择任何项**，在弹出的页面搜索并选择用户，点击**选择**。

![](../img/02_azure_11.png)

3）选择完用户以后，返回到**添加分配**，点击**添加分配**。

![](../img/02_azure_12.png)

4）添加完用户以后，可以在**用户和组**查看分配的 SSO 授权登录用户列表。

![](../img/02_azure_13.png)

???+ attention

    若无用户，可在**用户**菜单下新建用户。

![](../img/02_azure_14.png)


### 7、使用 Azure AD 账号单点登录观测云

1）SSO 配置完成后，通过 [观测云官网](https://www.dataflux.cn/) 或者 [观测云控制台](https://auth.dataflux.cn/loginpsw) 登录，在登录页面选择**单点登录**。

![](../img/02_azure_18.png)

2）输入在创建 SSO 的邮箱地址，点击**获取登录地址**。

![](../img/02_azure_19.png)

3）点击**链接**打开企业账号登录页面。

![](../img/02_azure_20.png)

4）输入企业通用邮箱（在 Azure AD 和观测云 SSO 管理中配置的企业邮箱地址）和密码。

![](../img/02_azure_21.png)

5）登录到观测云对应的工作空间。

???+ attention

    若多个工作空间同时配置了相同的身份提供商 SSO 点单登录，用户通过 SSO 单点登录到工作空间后，可以点击观测云左上角的工作空间选项，切换不同的工作空间查看数据。

![](../img/02_azure_22.png)


