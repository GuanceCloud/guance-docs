# 告警策略
---

一旦[监控器](./monitor/index.md)检测到异常情况，观测云会依据预设的告警策略向相关对象发送通知，以便及时发现并解决监测到的异常数据问题。

???+ warning "系统默认的告警策略"

    - 每个监控器创建时必须选择一个告警策略，默认选中**默认**；   
    - 当某个告警策略被删除时，删除告警策略下的监控器将自动归类到**默认**下。

## 新建告警策略 {#create}

1. 定义当前告警策略的名称；
2. 选择通知时区，默认显示当前的[工作空间时区](../management/index.md#workspace)。若拥有者或管理员未配置，则默认填充 `东八区` 时区；
3. 选择基于[等级](#notice-config)或成员配置触发通知的告警策略；
4. 选择重复告警（原告警沉默）。即，若同一个事件不是非常紧急，但是告警通知频率高，可以通过设置重复告警通知的时间间隔这一方式来减少告警通知频率；
5. 选择[告警聚合](#pattern)，将决定告警通知的最终聚合形式；
6. 点击保存，即可创建成功。


???+ warning "注意"

    1. 设置重复告警通知后，事件数据会继续产生，但是不会再发送告警通知，产生的数据记录会存入[事件](../events/index.md)查看器。
    2. 若选择【永久】这一重复告警选项，观测云仅发送首次告警通知，后续不再重复发送。

### 基于等级的通知配置 {#notice-config}

#### 简单模式 {#simple}

直接定义各个等级的告警发送通知对象。

<img src="../img/notice-config.png" width="90%" >

:material-numeric-1-circle-outline: [事件等级](monitor/event-level-description.md)：包括**紧急、重要、警告、数据断档、信息、全部**。

- 一种事件等级可选择多次； 
- 基于选定的事件等级，您可以联动[告警聚合](#pattern)进行告警通知。

:material-numeric-2-circle-outline: 通知对象：针对单个异常等级，配置通知对象；通知对象可选择单个或多个。

| <div style="width: 210px">类型</div>      | 说明      |
| ----------- | ---------------- |
| 空间成员      | 邮件通知；可前往管理 > 成员管理查看。      |
| 团队      | 邮件通知；一个团队可添加多个空间成员，可前往管理 > 成员管理 > 团队管理查看。      |
| 邮件组      | 邮件通知；一个邮件组可添加多个团队，可前往监控 > 通知对象管理查看。      |
| 钉钉/企业微信/飞书机器人      | 群通知；可前往监控 > 通知对象管理查看。      |
| Webhook 自定义      | 用户自行设定；可前往监控 > 通知对象管理查看。      |
| 短信      | 短信通知；一个短信组可以添加多个空间成员，可前往监控 > 通知对象管理查看。<br />观测云体验版无短信通知，其他版本短信通知 0.1 元 / 条，按天计费，没有免费额度。      |
| 自定义外部邮箱      | 输入邮箱回车即可；仅支持商业版和部署版用户。      |


???+ warning "恢复通知与通知延迟"

    - 恢复通知：当历史发送的异常告警事件恢复后，观测云会发送恢复通知到对应通知对象。例如：给某个群发送过相关事件的`紧急`通知，当这一状态开始恢复时，会向此群发送恢复通知。  
    - 通知延迟：告警通知并非产生后立即发送，会因为数据入库等问题存在最多 1 分钟的延迟。

#### 添加过滤条件 {#filter}

当面临复杂的告警配置场景，单一的[等级对应通知对象](#simple)的方式可能不足以满足需求。在这种情况下，您可以在等级的基础上追加特定的过滤条件。这样，只有**同时满足等级要求和过滤条件的事件才会触发对应的通知对象**，从而实现更加精细的异常事件通知管理。


<img src="../img/rule-1.png" width="90%" >


点击过滤按钮后，观测云自动获取当前工作空间的字段，以 `key:value` 的形式通过**等于、不等于、通配、通配取反和正则匹配**的方式设置过滤条件。相同 `key` 字段的多个过滤条件之间为 OR 的关系，不同 `key` 字段的过滤条件之间为 `AND` 的关系。

您不仅可以直接在页面上选择字段进行配置，还可以通过编写正则表达式来设定更复杂的筛选条件，从而实现更精细的配置。

**注意**：每条告警规则下仅能添加一组过滤条件，一组条件中可包含一条/多条过滤规则，过滤规则相结合进行条件的筛选。  


#### 告警升级通知 {#upgrade}


如果监控器在短时间内多次检测到相同等级的异常，这可能表明存在一个持续的问题。为了避免发送过多重复通知，您可以设置通知规则，当异常持续发生时，自动升级为一条紧急通知，并发送给指定的接收者，确保问题得到迅速关注和处理。

<img src="../img/upgrade-notice.png" width="70%" >

若一条通知规则配置了两个升级，则：

- 如果相同级别的告警持续产生，观测云会检查时间间隔，确定是否需要发送升级通知；
- 发送完首次升级通知后，观测云会根据第二条升级通知配置的时间间隔，判断是否需要再次发送升级通知。

**注意**：

- 每条规则最多配置 2 个升级通知；
- 每个升级通知只会触发一次，不会存在重复告警的情况。




#### 自定义通知时间 {#custom}

以上讨论的场景主要围绕在检测到异常时自动触发通知的即时性。但实际上，您也可以根据需要，自行设定通知发送的具体时间。

<img src="../img/notice-config-1.png" width="70%" >


1. 可按需修改配置名称；
2. 依据天、周、月及自定义这四个维度来划分事件所在的周期；

    - 若选择自定义，需上传 CSV 文件，观测云会根据文件内的填写日期自动填充。文件内日期格式需为 `年/月/日` & `YYYY/MM/DD`；文件内日期数量最多不超过 365 个。

3. 根据周期来限定当天事件产生的时间，并按照选定的时间区间发送通知，如选定 `09:00 - 10:00`，当策略生效，在这一个小时内产生的异常事件会匹配流入这一则自定义配置；

4. 完成周期、时间相关的配置，即可选择告警级别与通知对象。



**注意**：

- 在同一个告警策略的单条自定义通知配置中，若配置了多条规则，产生的异常事件会按照由上到下的顺序进行匹配，并会按照优先匹配的自定义配置发送告警通知。若一直未匹配到规则，则不会发送通知。

- 在配置监控器时，当[选择多个告警策略](./monitor/mutation-detection.md#alert)，监控器开启后，产生的异常事件会分别匹配选定的告警策略。

### 基于成员的通知配置 {#member}

基于成员配置通知规则，可以实现精准的点对点告警通知，从而有助于迅速响应异常事件。在这一配置项下，选定成员

1. 选定需要通知到的成员和团队；
2. 添加过滤条件；
3. 针对不同的等级，设定对应的通知对象。如需必要，还可针对该等级[配置升级通知](#upgrade)；
4. 您可按需开启[自定义通知时间范围](#custom)的配置。


### 告警聚合 {#pattern}

:material-numeric-1-circle-outline: 不聚合：默认配置；在该模式下，告警事件会按照每 20 秒时间间隔合并为一封通知发送至对应通知对象；

:material-numeric-2-circle-outline: 规则聚合：在该模式下，您可以选择以下四种聚合规则并基于聚合周期来发送告警通知：


| <div style="width: 150px"> 聚合规则 </div>     | 说明      |
| ----------- | ---------------- |
| 全部      | 基于告警策略配置的等级维度，在所选的聚合周期内生成对应的告警通知。      |
| 监控器/智能巡检/SLO      | 按照监控器、智能巡检的检测规则或 SLO 的唯一 ID，联动聚合周期生成对应的告警通知。      |
| 检测维度      | 按照检测维度联动聚合周期生成对应的告警通知，例如 `host`。      |
| 标签      | 可多选；可通过[全局标签](../management/field-management.md)联动[监控器](./monitor/index.md#tags)，按照聚合周期生成对应的告警通知。<br />:warning: 若事件同时存在多个标签值，则按照页面配置的标签顺序优先命中到对应的告警通知，多个标签值的关系为 OR。    |

:material-numeric-3-circle-outline: 智能聚合：在该模式下，聚合周期内产生的事件将根据选中的`标题`或`内容`聚类分组，每个分组产生一条告警通知。


#### 聚合周期

在规则聚合和智能聚合的模式下，您可以选择手动设置一个时间范围（1-30 分钟内）。

<img src="../img/alert-1.png" width="70%" >

在这个时间段内，新增的事件会被聚合成一条告警通知发送。如果超出这个聚合周期，新增的事件将会被聚合到新的告警通知中。
 

## 更多阅读

<font size=2>

<div class="grid cards" markdown>

- [<font color="coral"> :fontawesome-solid-arrow-right-long: &nbsp; **管理告警策略列表**</font>](./config-alert-setting.md)

</div>

<div class="grid cards" markdown>

- [<font color="coral"> :fontawesome-solid-arrow-right-long: &nbsp; **告警策略：更精细化的通知对象配置**</font>](./alert-strategy.md)

</div>

</font>

