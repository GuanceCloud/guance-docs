# 生成指标使用实战
---

## 概述

不同的企业用于分析产品质量、用户体验、业务价值的角度和方法各有不同，然而标准的采集器却满足不了各式各样的可观测需求。一个能够自定义生成指标的功能，能够让采集器收集上来数据更贴合您的需求，通过跟踪这些数据，您还可以生成灵活且一目了然的自定义报告，以实时观测这些对您而言最为重要的指标

观测云的生成指标的功能，可以用于收集、整合和分析采集器不会自动跟踪的数据，支持基于当前空间内的现有数据生成新的指标数据，以便于您依据需求设计并实现新的技术指标。

- 假如您是“电商平台”的开发者，"搜索PV"、“搜索UV”或“空结果PV”可能比屏幕浏览量等预定义的指标更贴合您的需求，启用生成指标的功能，可以帮助您最优化观测指标。
- 假如您在“测试执行”中追踪了全部日志，启用自定义生成指标的功能可以帮助您将日志作为错误报告的一部分同时提交。
- ...

## 前置条件

您需要先创建一个 [观测云账号](https://www.guance.com)，并在您的主机上 [安装 DataKit](../../datakit/datakit-install.md)，开启相关集成的运行，进行数据采集。

## 自定义指标

肯定有那么一个指标，您一直以来都想要，但偏偏标配包里就是没有。当您对系统默认提供的指标不满意时，观测云的生成指标功能支持引入新的指标，简单进行三个步骤即可：

- 数据筛选：在观测云平台选定已有的全部/单个应用数据来源，并基于此数据源开始生成新的数据；  
- 数据查询：基于选定的数据源，您可以对现有数据进行筛选、重新聚合（Avg（取平均值）、Min（取最小值）、Max（取最大值）、Count（取数据点数）、p75、p95、p99等），请求产生新的指标结果和数据集合；  
- 生成指标：对生成指标的方式进行设置，包括生成指标的周期、新生成指标的名称和指标集名称。

![](../img/1.generate-metrics_1.png)

## 示例


让我们以“生成测试结果报告”为例，使用测试日志中的信息<u>了解项目状况，产品质量等</u>。进行系统测试时，测试日志会通过观测云采集器 DataKit 实时上传至 观测云工作台，并命名为 `http_dial_testing` 的日志数据源。

在工作台中，通过**日志**功能可查询到该日志源的全部测试日志。

![](../img/1.generate-metrics_2.png)

测试结果报告显示以下详细信息：

- 项目名称：当前项目的名称；  
- 测试类别：测试对象的名称, "name"="bing"；  
- 失败数量：当前测试对象 "status"="fail" 的日志数量；  
- 成功数量：当前测试对象 "status"="ok" 的日志数量。

| **测试报告** |  |
| --- | --- |
| 项目名称 | http_dial_testing |
| 测试类别 | bing |
| 状态（ok) |  123 |
| 状态（fail） |  123 |

### 如何筛选数据范围

通过数据来源和标签过滤可以筛选出您需要的数据范围。在收集了命中数据并将其发送到观测云后，以 “项目名称” 为筛选，您可以在**数据筛选**中，选定**来源**为 `http_dial_testing` 以匹配数据范围。

![](../img/1.generate-metrics_3.png)

### 如何进行数据处理

基于选定的数据源，您可以对现有数据添加筛选和聚合表达式，请求产生新的指标结果和数据集合。当前测试对象的成功数量，可以通过筛选出 `"name"="bing"`，默认时间粒度为15分钟，对 `"status"="ok"` 的日志数量以 Count（取数据点数）聚合。

![](../img/1.generate-metrics_4.png)

### 生成指标配置

通过生成指标，可以对生成指标的方式和结果进行设置，包括生成指标的周期、指标名称和指标集名称。默认 1 分钟，即每 1 分钟生成一次新的指标数据；设定指标集为 `"test_ok"`；设定指标为 `"count_ok"`。

![](../img/1.generate-metrics_5.png)

点击**确定**即可完成生成指标规则并开启数据采集。

![](../img/1.generate-metrics_6.png)

### 报告

在数据处理完成后，您可以依据新生成的指标，生成测试报告。

![](../img/1.generate-metrics_7.png)

如您需要对其他自定义字段进行可视化观测，您还可以将指标以列表、时序图、饼图、地图等其他方式。

![](../img/1.generate-metrics_8.png)