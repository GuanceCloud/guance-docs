# 如何通过查看器实现数据分析

本⽂旨在帮助读者了解什么是查看器以及如何使⽤查看器实现数据的查询与分析。

## 概述

在观测云平台中，采集上来的数据都会汇总在查看器中供用户去查询与分析，每种类型的数据都有对应的查看器，例如：日志查看器、链路查看器、主机查看器等。

查看器支持多种搜索筛选方式，提供了丰富的看板及分析图表，可以帮助您快速、精准的检索数据，定位故障问题。

## 查看器的组成部分

查看器整体由七部分组成，分别是【搜索过滤】【快照】【状态统计分布图】【快捷筛选】【筛选历史】【数据展示区】【数据详情页】

![](../img/explorer_form.png)

接下来通过讲解`如何配置查看器`以及`如何进行数据分析`，让大家了解每部分的作用。

## 如何配置数据查看器

观测云针对每类数据都提供了一套标准查看器，考虑到每个用户的需求不同，支持根据实际场景进行调整。在配置之前，首先要从数据的类型和特性出发，构思当前数据的哪些属性和视图是我们需要重点关注的。

1）可以将重点关注的字段添加在【快捷筛选】和【显示列】中，以达到快速过滤和查看的目的。例如：

- 可以将`host`、`service`添加到日志查看器的【显示列】中，以便在列表中就能快速了解日志对应的主机和服务，不需要一个个点击详情页中查看；
- 当需要经常通过文件目录查找日志时，可以在【快捷筛选】中添加` filepath `字段，以便可以在左侧快速筛选目标数据；

![](../img/filter.png)

2）可以将重点关注视图通过字段进行关联绑定，这样当数据中包含绑定字段时，就可以看到对应的监控视图，轻松实现关联分析。例如：

- 我在【用户视图】中创建了一个监控视图。通过`service:mysql`绑定该视图与查看器。后续只要数据中存在`service:mysql`的属性，详情页中就会显示该监控视图；

![](../img/associated_views.png)

???+ tip

    1.查看器个性化配置都缓存在个人本地，其他成员是看不到的，若更换浏览器或清空缓存，查看器会恢复官方默认配置。

    2.若想要所有成员都可以看到你配置的查看器，可以使用场景目录下的【查看器】功能，支持基于不同的数据范围创建自定义查看器，查看器可以公开或仅自己可见。

## 数据查询与分析

### 数据过滤

在查看器中我们可以通过调整时间范围、搜索关键字、字段筛选等方式过滤出我们想要的数据。

#### 1. 时间过滤

通过【时间组件】可以控制数据查询的时间范围，提供多种时间的快速选择，还支持手动输入时间区间。

???+ tip

    1.查询 “相对时间” 直接输入正确格式的缩写即可，例如：查询【最近12小时】的数据，只需输入`12h`，按回车键确定。

    2.查询 “绝对时间” 直接输入日期格式/时间戳格式的`开始时间`和`结束时间`进行搜索即可。

![](../img/time_control.png)

#### 2. 内容过滤

查看器中提供丰富的搜索和筛选方式，可以帮助我们快速过滤数据。

**关键字搜索**
 
查看器支持【精准搜索】【通配符搜索】【关联搜索】【JSON 搜索】四种搜索方式。

| 类型 | 示例    | 说明    |
|  ----  | --------|--------|
| 精准搜索 | info | 精准检索 message 中包含单词 info 的数据。<br />注意：info 需要是一个独立的单词，举例：<br />可以搜到  [...update field <font color="#dd0000">info</font> ...]<br/>搜索不到 [...v3/<font color="#dd0000">info</font>rmers...] [...Received Get<font color="#dd0000">info</font> call...] |
| 通配符搜索（模糊搜索） | \*info\* | 只要 message 中包含字母 info 就可以被检索到，举例：<br/>[...update field <font color="#dd0000">info</font> ... ] [...v3/<font color="#dd0000">infor</font>mers...] |
| 关联搜索 | info AND token<br />info OR token<br />NOT info* | 检索 message 中同时包含单词 info 和单词 token 的数据 <br/>检索 message 中包含单词 info 或单词  token 的数据<br/>检索 message 中不包含以 info 为开头单词的数据|
| JSON 搜索 | @method:GET | 检索 message 中包含 "method" :"GET" 的数据，举例：<br/>{...,"method":"GET","level":"info",...} |


???+ tip

    JSON 搜索使用有如下几个前提：

    1. 工作空间在2022年6月23日之后创建

    2. 只支持日志查看器使用

    3. Message 文本格式为 JSON ，而非 TXT

**字段筛选**

查看器支持【正/反精准匹配】【正/反模糊匹配】【判断字段存在/不存在】【数值区间匹配】，其中反向筛选只需在字段名前加符号` - `，模糊匹配只需要在字段名前面加` * `，如下表格所示：

| 类型 | 示例    | 说明    |
|  ----  | --------|--------|
| 正向精准匹配 | [source:nginx]  | 筛选 source 等于 nginx 的数据  |
| 反向精准匹配 | [-source:nginx]  | 筛选 source 不等于 nginx 的数据  |
| 正向模糊匹配 | [\*source:\*nginx]   | 筛选 source 值中以 nginx 为开头的数据  |
| 反向模糊匹配 | [-\*source:\*nginx\*]   | 筛选 source 值中不包含 nginx 的数据  |
| 判断字段存在 | [host:*]    | 筛选存在 host 属性字段的数据  |
| 判断字段不存在 | [-host:*]   | 筛选不存在 host 属性字段的数据  |
| 数值区间匹配 | [duration:>100]    | 筛选 duration 值大于 100 的数据  |
| 数值区间匹配 | [duration:<=1000]   | 筛选 duration 值小于等于 1000 的数据  |

#### 3. 筛选历史

所有使用过的筛选条件都会被记录到筛选历史中，支持将常用筛选条件置顶显示。筛选历史不区分查看器类型，这使得我们可以跨查看器快速添加筛选条件进行问题排查。

**使用场景举例：**当我们需要来往日志、链路查看器排查问题，并且要添加很多相同的筛选条件过滤数据。这时我们可以先在日志查看器筛选，然后切换到链路查看器打开筛选历史一键添加即可，减少很多不必要的重复操作。

![](../img/filter_history.png)

### 数据分析

查看器内置了一些统计图表可以助力于我们进行数据分析，例如，日志查看器中有【状态统计分布图】，链路查看器中有【请求数】【响应时间】等图表。

查看器还支持基于数据的标签属性作为分析维度，通过可视化图表的形式展现在不同分组下数据的分布特征与走势。当前支持四种图表类型，分别是【时序图】【排行榜】【饼图】【矩形树图】。

![](../img/analysis.png)

点击数据行展开侧滑详情页，在这里你可以看到更多的数据信息。查看器为每种类型的数据都配置了最佳查看面板，展示关键性指标。还有超多关联视图，可以从多维度进行数据分析。因数据类型较多，下面以【日志】【链路】【主机】【用户访问】为例进行讲解。

=== "日志"

    日志详情中可以查看完整的日志信息以及全部属性字段。若日志中包含`host` `container_name` `pod_name`这些字段，还可以查看对应的主机/容器/Pod监控视图实现关联分析。

    >使用场景举例：当发现某个页面报了404错误，在查看器中查询相关服务的错误日志详情，关联视图中发现几乎同一时间主机内存使用量急剧攀升，推断可能由于内存溢出导致该错误。
    
    ![](../img/log.png)

=== "链路"

    链路详情中可以通过【火焰图】【Span列表】【服务调用关系】帮你从不同角度分析数据，找出问题原因。

    1) 火焰图：通过火焰图可以追踪完整的链路信息，以一个全局的视野查看每个 Span 的时间分布，它会从顶部往底部列出所有可能导致性能瓶颈 Span。

    2)Span 列表：以 Service 为分类列出所有 Span，以及其在整条执行链路中的持续时间、执行时间、执行时间占比。

    3)服务调用关系：绘制当前链路下所有服务之间的关系拓扑，可以清晰看到每个资源的上下游服务调用关系，以及对应服务的执行时间和执行占比。

    除以上内容外，还可以看到链路的所有属性信息、相关日志列表、代码热点分析、以及关联视图，支持从多维度进行数据分析
    
    ![](../img/trace.png)

    ![](../img/trace_service.png)

=== "主机"

    主机详情中可以看到主机系统信息、云厂商信息、DataKit 版本、集成的运行情况。支持一键查看主机监控视图、相关日志、进程、事件、网络等，帮助你全方位了解主机信息及其相关衍生。
    
    ![](../img/host.png)

    ![](../img/host_metric.png)

=== "用户访问"

    在用户会话期间自动收集和关联每个资源、页面、错误以及用户操作，根据数据来源不同划分为六个查看器（Session/View/Resource/Action/LongTask/Error）

    1）Session 维度：记录会话期间的一系列详情，包括访问时间、访问页面路径、访问操作数、出现的错误信息等等。可视化用户访问应用的浏览体验，直观了解用户的操作行为。

    ![](../img/rum_session.png)

    2）View/Resource/ActionLongTask 维度：记录页面内所有资源、操作、错误的发生时间以及加载耗时，了解用户操作导致后端应用一系列调用链的性能指标情况。支持查看关联错误、关联日志和 Fetch/XHR（向后端应用发出的每一个网络请求，包括发生时间、请求的链路、状态码和持续时间）

    ![](../img/rum.png)

    3）Error 维度：支持查看完整的错误详情以及错误分布图，记录该错误发生的时间分布以及次数。
    
    >使用场景举例：当某个页面经常加载缓慢发生卡顿，可以查看页面`View`，分析页面元素的加载耗时，查看是否有错误产生，可以迅速将问题定位于网络、服务、资源、乃至代码行。
    
    ![](../img/rum_error.png)


## 查看器快照与分享

观测云支持保存某一时刻的查看器为快照，会自动保存当时页面的筛选条件、显示列、分析维度等信息，可以帮助我们快速复现当时的数据查询结果及显示页面，减少每次的重复操作。

同时支持将保存的快照分享给他人，基于安全性考虑，可以设置公开和密码两种分享方式，并支持配置分享链接的有效期。

**使用场景举例：** 通过日志排查问题时，可能会添加很多筛选及搜索条件才能过滤出我们想要的数据。将搜索结果页面保存为快照，方便后面快速复看。还可以将快照分享给负责人，负责人通过访问链接一键查询问题日志，省去了很多操作步骤与不必要的沟通。

![](../img/snapshot.png)