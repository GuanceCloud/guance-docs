# 跨工作空间索引查询
---

???+ warning "写在前面"

    为了集中管理、检索和分析各类[日志](./explorer.md)，观测云可以通过采集日志把日志数据统一上报到观测云工作空间，通过日志查看器来查看、检索工作空间内全部的日志内容，实现更全面的日志数据分析。

    同时，观测云平台提供了[索引](./multi-index.md)功能。其为日志数据定义了分类规则，使用户能够通过不同的索引保存和存取日志，并按需数据存储策略，有效控制存储成本。

## 为什么需要跨空间获取索引？

:material-numeric-1-circle: 功能特征：

从前文中，不难获取到关于索引和日志的从属性特征：日志和索引都是针对**所属的工作空间**而言的。日志**存储在工作空间内**，索引是**针对该空间内的日志数据创建的特殊分类和存储规则**。

:material-numeric-2-circle: 业务难题：

企业出于各团队成本计算或数据资源权限控制等需求，往往会在观测云新建多个工作空间做数据管理。此种模式下虽然实现了各部门数据分管的场景，但是不利于做数据全局分析。

:material-numeric-3-circle: 跨空间获取索引的必要性：

基于数据分管下进行数据全局分析的需求，观测云提供了跨工作空间查询的功能，可以获取到其它空间的日志数据。

具体来说，由于日志按照索引分类，将“工作空间 1” 的索引数据授权给“工作空间 2” 后，就可以在“工作空间 2” 的日志查看器中，获取到“工作空间 1” 的索引，从而可查看到对应索引下的日志数据。

这一功能突破了日志数据存储位置的限制，能大幅度提升数据分析和故障定位的效率。

![](img/cross-workspace-index-6.png)

## 开始操作

> 场景示例：若将“工作空间 1” 的索引数据授权给“工作空间 2”，对于“工作空间 2” 来说，可调用的索引分两类：

- [当前工作空间原有的索引](#original)；
- [其它工作空间授权的索引](#others)。

### 查询本工作空间原索引 {#original}

进入“工作空间 2” 的日志查看器，左上角的“工作空间栏”默认选择当前工作空间。

左侧快捷筛选处列出本工作空间原有的所有可用索引，分别为：默认索引、日志索引、外部索引。

**注意**：外部索引为单选。

<img src="../img/cross-workspace-index.png" width="70%" >



### 查询其它工作空间授权的索引 {#others}

> 如“工作空间 2” 需要调用“工作空间 1” 的索引数据，要进行跨工作空间的索引授权分两步：

1. 在需要操作授权的工作空间（工作空间 1）进行对应的日志项及索引的授权；
2. 进入被授权的工作空间（工作空间 2）选取索引项进行应用。

> 具体操作细节，可参考 [跨工作空间授权](../management/data-authorization.md#site)。

当完成了上面两个步骤，即已经完成了“工作空间 1” 对“工作空间 2” 的索引授权，此时进入被授权的工作空间---**“工作空间 2” > 日志查看器**。

#### 选择工作空间

点击**工作空间**下拉框，可查看所有可选的工作空间。此处支持单选/多选。

???+ warning "注意"

    1. 此处的工作空间可选列表只列出满足三种情况的工作空间：属于同集群；已完成授权操作；授权的数据范围包含日志数据。
    2. 单选某个空间，会在工作空间栏直接显示出所选工作空间的名字；选择多项工作空间时，会显示为：已选 n 项，点开可查看具体选项。


![](img/cross-workspace-index-1.png)


#### 选择索引

选定工作空间后，该工作空间下的索引会在**快捷筛选**处同步列出：

???+ warning "注意"

    1. 外部索引不支持做跨工作空间查询。只有在选择当前工作空间时，才能使用外部索引。如果选择了其他工作空间，外部索引将不可用。
    2. 日志索引默认选择 `default`，当选择多个工作空间时，多空间下的所有默认索引会分到同一个 `default` 索引下。
    3. 跨工作空间授权的索引，只同步列出授权范围内的可用索引。


### 分析日志数据

**注意**：跨工作空间索引查询**只影响日志数据的获取渠道**，其他日志分析功能**不受影响**。

在日志查看器中进行了工作空间、索引的选取后，可正常使用日志查看器的原有功能，例如搜索、快捷筛选、状态图显示及分析等。

### 删除索引

如删除工作空间 1 下的索引 `whytest`，由于该索引已经授权给别的空间，在删除时会弹出确认提示，点击**确定**删除索引。

一旦确认删除，这一变更将即时影响到“工作空间 2”，相应的索引将不可用。

![](img/cross-workspace-index-2.png)

## 常见问题

:material-chat-question: 工作空间 1 的索引授权给工作空间 2 后，需要取消授权，如何操作？

撤销索引的授权分以下两种情况：

<!--

“工作空间 1” 对“工作空间 2” 撤销所有索引授权、只撤销某几个索引授权。

1）撤销全部索引授权

若“工作空间 1” 下的所有索引都不需要再提供给“工作空间 2” 进行调用，可直接在“工作空间 1”的空间授权列表处删除此项授权。

-->

:material-numeric-1-circle: 授权范围仅有日志数据

只授权了日志，可直接在授权列表点击**删除**，即可撤销对“工作空间 2” 的全部索引项授权。

![](img/cross-workspace-index-3.png)

:material-numeric-2-circle: 授权范围包含别的数据

若授权范围包含除日志以外的其他数据类型，可点击**编辑**，将日志项从授权范围中删除。

**注意**：

- 数据范围中删除日志后，日志索引输入域也会同步关闭。
- 索引删除后，相当于删除日志数据的授权。也就意味着“工作空间 1” 的所有日志数据和“工作空间 2” 不互通，“工作空间 2” 的日志查看器中选择工作空间时将无法选到“工作空间 1”。

![](img/cross-workspace-index-4.png)

<!--
:material-numeric-3-circle: 通过撤销授权

若“工作空间 1” 下只有某项或者某几项索引不需要再提供给“工作空间 2”进行调用，可在“工作空间 1” 的空间授权处，对索引项重新进行编辑。

![](img/cross-workspace-index-5.png)


3）撤销索引授权效果

1）索引全部删除：相当于删除日志数据的授权，意味着“工作空间 1” 的所有日志数据和“工作空间 2” 不互通，“工作空间 2” 的日志查看器中选择工作空间时无法选到“工作空间 1”；

2）索引部分删除：“工作空间 2” 的日志查看器中，工作空间正常选择，删除授权的索引不可见，可正常选择最终保留的索引。
-->

:material-chat-question: 操作授权索引正常，但是在被授权工作空间的日志查看器中无法查询到此索引。

1）进入**授权工作空间 > 日志 > 索引**，确认此索引状态是否正常，是否已被删除。

2）进入授权工作空间，点击**管理 > 跨工作空间授权**，查看索引授权是否正常。

被删除的索引无法在跨工作空间查询中被引用。



:material-chat-question: 如何查询其他工作空间的外部索引？

首先需界定，外部索引是从[外部渠道（SLS Logstore 、Elasticsearch、OpenSearch）](./multi-index.md)绑定到观测云平台的。

因此需要使用什么外部索引，直接绑定此外部索引到本工作空间下即可，使用时在日志查看器选择默认的当前工作空间，选取对应外部索引进行查询即可。