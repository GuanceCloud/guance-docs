# 备份日志
---

## 简介

观测云提供日志备份的功能，筛选符合条件的日志进行备份，通过调整备份日志的存储策略，延长备份日志存储时间，帮助用户查看和分析历史日志数据。

> 观测云支持通过 [DataFlux Func](https://func.guance.com/doc/intro-guide/) 备份日志到外部存储，具体示例可参考文档[日志数据备份到 OSS 最佳实践](../best-practices/partner/log-backup-to-oss-by-func.md)。

## 前提条件

观测云商业版用户可使用日志备份功能，[体验版](../billing/trail.md)用户可先[升级商业版](../billing/commercial-version.md)。

## 新建备份

进入**日志 > 备份日志**页面，点击**备份管理 > 新建规则**。

![](img/5.log_backup_1.png)

![](img/back-5.png)

???+ info "备份管理" 

    - 日志备份规则创建完成后，每 5 分钟执行一次规则校验并进行备份，即配置备份规则最多 5 分钟后即可查看备份的日志数据；  
    - 备份日志数据最低存储 180 天，备份规则一旦创建无法取消，存储期间会每天收取费用。

### 输入规则名称

在弹出的对话框，输入**规则名称**即可添加一条新的规则，

| 字段      | 描述     | 
| ------------- | -------------- |
| 规则名称 | 限制最多输入 30 个字符。 |
| 同步备份扩展字段      | 默认仅备份 message 内容到备份日志，若勾选此选项，将备份符合筛选条件的整条日志数据。     |

### 定义过滤条件

过滤条件支持自定义条件间的运算逻辑，您可以选择**所有条件**、**任意条件**：

- 所有条件：匹配所有过滤条件都满足的日志数据才会被保存到备份日志；

- 任意条件：任意一个过滤条件满足即可被保存到备份日志。

???+ attention

    不添加过滤条件即表示保存全部日志数据；您可以添加多条过滤条件。

条件运算符见下表：

| 条件运算符      | 匹配类型     | 
| ------------- | -------------- | 
| in 、not in      | 精确匹配，支持多值（逗号隔开） | 
| match、not match | 模糊匹配，支持输入正则语法 | 

![](img/back-1.png)

### 选择存档类型

![](img/back-4.png)

#### 观测云

1、存档类型默认选中**观测云**，即表示匹配到的日志数据将被保存到观测云提供的存储；

???+ attention

    - 若当前工作空间未曾配置过备份规则，您可以在规则中选择数据保存策略；  
    - 若存在过历史备份规则配置，则仅显示当前存储策略，您可以前往**管理 > 设置 > 变更数据存储策略**中修改备份日志存储策略。
    
    ![](img/backup.png)

2、选择备份日志的数据存储时长。

> 观测云不同类型数据的数据保存策略支持自定义选择，更多备份日志的数据存储详细信息可前往[参考](../billing/billing-method/data-storage.md)。

3、点击**确定**，弹出确认框，进行创建规则的二次确定。

![](img/back-6.png)

<!-- 

#### AWS S3 {#aws}

<font color=coral>**注意：**</font>备份到 AWS S3 的备份日志<u>暂时还不支持在观测云的查看器中查看，您需前往对应的 AWS S3 中查看备份的历史日志数据</u>。

1、存档类型选择 AWS S3，即表示将匹配到的日志数据保存到 S3 对象存储中；   
2、选择访问类型： 

=== "角色授权"

    ![](img/back-2.png)

    您需使用观测云默认生成的外部 ID 配置 AWS 资源第三方访问权。
    
    [在 AWS 中配置观测云 IAM 角色](./role-auth.md)后，填写存档信息，输入 AWS 账号 ID、AWS 角色名称及 Bucket 名称。

    点击**测试连接**，若上述信息满足规范，则提示测试连接成功；
    
    若未通过测试，您需确认：

    - 外部 ID 是否失效；  
    - 账号 ID 是否正确；  
    - 账号角色是否存在；  
    - 存储桶是否存在；  
    - Region 是否不一致。  

    <font color=coral>**当出现这种情况时，需谨慎操作：**</font>
    
    - 当前日志备份规则与外部存储（S3）已完成互通且开始生效，若您重新点击了生成外部 ID，旧的外部 ID 将保留 24 小时，在此期间新旧外部 ID 同时共存生效，为您规则下的数据提供缓冲期。旧 ID 到期作废。
    
    - 不要多次点击生成外部 ID，请谨慎操作！

=== "Access Keys"

    ![](img/back-3.png)

    点击下载 AWS 资源授权模板，[前往 AWS 中配置观测云 IAM 策略](./ak-auth.md)。

    配置完成后，填写账号信息，输入 AWS 账号 ID、AWS AK & SK 及 Bucket 名称。

    点击**测试连接**，若上述信息满足规范，则提示测试连接成功；
    
    若未通过测试，您需确认：

    - 账号 ID 是否正确；  
    - AK / SK 是否存在；  
    - 存储桶是否存在；  
    - Region 是否不一致。  


3、点击**确定**，弹出确认框，进行创建规则的二次确定。

![](img/back-7.png)
    
-->

### [存储策略](../billing/billing-method/data-storage.md)

观测云基础日志存储最多为 60 天，通过备份日志，可延长日志的存储时间达 720 天。


### [计费方式](../billing/billing-method/index.md#backup)

备份日志计费是全量统计，统计的是<u>工作空间内截止到当前在数据存储策略范围内的所有备份日志数据</u>。计费方式如下：

| **计费项**   | **计费单元** | **价格** |
| ------------ | ------------ | -------- |
| 备份日志容量 | 每 1 GB      | 0.007 元 |

<!--
### 示例说明

在下图中，日志备份规则名称是 `http_dial_testing` ，需要同步备份扩展字段，筛选条件符合来源 `source` 是 `http_dial_testing` 的数据。

![](img/5.log_backup_3.png)

-->

## 相关操作

### 查看备份日志

进入**日志 > 备份日志**页面，即可查看符合备份条件的日志数据。

- [时间控件](../getting-started/function-details/explorer-search.md#time) ：通过选择时间范围筛选查看备份日志；
- [搜索和筛选](../getting-started/function-details/explorer-search.md#search) ：通过搜索关键字或者筛选字段的方式查看和分析备份日志；
- 备份日志详情：点击任意一条日志可查看日志的详情，包括日志产生的时间、内容和扩展字段。
- [显示列](../getting-started/function-details/explorer-search.md#columns) ：在创建备份日志规则时：

    若勾选**同步备份扩展字段**，可自定义添加除了日志产生的时间和内容以外的字段，见下图；

    ![](img/5.log_backup_6.png)

    在创建备份日志规则时，若不勾选**同步备份扩展字段**，则备份日志仅备份日志的时间和内容，见下图。

    ![](img/5.log_backup_5.png)

???+ attention

    若创建多个备份日志规则，则优先匹配勾选**同步备份扩展字段**的规则，即若不同的规则命中同一条数据，则优先按照**同步备份扩展字段**的逻辑展示整条日志数据。


备份日志规则创建以后，统一存储在日志索引下的**备份日志**。规则创建后，您可以查看、编辑、删除。

### 编辑规则

在**日志 > 备份日志 > 备份管理**，点击编辑按钮，即可修改当前存档类型下的信息。

### 查看规则

在**日志 > 备份日志 > 备份管理**，点击规则右侧的**查看**按钮，即可查看配置的备份规则过滤条件及其存档类型等。

<!--
![](img/5.log_backup_4.png)

-->

### 删除规则

在**日志 > 备份日志 > 备份管理**，点击规则右侧的**删除**按钮，即可删除日志备份规则。

???+ attention

    若需要修改创建的备份规则，可删除规则后再创建新的备份规则。规则删除后已备份的数据不会被删除，但不再产生新的日志备份数据。

![](img/7.backup_5.png)
