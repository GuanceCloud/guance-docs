# 图表查询
---


即依据用户自定义的数据查询以可视化布局显示数值数据并发掘重要数据关系。在编辑图表时，您可以依据选择的图表类型，进行图表查询以及其他图表设置。每一个正确的查询都对应一个 JSON 文本，工作台内的 JSON 文本和图表查询可互相解析，帮助您洞察图表绘制详情。

## 数据查询 {#query}

单个图表同时支持展示多种查询方式，包括**简单查询**、**表达式查询**、**DQL 查询**、**PromQL 查询**和**数据源**。您可按需添加。

对于单查询图表如概览图、仪表盘、排行榜，简单查询可直接转换为表达式查询。

???+ warning "切换查询方式"

    简单查询和 DQL 查询可通过 :fontawesome-solid-code: 按钮相互切换。切换后，若无法解析或者解析不完整：

    - 在简单查询下未操作，直接切换回 DQL 查询则显示之前的 DQL 查询语句；  
    - 在简单查询下调整了查询语句，再次切换回 DQL 查询将按照最新的简单查询进行解析。

![](../img/query.png)


### 简单查询 {#simple}

简单查询支持对不同数据源的数据进行查询，并通过选择聚合函数、分组标签、Label、筛选条件等进行图表展示。

- 支持通过图表和查询中间的**分隔条**按钮进行上下拖动，展示更多的查询区域；  
- 支持通过查询语句左侧的**拖拽**按钮进行上下拖动，调整查询的顺序。

<img src="../../img/chart016.png" width="70%" >

#### 数据源

数据源包括来自指标、日志、基础对象、自定义对象、事件、应用性能、用户访问、安全巡检、网络、Profile 的一系列数据组合。

| 选项 | 说明 |
| --- | --- |
| 指标 | 需要选择**指标集**和**指标**，一个指标集可包含多个指标，基础函数默认选中 **Last by**。结合图表类型，选择想要展示的指标进行查询。 |
| 日志/基础对象/自定义对象/事件/应用性能/用户访问/安全巡检/网络/ Profile | 系统对象、自定义对象和安全巡检需要选择**分类**和**属性/标签**，日志/事件/应用性能/用户访问需要选择**来源**和**属性/标签**，基础函数默认选中 **Count by**。 |

???+ warning "当日志作为数据源"

    若在**日志 > 索引**设置索引，在图表查询的数据源选择**日志**，支持选择不同的索引对应的日志内容，默认为索引 `default`。
    
    > 更多详情可参考文档 [日志索引](../../logs/multi-index.md)。

    ![](../img/5.log_7.png)

#### 分组

分组查询支持选择不同的 **标签** 进行分组查询，数据按所选的标签项进行分组展示，支持选择多个标签（不超过三个）进行查询。所选标签项，支持拖动调整分组顺序。

支持对分组后的查询做别名，在添加别名后，图例的名称也随之变化，方便更直观的区分相关指标。*（目前支持本功能的图表有：时序图、饼图、柱状图、散点图、气泡图、漏斗图。）*

![](../img/chart017.png)

#### Label {#label}

支持选择主机 Label 属性进行筛选显示。在图表查询，点击 **fx**，选择 **Label 筛选**，按需选择正选或者反选以及在主机设置的 Label 属性，如 `dev`，即可查询对应的主机数据。如下图：

![](../img/6.chart_query_label.png)

**前提**：在图表查询中选择 Label 之前，需在**基础设施 > [主机](../../infrastructure/host.md)**中为主机设置 Label 属性。


#### 筛选

支持通过标签进行筛选。点击**漏斗**图标，即可为该查询添加筛选条件，支持添加多个筛选条件，每个筛选条件之间可以有**并且**和**或**两种取值方式。

| 筛选条件       | 说明                                     | 支持的筛选条件类型           |
| -------------- | ---------------------------------------- | ---------------------------- |
| `=`            | 等于                                     | `Integer`、`Float`、`String` |
| `!=`           | 不等于                                   | `Integer`、`Float`、`String` |
| `>=`           | 大于等于                                 | `Integer`、`Float`、`String` |
| `<=`           | 小于等于                                 | `Integer`、`Float`、`String` |
| `>`            | 大于                                     | `Integer`、`Float`、`String` |
| `<`            | 小于                                     | `Integer`、`Float`、`String` |
| `match`        | 包含                                     | `String`                     |
| `not match`    | 不包含                                   | `String`                     |
| `wildcard`     | 模糊匹配（支持除指标以外的日志类数据）   | `String`                     |
| `not wildcard` | 模糊不匹配（支持除指标以外的日志类数据） | `String`                     |



> 筛选条件内容中的 `#{host}` 为视图变量。更多详情，可参考 [视图变量](../view-variable.md)。

![](../img/chart019.png)

#### 函数

支持通过函数计算指标等数据源。点击 **fx** 图标，即可为该查询添加以下函数：

<img src="../../img/chart020.png" width="70%" >

##### 聚合函数 {#aggregate-function}

UI 模式下支持选择如下聚合方式返回结果值。

> 在 DQL 模式下支持更多的聚合函数，可参考[DQL 聚合函数](../../dql/funcs.md)。

| 聚合函数 | 说明 |
| --- | --- |
| last | 返回最新时间戳的值 |
| first | 返回最早时间戳的值 |
| avg | 返回字段的平均值。参数有且只有一个，参数类型是字段名 |
| min | 返回最小值 |
| max | 返回最大值 |
| sum | 返回字段值的和 |
| P50 | 返回第百分之 50 的字段值 |
| P75 | 返回第百分之 75 的字段值 |
| P90 | 返回第百分之 90 的字段值 |
| P99 | 返回第百分之 99 的字段值 |
| count | 返回非空字段值的汇总值 |
| count_distinct | 统计字段不同值的数量 |
| difference | 返回一个字段中连续的时间值之间的差异 |
| derivative | 返回一个字段在一个 series 中的变化率 |
| non_negative_derivative | 返回在一个 series 中的一个字段中值的变化的非负速率 |

##### 转换函数

又称为外层函数，UI 模式下支持选择的函数如下所示：

| 转换函数（外层函数） | 说明 |
| --- | --- |
| cumsum | 对处理集累计求和 |
| abs |  计算处理集每个元素的绝对值 |
| log2 | 计算处理集每个元素以 2 为底数的对数，处理集至少大于一行，否则返回空值 |
| log10 | 计算处理集每个元素以 10 为底数的对数，处理集至少大于一行，否则返回空值 |
| moving_average  | 计算处理集的移动平均值，窗口的大小需要不小于处理集的行数，否则返回空值 |
| difference | 计算处理集相邻元素的差值，处理集至少大于一行，否则返回空值 |
| derivative | 计算处理集相邻元素的导数，求导的时间单位为秒（s） |
| non_negative_derivative | 计算处理集相邻元素的非负导数，求导的时间单位为秒（s） |
| non_negative_difference | 计算处理集相邻元素的非负差值，处理集至少大于一行，否则返回空值 |
| series_sum | 当分组产生多个 series, 根据时间点，合并为1个series。其中，相同时间点的多个 series 求和，处理集至少大于一行，否则返回空值 |
| rate |  计算某个指标一定时间范围内的变化率，适合缓慢变化的计数器。时间单位为秒（s） |
| irate | 计算某个指标一定时间范围内的变化率，适合快速变化的计数器，时间单位为秒（s） |

> 在 DQL 模式中支持更多的外部函数，可参考 [DQL 外层函数](../../dql/out-funcs.md)。

##### Rollup 函数 {#rollup}

即将数据切片成指定时间间隔的数据，并对每个时间间隔的数据进行计算返回。

**注意**：

1. 在时序图表中，选择该函数以及聚合方式后，可前往**高级配置**选择时间间隔；
2. 在非时序图中，选择该函数后，可选择包含 `avg`、`sum`、`min` 等在内的聚合方式和包含 auto、10s、20s、30s、1m、5m、10m、30m、1h、6h、12h、1d、7d、30d 在内的时间间隔（`interval`)；
3. Rollup 函数不支持添加多个。

> 更多详情，可参考 [Rollup 函数](../../dql/rollup-func.md)。

##### 窗口函数 {#window}

以选定的时间间隔为窗口（记录集合），结合聚合函数对每条记录都执行统计计算，支持选择 1 分钟、5 分钟、15 分钟、30 分钟、1 小时、3 小时、6 小时、12 小时、24 小时。

**注意**：窗口函数查询结果并不会改变记录条数，当前存在的记录数量在执行完函数结果后，仍保持之前的记录数量。

##### 无数据填充 {#fillin}

支持设定空值数据的填充方式，设定后在查询中显示为 **fill**，包括三种类型：

| 函数 | 说明 |
| --- | --- |
| 前值填充（previous） | 将空值数据转为上一个数值。  |
| 线性填充（linear） | 将空值数据进行线性函数计算后填充。 |
| 数值填充 | 可自定义填充数值。 |

##### 高级函数

高级函数主要用于对 DQL 查出的数据进行进一步的函数计算，并进行直观的时序图展示。观测云时序图表中支持选择自定义函数对数据进行二次处理并返回数据结果显示。


> 更多详情，可参考 [高级函数](../../dql/advanced-funcs/index.md)。

#### 别名

支持添加自定义名称，点击 **AS**，即可添加别名。

![](../img/3.chart_8.png)

#### 隐藏查询

点击**隐藏**图标，即可隐藏图表上的该条查询结果。从下图可以看出，系统加载数据只显示1分钟和15分钟的查询结果，5分钟的系统加载查询结果已经被隐藏，无法在图表上查看。

<img src="../../img/3.chart_9.png" width="70%" >


#### 预设字段查询

若工作空间无数据上报，在配置图表查询时无法选择数据，可在查询中预设字段值，默认为数值类型，按数值类型显示 [聚合函数](#aggregate-function)。

### DQL 查询

在图表查询过程中，当简单查询已无法满足您的需求时，您可以通过点击 :fontawesome-solid-code: 切换到 DQL 模式，手动输入 DQL 语句进行图表查询，任意点击屏幕即可执行查询语句并刷新图表，系统将提示错误的 DQL 查询语句。

> DQL 是专为观测云开发的语言，一个图表同时支持多条 DQL 查询。更多详情，可参考 [DQL 查询](../../dql/query.md)。

<img src="../../img/chart021.png" width="80%" >

### PromQL 查询 {#PromQL}

观测云支持切换到 PromQL 查询模式，通过书写 PromQL 查询获取数据。点击 **添加 PromQL 查询**，即可执行查询语句。

**注意**：PromQL 添加后默认是文本框输入，仅支持**复制、查看、删除**操作。此输入框既可以输入 PromQL 简单查询也可以输入表达式查询。

> 关于 PromQL，您也许想了解 [DQL 与其它几种查询语言的对比](../../dql/dql-vs-others.md#promql)；或前往 [PromQL](https://prometheus.io/docs/prometheus/latest/querying/basics/)了解更多相关知识。


### 表达式查询

表达式查询通过添加表达式进行计算。若表达式查询中包含多个查询语句，分组标签需保持一致。在表达式计算中，若查询 A 带单位，查询 A 与数字的运算结果同样带单位。例如：A 的单位是 KB，那么 A+100 的单位也是 KB。

![](../img/chart022.png)

### 添加数据源 {#func}

即针对存储于数据库内的数据属性作筛选、搜索、聚合分析等操作。

![](../img/func.png)

> 具体配置方法见 [Function 外部函数配置](../../dql/dql-out-func.md)。

<!--
若您已发布脚本并在 Function 平台内将脚本同步至对应工作空间，即可直接选择下表的 Func 数据源，观测云会自动获取工作空间 Issue 信息，最终为您进行可视化的数据展示。目前观测云支持针对[状态为 `resolved` 的 Issue](../../exception/issue.md#others) 列出处理时长统计指标类的脚本函数。

| 函数列表    | 说明 |
| --------- | ----------- |
| incidents-issue_total_count | 异常追踪-issue 总数 |
| incidents-open_issue_count | 异常追踪-open issue 数量 |
| incidents-pending_issue_count | 异常追踪-pending issue 数量 |
| incidents-resolved_issue_count | 异常追踪-resolved issue 数量 |
| incidents-average_issue_duration | 异常追踪-issue 平均处理时长 |
| incidents-max_issue_duration | 异常追踪-issue 最大处理时长 |
| incidents-issue_count_distribution_by_level | 异常追踪-issue 等级分布 |
| incidents-issue_count_distribution_by_reference | 异常追踪-issue 来源分布 |
| incidents-issue_count_by_assignee(top10) | 异常追踪-issue 处理数量 TOP 10 负责人 |
| incidents-issue_duration_by_assignee(top10) | 异常追踪-issue 处理时长 TOP 10 负责人 |
| incidents-unresolved_issue_assignee_distribution | 异常追踪-未解决 issue 负责人分布 |
| incidents-unresolved_issue_list | 异常追踪-未解决 issue 列表 |
-->



<!--
## 时间分片 {#time-slicing}

### 开启时间分片

时间分片一般和时间间隔配合使用，开启时间分片后，会先对原始数据按照一定的时间间隔进行分段聚合，再对聚合后数据集进行第二次聚合得到结果值。

![](../img/8.chart_7.png)

在下面的概览图示例中，首先是把最近一小时内活跃的内存按照 5 分钟为时间间隔聚合得到 12 个平均值，然后取其中最大值在图表上展示。

![](../img/8.chart_8.png)

### 关闭时间分片

若未开启时间分片，所有采集上来的原始数据根据选择的函数进行聚合得到结果值。

<img src="../../img/8.chart_6.png" width="70%" >

在下面的概览图示例中，把最近一小时内活跃的内存取其平均值在图表上展示。

![](../img/8.chart_9.png)
 -->
## 图表千分位 {#thousand}

观测云仪表板图表查询结果支持自动加上数据千分位格式显示。

![](../img/13.table_1.png)

若设置了单位，则按照设置的单位显示数据格式。

![](../img/13.table_2.png)

设置完成后可以在预览的情况下按照千分位数据格式显示，若设置单位则按照单位设置格式显示。

- 千分位数据格式显示：

<img src="../../img/13.table_4.png" width="70%" >

- 设置的数据格式显示：

<img src="../../img/13.table_5.png" width="70%" >

