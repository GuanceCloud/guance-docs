# 时序图

---

一般用于显示数据在相等时间间隔下的趋势变化，同时可以用来分析多组指标数据之间的作用及影响。

图表类型包含：

- 折线图（默认选中）
- 柱状图
- 面积图

![](../img/timeseries.png)

## 应用场景

- 查看应用性能指标数据在一定时间范围内的趋势变化，如在最近 15 分钟内应用“请求数”的趋势变化；
- 查看用户访问指标数据在一定时间范围内的趋势变化，如在不同时间范围内用户访问“错误数”的发生情况；    
- 查看固定时间范围内的相似趋势指标；
- 查看数据波动异常时触发的相关事件。


## 图表查询

支持**简单查询**、**表达式查询**、**DQL 查询**、**Promql 查询**和**数据源查询**。每个查询预设 5 种返回结果数量，包括 5、10、20、50、100，默认返回 20 条数据；也可手动输入，最多为 100 条数据。

> 更多图表查询条件详细说明，可参考 [图表查询](chart-query.md)。

## 图表配置

> 更多详情，可参考 [图表配置](./chart-config.md)。

### 风格 {#style}

#### 折线图 {#line-chart}

可选用四种风格：线性、平滑、前阶梯、后阶梯。

<img src="../../img/line_chart_style.png" width="70%" >

#### 面积图

可选用两种风格：

- 基础：直观展示各数据系列的走势，便于观察单一数据的变化趋势。
- 堆叠：适用于多个数据系列，各数据系列依次堆叠，每个系列的起始点基于前一个系列的结束点，便于观察整体数据的累积效果。



### 断点连接

考虑到在时序图中，时点均为自动连接。若某个时点的数据为空，此时图表中会出现断点。在默认情况下，<<< custom_key.brand_name >>>会自动连接断点前后的数据。通过设置**断点连接**，可避免出现对于断点数据的判断误差。

![](../img/breakpoint.gif)

### 展示返回值

适用于时序图 > 柱状图。

开启后，柱状图上方会展示具体数值。此处只显示数值，不显示单位；若在**基本设置 > 数据格式**处设置小数位数为 0、1、2、3 位，跟随设定的位数展示；若设置小数位数为“全精度”，则默认展示两位小数；千分位分隔符的显示也会同步此处。

![](../img/show-value.gif)

### 时间间隔 {#interval}

即图表查询数据的计算间隔（`interval`）。

如，此时无法选择切换时间间隔：

<img src="../../img/lock-1.png" width="60%" >
    
:material-numeric-1-circle: 自动对齐：开启后，将按选择的时间范围和聚合时间间隔动态的调整查询，根据计算的时间间隔就近向上取整。

此时会按照您所输入的最大点数列出可选的时间间隔：

**注意**：当查询中有 `metric` 指标查询时，固定列出的最小的 `interval = 10s`。

<img src="../../img/lock-2.png" width="60%" >

:material-numeric-2-circle: 指定时间：按所选 `interval` 执行查询，当和“最大返回点数” 冲突时，会优先按“时间范围/按最大点数”调整 `interval`；包含 10 秒、20 秒、30 秒、1 分钟、5 分钟、10 分钟、30 分钟、1 小时、6 小时、12 小时、1 天、7 天和 30 天。

<img src="../../img/lock-3.png" width="60%" >

???+ abstract "时间间隔逻辑补充说明"

    系统内置的 “时间间隔” 共 18 个：
    【10ms、50ms、100ms、500ms】
    【1s, 10s, 20s, 30s 】
    【1m, 5m, 10m, 30m】
    【1h, 6h, 12h】
    【1d, 7d, 30d】

    前端会根据**图表 > 高级配置**中设置的 “最大返回点数” 列出用户可选的 interval 列表，并自动选中最小的时间间隔。（如果用户没有配置，默认最大返回点数就是 720。）

    假设：查询最近 3 小时的时间范围：

    interval=10s，1080个点 >720（不符合）
    interval=20s，540个点 < 720（符合），所以时序图的 interval 默认选中 20s。

    但有个限制是，如果图表查询的是指标数据（metric），那么最小 interval=10s。 



### 最大返回点数

即每个序列的最大数据点数，可任意输入 2-1000 之间的任意整数，若您没有自定义，默认限制最大点数为 720。

**注意**：基于已选择的时间间隔，若查询范围过大，超过了最大点数，此时会按照最大点数计算 `interval` 并取整返回数据。

### 折线混合图

仅支持柱状图。

### 同环比

即与上一同等时间的数据进行对比。默认显示为关闭状态。

#### 对比维度

开启后，对比维度支持以下选项：

- 小时（与一小时前对比）
- 日（与一天前对比）
- 周（与一周前对比）
- 月（与一个月前对比）
- 环比

#### 对比逻辑

- **默认查询的折线图**：根据所选 [开始时间 - 结束时间] 绘制。

- **同期对比的折线图**：根据所选对比维度，向前推相同时间范围绘制。

#### 示例

*以查询主机 A 的 CPU 使用率趋势为例：*

- 对比维度选择【小时】：即向前推一个小时查询：

若查询【最近1小时】（3/2 10:00 - 3/2 11:00）主机 A 的 CPU 使用率趋势，则同期对比查询的就是（3/2 09:00 - 3/2 10:00）主机 A 的 CPU 使用率趋势。

若默认查询【今天】（3/2 00:00 - 3/2 11:00）主机 A 的 CPU 使用率趋势，则同期对比查询的就是（3/1 23:00 - 3/2 10:00）主机 A 的 CPU 使用率趋势。

- 对比维度选择【日】：即向前推一天（24h）查询：

若默认查询【最近1小时】（3/2 10:00 - 3/2 11:00）主机 A 的 CPU 使用率趋势，则同期对比查询的就是（3/1 10:00 - 3/1 11:00）主机 A 的 CPU 使用率趋势。

若默认查询【今天】（3/2 00:00 - 3/2 11:00）主机 A 的 CPU 使用率趋势，则同期对比查询的就是（3/1 00:00 - 3/1 11:00）主机 A 的 CPU 使用率趋势。

**注意**：当对比维度选择【月】，若默认查询【3d】（3/28 10:00 - 3/31 10:00）的主机 A 的 CPU 使用率趋势，则同期对比查询的就是（2/28 10:00:00 - 2/28 23:59:59）数据，因为 2 月没有 29、30、31号。


## 图表分析

时序图是以时间顺序为索引的二维图，横轴为时间刻度，纵轴为数据刻度。基于选择的时间范围，时序图将绘制对象数据在该时间段内的趋势变化。

**注意**：时序图一条查询语句最多返回 10 条时间线，即根据分组（group by）条件的结果，超过 10 条时间线的数据按照顺序只显示 10 条时间线。

<img src="../../img/f4.png" width="70%" >

### 时间轴 {#timeline}

同时，在分析模式下，<<< custom_key.brand_name >>>提供了时间轴功能，即您不仅能够通过图表下方的时间轴预览对象数据和时间的交互变化，而且能够拖动选择展示的时间范围。时间轴范围是以选定的时间范围为查询周期，向前固定三个查询周期，向后最多固定一个查询周期（截止到当前的时间点）。

例如：当前时间点为11:33，时间范围选择【最近 1 小时】，那么时间轴范围为【10:33 - 11:33】。

<img src="../../img/f3.png" width="70%" >

#### 相似趋势指标 {#similar}

在时序图的分析模式下，选中时序图的趋势线/柱，可**查看相似趋势指标**。

查看相似趋势指标是以您框选的时间范围为绝对时间，查询空间内相似的指标趋势。您可以：

- 在时序图上，点击图表并拖动鼠标选定搜索的时间范围；
- 点击“按钮”，搜索相似趋势结果；
- 点击查询结果，进入“相似趋势指标”详情页。

![](../img/18.shixutu_1.png)

#### 相似趋势结果

基于选定的绝对时间范围，查询结果列表包括：

- 来源：存在相似趋势的指标集；
- 相似数量：对应“指标集”下相似趋势的图表数量；
- 预览：相似趋势图表的预览图。

![](../img/18.shixutu_2.png)

???+ warning "注意"

    - 查询**相似区间**时默认当前选定的时间范围为【绝对时间】，不会因任何外部的作用或观察者改变。如果您需要更改时间范围，需要重新调节时间范围；

    - 进入**相似区间**页面后，单击拖动矩形可调整搜索的时间范围，如果已经选择了一个区域，您仍可以移动或者调整选择的时间范围；

    - 拖动至新的时间范围后，您需要确定/取消更换时间范围。

  




