# 时序图

---

时序图一般用于显示数据在相等时间间隔下的趋势变化，同时可以用来分析多组指标数据之间的作用及影响。

![](../img/timeseries.png)

## 应用场景

- 查看应用性能指标数据在一定时间范围内的趋势变化，如在最近 15 分钟内应用“请求数”的趋势变化；
- 查看用户访问指标数据在一定时间范围内的趋势变化，如在不同时间范围内用户访问“错误数”的发生情况；  
- 查看固定时间范围内的相似趋势指标；
- 查看数据波动异常时触发的相关事件。

## 图表查询

图表查询支持**简单查询**、**表达式查询**、**DQL 查询**、**Promql 查询**和**数据源查询**；默认添加简单查询。每个查询预设 5 种返回结果数量，包括 5、10、20、50、100，默认返回 20 条数据，支持手动输入，最多为 100 条数据。

> 更多图表查询条件详细说明，可参考 [图表查询](chart-query.md)。

## 图表链接

链接可以帮助实现从当前图表跳转至目标页面。您可以添加平台内部链接或外部链接，能通过模板变量修改链接中对应的变量值将数据信息传送过去，实现数据联动。

> 更多相关设置说明，可参考 [图表链接](chart-link.md)。

## 事件关联

通过**添加筛选字段**匹配与选定字段相关的异常事件，从而达到时序数据与事件关联显示的目的。这个功能可以帮助您在查看趋势的同时，感知数据波动期间是否有相关事件产生，以帮助您从另一个视角定位问题。

> 更多相关设置说明，可参考 [事件关联](events-relative.md)。

## 常用配置

图表类型包含折线图、柱状图和面积图（默认选中折线图)。

| <div style="width: 120px">选项</div> | 说明 |
| --- | --- |
| 标题 | 为图表设置标题名称，设置完成后，在图表的左上方显示，支持隐藏。|
| 描述 | 为图表添加描述信息，设置后图表标题后方会出现【i】的提示，不设置则不显示。 |
| 堆叠 | 仅支持柱状图，默认关闭。<br /><li>百分比：柱子的各个层代表的是该类别数据占该分组总体数据的百分比，每个系列按照所占的百分比进行堆积。 |
| 单位 | **:material-numeric-1-box: 默认单位显示**：<br /><li>若查询的数据为指标数据，且您在[指标管理](../../metrics/dictionary.md)中为指标设置了单位，则默认按照指标的单位进行进位显示；<br /><li>若您在**指标管理**内无相关单位配置，则按照 [千分位](chart-query.md#thousand) 逗号间隔的数值进位方式显示。<br />**:material-numeric-2-box: 配置单位后**：<br />优先使用您自定义配置的单位进行进位显示，指标类数据支持针对数值提供两种选项：<br /><br />**科学计数说明**<br /><u>默认进位</u>：单位为万、百万，如10000 展示为 1 万，1000000 展示为 1 百万。保留两位小数点；<br /><u>短级差制</u>：单位为 K, M, B。即以 thousand、million、billion、trillion 等依次表示中文语境下的千、百万、十亿、万亿等。如 1000 为 1 k，10000 为 10 k，1000000 为 1 million；保留两位小数点。|
| 断点连接 | 适用于时序图 > 折线图/面积图。<br />更多详情，可参考 [断点连接](#breakpoint)。 |
| 展示返回值 | 适用于时序图 > 柱状图。开启后，柱状图上方会展示具体数值。<br />此处只显示数值，不显示单位；若在**基本设置 > 数据格式**处设置小数位数为 0、1、2、3 位，跟随设定的位数展示；若设置小数位数为“全精度”，则默认展示两位小数；千分位分隔符的显示也会同步此处。<br /><font size=2>*（效果显示参考表格下方图四。*）</font> |
| 颜色 | 设置图表数据的显示颜色，支持自定义手动输入预设颜色，输入格式为：聚合函数(指标){"标签": "标签值"}，如 `last(usage_idle){"host": "guance_01"}`。 |
| 图例 | 更多详情，可参考 [图例说明](#legend)。 |
| 数据格式 | 您可以选择【小数位数】以及【千分位分隔符】。<br /><li>千位分隔符默认开启，关闭后将显示原始值，无分隔符。更多详情，可参考 [数据千分位格式](../visual-chart/chart-query.md#thousand)。 |
| Y 轴 | 支持自定义 Y 轴的最大值和最小值。 |


## 高级配置 {#advanced-setting}

| 选项 | 说明 |
| --- | --- |
| 锁定时间 | 即固定当前图表查询数据的时间范围，不受全局时间组件的限制。设置成功后的图表右上角会出现用户设定的时间，如【xx分钟】、【xx小时】、【xx天】。<br /><font size=2>*（效果显示参考表格下方图一。*）</font> |
| 时间间隔 | 即图表查询数据的计算间隔（`interval`）*（逻辑补充见图片下方）*。<li>自动对齐：开启后，将按选择的时间范围和聚合时间间隔动态的调整查询，根据计算的时间间隔就近向上取整。<br /><font size=2>*（效果显示参考表格下方图二。*）</font><br /><li>指定时间：按所选 `interval` 执行查询，当和“最大返回点数” 冲突时，会优先按“时间范围/按最大点数”调整 `interval`；包含 10 秒、20 秒、30 秒、1 分钟、5 分钟、10 分钟、30 分钟、1 小时、6 小时、12 小时、1 天、7 天和 30 天。<br /><font size=2>*（效果显示参考表格下方图三。）*</font> |
| 最大返回点数 | 即每个序列的最大数据点数，可任意输入 2-1000 之间的任意整数，若您没有自定义，默认限制最大点数为 720。<br /><br />:warning: 基于已选择的时间间隔，若查询范围过大，超过了最大点数，此时会按照最大点数计算 `interval` 并取整返回数据。<br /> |
| 折线混合图 | 仅支持柱状图。 |
| 同期对比 |  与上一同等时间的数据进行对比。默认显示为关闭状态，开启同期对比后，对比维度支持 4 个选项：小时（与一小时前对比）、日（与一天前对比）、周（与一周前对比）、月（与一个月前对比）。<br /><br />支持多选，更多详情，可参考[同期对比](time-comparison.md)。 |
| 基线设置 | 支持添加基线值、基线标题以及基线颜色。 |
| 字段映射 | 配合视图变量的对象映射功能，默认为关闭，若在视图变量已配置对象映射：<br /><li>开启字段映射时，图表显示查询的**分组字段**和对应的**映射字段**，未指定映射的分组字段不显示；<br /><li>关闭字段映射时，图表正常显示，不显示映射的字段。<br /> |
| 空间授权 | 被授权的工作空间列表；选择后即可通过图表查询并展示该工作空间数据。 |
| 数据采样 | 仅针对 Doris 日志数据引擎的工作空间；开启后，会对除“指标”外的其他数据进行采样查询，采样率不固定，会根据数据量大小动态调整。 |

*图表示例：*

<div class="grid" markdown>

=== "图一"

    此时无法选择切换时间间隔：

    <img src="../../img/lock-1.png" width="60%" >

=== "图二"

    此时会按照您所输入的最大点数列出可选的时间间隔：

    **注意**：当查询中有 `metric` 指标查询时，固定列出的最小的 `interval = 10s`。

    <img src="../../img/lock-2.png" width="60%" >

=== "图三"

    <img src="../../img/lock-3.png" width="60%" >

=== "图四" 

    ![](../img/show-value.gif)

</div>

???+ abstract "时间间隔逻辑补充说明"

    系统内置的 “时间间隔” 共 18 个：
    【10ms、50ms、100ms、500ms】
    【1s, 10s, 20s, 30s 】
    【1m, 5m, 10m, 30m】
    【1h, 6h, 12h】
    【1d, 7d, 30d】

    前端会根据**图表 > 高级配置**中设置的 “最大返回点数” 列出用户可选的 interval 列表，并自动选中最小的时间间隔。（如果用户没有配置，默认最大返回点数就是 720。）

    假设：查询最近 3 小时的时间范围：

    interval=10s，1080个点 >720（不符合）
    interval=20s，540个点 < 720（符合），所以时序图的 interval 默认选中 20s。

    但有个限制是，如果图表查询的是指标数据（metric），那么最小 interval=10s。 


## 图表分析

时序图是以时间顺序为索引的二维图，横轴为时间刻度，纵轴为数据刻度。基于选择的时间范围，时序图将绘制对象数据在该时间段内的趋势变化。

**注意**：时序图一条查询语句最多返回 10 条时间线，即根据分组（group by）条件的结果，超过 10 条时间线的数据按照顺序只显示 10 条时间线。

<img src="../../img/f4.png" width="70%" >

### 时间轴功能

同时，在分析模式下，观测云提供了时间轴功能，即您不仅能够通过图表下方的时间轴预览对象数据和时间的交互变化，而且能够拖动选择展示的时间范围。时间轴范围是以选定的时间范围为查询周期，向前固定三个查询周期，向后最多固定一个查询周期（截止到当前的时间点）。

例如：当前时间点为11:33，时间范围选择【最近 1 小时】，那么时间轴范围为【10:33 - 11:33】。

<img src="../../img/f3.png" width="70%" >

#### 相似趋势指标 {#similar}

在时序图的分析模式下，选中时序图的趋势线/柱，可**查看相似趋势指标**。

查看相似趋势指标是以您框选的时间范围为绝对时间，查询空间内相似的指标趋势。您可以：

- 在时序图上，点击图表并拖动鼠标选定搜索的时间范围；
- 点击“按钮”，搜索相似趋势结果；
- 点击查询结果，进入“相似趋势指标”详情页。

![](../img/18.shixutu_1.png)

#### 相似趋势结果

基于选定的绝对时间范围，查询结果列表包括：

- 来源：存在相似趋势的指标集；
- 相似数量：对应“指标集”下相似趋势的图表数量；
- 预览：相似趋势图表的预览图。

![](../img/18.shixutu_2.png)

**注意**：

- 查询**相似区间**时默认当前选定的时间范围为【绝对时间】，不会因任何外部的作用或观察者改变。如果您需要更改时间范围，需要重新调节时间范围；

- 进入**相似区间**页面后，单击拖动矩形可调整搜索的时间范围，如果已经选择了一个区域，您仍可以移动或者调整选择的时间范围；

- 拖动至新的时间范围后，您需要确定/取消更换时间范围。

  
### 图例说明 {#legend}

:material-numeric-1-circle: 别名：在添加别名后，图例的名称也随之变化，方便更直观的区分相关指标。

别名支持使用模板变量实现一键替换：例如：

- {{tags}} 表示替换为所有“标签名”和“标签值”；

- {{host}} 表示替换为 host 的“标签值”。

*示例：基于指标，别名的设置会出现以下场景：*

未添加别名效果：

<img src="../../img/alias-1.png" width="60%" > 

输入纯文本替换效果：

<img src="../../img/alias-2.png" width="60%" > 

基于 by 条件输入变量 {tags}}：

**注意**：当您的查询中存在 by 条件，则会为您显示返回的所有图例序列。

<img src="../../img/alias-3.png" width="60%" >

:material-numeric-2-circle: 位置：目前支持选择隐藏、底部、右侧图例（点击图例中的指标行，可隐藏/显示对应指标)。


:material-numeric-3-circle: 显示值：选择要在图例中显示的值或计算值。

时序图图例值会根据图表查询结果进行再次聚合计算，目前支持选择 `Last（最后一个值）`、`First（第一个值）`、`Avg（平均值）`、`Min（最小值）`、`Max（最大值）`、`Sum（求和）`、`Count（返回点数）`。

如下图所示：`First` 表示返回当前时序图查询结果的第一个值，`Last` 是当前时序图查询结果的最后一个值，点击图例值支持升降排序。

**注意**：`Avg` 、`Sum` 、`Count` 根据选择的时间间隔（原始间隔和自动对齐）不同，显示不同的结果。

<img src="../../img/chart030.png" width="70%" >

### 断点连接 {#breakpoint}

考虑到在时序图中，时点均为自动连接。若某个时点的数据为空，此时图表中会出现断点。在默认情况下，观测云会自动连接断点前后的数据。通过设置**断点连接**，可避免出现对于断点数据的判断误差。

![](../img/breakpoint.gif)

## 示例图

下图为折线图、柱状图、面积图在最近 15 分钟主机 CPU 使用的趋势变化：

![](../img/8.scene_time_1.gif)


