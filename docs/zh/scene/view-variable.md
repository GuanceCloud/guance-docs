# 视图变量
---

## 概述

观测云支持向视图中添加全局变量，当您想要在仪表板中，动态地完成图表的筛选，可以选择使用视图变量来实现。

注意：在切换视图变量时，下拉中仅支持显示前 50 个，可通过搜索查看其余变量。

## 添加视图变量

在仪表板中，若未添加过视图变量，顶部导航栏显示「添加视图变量」按钮，点击即可进入添加视图变量。

![](img/2.view_variable_2.png)

若已添加过视图变量，顶部导航栏下面会显示视图变量名称，点击右侧「编辑」按钮，即可进入视图变量编辑页面。

![](img/2.view_variable_1.png)

在视图变量编辑页面，您可以选择「数据来源」，输入/选择「变量查询」、「默认值」、「变量名」、「显示名」，设置是否隐藏、排序、删除等操作。数据来源包括指标、DQL、系统对象、自定义对象、日志、应用性能、用户访问、安全巡检和自定义

![](img/variable.png)

### 变量查询

视图变量支持 DQL 查询、UI 点击查询、自定义三种查询方式。

#### DQL 查询

在 DQL 查询过程中，根据用户手写的 DQL 查询返回对应数据值，支持在查询中添加时间范围，支持配置级联查询。([了解更多DQL函数说明](../dql/funcs.md))

???+ attention 

    - 支持在 DQL 查询中以 [xx:xx:xx] 的格式添加数据查询的时间范围，若在 DQL 查询中添加了时间范围，则优先使用 DQL 查询中的时间范围；若 DQL 查询中未添加时间范围，则默认使用仪表板时间控件所选的时间范围，如需要查询最近 10 分钟的容器主机列表，则 DQL 查询语句为 `O::docker_containers:(distinct(`host`)) [10m]`
    - 在配置级联查询时，支持使用 `=` 、`!=` 精确匹配变量值，支持多选，如 `R::view:(distinct('env')) {'app_id' = '#{appid}'`
    - 在配置级联查询时，支持使用 `match（re）` 、`not match（re）` 、`wildcard` 、`not wildcard` 模糊匹配变量值，支持多选，如 `R::view:(distinct('env')) {'app_id' = re('#{appid}')}`

##### Show 函数查询

> 【指标数据】建议使用该查询方式

| 语法 | 说明 |
| --- | --- |
| show_measurement() | 返回当前工作空间所有的指标集，该函数不支持添加时间筛选 |
| show_tag_key(from=['指标集名']) | 返回当前工作空间选定指标集下面的标签，该函数不支持添加时间筛选 |
| show_tag_value(from=['指标集名'], keyin=['标签名']) | 返回指定指标集下某个标签的值，该函数不支持添加时间筛选 |
| show_object_source()    <br /> `object `可替换为 logging/event/tracing/rum | 返回 object /log/keyevent/tracing/rum 数据的指标集合，该函数不需要参数 |

`SHOW_TAG_VALUE` 函数示例：

```
##查询当前工作空间指标集 cpu 的 host 标签值列表
SHOW_TAG_VALUE(from=["cpu"],keyin=["host"])
```

##### DQL 语句查询

> 基础设施、日志等【非指标数据】建议使用该方式

| 语法 | 说明 |
| --- | --- |
| 数据源类型::数据来源:(distinct('属性字段名')){筛选条件} | M/metric - 时序指标数据 ；O/object - 对象数据；L/logging - 日志数据 ；E/event - 事件数据 ；T/tracing - 追踪数据  ；R/rum - RUM 数据 |
| R::view:(distinct('app_id')) | 返回 web 应用用户访问监测的 app_id 列表 |
| R::view:(distinct('env')) {'app_id' = '#{appid}'} | 变量联动，假使上一条查询的变量名设为 app_id，则返回上条变量中所选 app_id 对应的 env 列表 |
| R::view:(distinct('env')) {'app_id' = '8f05003ebccad062'} | 返回`app_id=8f05003ebccad062`对应的 env 列表 | 

##### 级联查询示例

> 使用场景：两个变量 host（主机）、container_name（容器），选择 host，自动显示该 Host 对应所有 Container 列表

变量1（主机名）：_查询当前工作空间内最近 10 分钟的容器主机列表_

```
O::docker_containers:(distinct(`host`)) [10m]
```

变量2（容器名）：_查询当前工作空间内最近 10 分钟的变量 1 中所选主机下的容器列表_

```
O::docker_containers:(distinct(`container_name`)) {`host`=`#{host}`}[10m]
```

![](img/11.variable_3.png)


#### UI 点击查询

##### 指标查询

选择【指标集】以及对应的【标签】

![](img/11.variable_4.png)

查询说明：

| 数据类型 | 指标集                                                      | 标签                                                      | 默认值                                                       |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 指标     | SHOW_MEASUREMENT() 函数<br>该函数不支持添加时间筛选<br>取值范围：当前工作空间所有的指标集 | SHOW_TAG_KEY(from=['指标集名']) 函数<br>该函数不支持添加时间筛选<br>取值范围：当前工作空间选定指标集下面的标签 | SHOW_TAG_VALUE(from=['指标集名'], keyin=['标签名']) LIMIT 50<br>该函数不支持添加时间筛选<br>取值范围：指定指标集下某个标签的 50 个值 |

##### 基础设施查询

选择【分类】以及对应的【属性/标签】

![](img/11.variable_5.png)

查询说明：

| 数据类型 | 分类                                                      | 属性/标签                                                      | 默认值                                                       |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 基础对象 | O::RE(`.*`):(DISTINCT_BY_COLLAPSE(`class`))<br>该函数**支持**添加时间筛选，**跟随仪表板时间控件联动**<br>取值范围：选定时间内的所有默认 index 下的 source 值 | SHOW_OBJECT_FIELD('kubernetes_nodes')<br>该函数**不支持**添加时间筛选<br>取值范围：当前工作空间对象数据下的所有字段 | O::`kubernetes_nodes`:(DISTINCT_BY_COLLAPSE(`namespace`)) LIMIT 50<br>该函数**支持**添加时间筛选，**跟随仪表板时间控件联动**<br>取值范围：选定时间内对象数据中某个标签的 50 个值 |

##### 自定义对象查询

选择【分类】以及对应的【属性/标签】

![](img/7.view_variable_1.png)

查询说明：

| 数据类型   | 分类                                                      | 属性/标签                                                      | 默认值                                                       |
| ---------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 自定义对象 | CO::RE(`.*`):(DISTINCT_BY_COLLAPSE(`class`))<br>该函数**支持**添加时间筛选，**跟随仪表板时间控件联动**<br>取值范围：选定时间内的所有默认 index 下的 source 值 | SHOW_CUSTOM_OBJECT_FIELD('class值')<br>该函数**不支持**添加时间筛选<br>取值范围：当前工作空间自定义对象数据下的所有字段 | CO::`cdsmnl`:(DISTINCT_BY_COLLAPSE(`cds`)) LIMIT 50<br>该函数**支持**添加时间筛选，**跟随仪表板时间控件联动**<br>取值范围：选定时间内自定义对象数据中某个标签的 50 个值 |

##### 日志查询

选择【日志来源】以及对应的【属性】

![](img/11.variable_6.png)

查询说明：

| 数据类型 | 日志来源                                                      | 属性                                                      | 默认值                                                       |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 日志     | L::RE(`.*`):(DISTINCT_BY_COLLAPSE(`source`))<br>该函数**支持**添加时间筛选，**跟随仪表板时间控件联动**<br>取值范围：选定时间内的所有默认 index 下的 source 值 | SHOW_LOGGING_FIELD(index='default')<br>该函数**不支持**添加时间筛选<br>取值范围：当前工作空间日志数据下的所有字段 | L::RE(`.*`):(DISTINCT_BY_COLLAPSE(`trace_id`)) LIMIT 50<br>该函数**支持**添加时间筛选，**跟随仪表板时间控件联动**<br>取值范围：选定时间内日志数据中某个标签的 50 个值 |

##### 应用性能查询

选择【属性】

![](img/11.variable_7.png)

查询说明：

| 数据类型     | 属性                                                       | 默认值                                                       |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 应用性能监测 | SHOW_TRACING_FIELD()<br>该函数**不支持**添加时间筛选<br>取值范围：当前工作空间链路数据下的所有字段 | T::RE(`.*`):(DISTINCT_BY_COLLAPSE(`resource`)) LIMIT 50<br>该函数**支持**添加时间筛选，**跟随仪表板时间控件联动**<br>取值范围：选定时间内链路数据中某个标签的 50 个值 |

##### 用户访问查询

选择【数据分类】以及对应的【属性】

![](img/11.variable_8.png)

查询说明：

| 数据类型     | 数据分类                                                      | 属性                                                      | 默认值                                                       |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 用户访问监测 | R::RE(`.*`):(DISTINCT_BY_COLLAPSE(`source`))<br>该函数**支持**添加时间筛选，**跟随仪表板时间控件联动**<br>取值范围：选定时间内的所有默认 index 下的 source 值 | SHOW_RUM_FIELD('source值')<br>该函数**不支持**添加时间筛选<br>取值范围：当前工作空间用户访问数据下的所有字段 | R::`error`:(DISTINCT_BY_COLLAPSE(`province`)) LIMIT 50<br>该函数**支持**添加时间筛选，**跟随仪表板时间控件联动**<br>取值范围：选定时间内用户访问数据中某个标签的 50 个值 |

##### 安全巡检查询

选择【属性】

![](img/11.variable_9.png)

查询说明：

| 数据类型 | 属性                                                       | 默认值                                                       |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 安全巡检 | SHOW_SECURITY_FIELD()<br>该函数**不支持**添加时间筛选<br>取值范围：当前工作空间安全巡检数据下的所有字段 | S::RE(`.*`):(DISTINCT_BY_COLLAPSE(`rule`)) LIMIT 50<br>该函数**支持**添加时间筛选，**跟随仪表板时间控件联动**<br>取值范围：选定时间内安全巡检数据中某个标签的 50 个值 |

#### 自定义查询

自定义是指用户可以直接定义一组数值用于视图变量使用，无需通过查询语句获取相关值；自定义变量选项中的内容，每个选项之间用英文 “,” 隔开。

![](img/11.variable_10.png)

### 变量设置

#### 字段描述
| 字段 | 描述 |
| --- | --- |
| 默认值 | 当前视图变量在仪表板中的初始变量。支持预览当前视图变量的全部变量，并选择在仪表板默认查看的初始变量，若默认值为空，则在仪表板显示最新的字段数据。默认值列表最多显示 50 个变量，支持搜索查找更多。 |
| 变量名 | 当前视图变量集合所属的变量名称，在仪表板中添加图表时，需要在图表查询中引用，格式为：#{变量名} |
| 显示名 | 当前视图变量集合在仪表板中显示的名称，例如：变量名为 “host”，显示名为 “主机名” |

#### 高级设置

针对视图变量可以进行如下的高级配置：

| 功能 | 说明 |
| --- | --- |
| 拖动排序 | 通过鼠标悬浮（hover）至图标，可点击拖动视图变量，调节先后顺序 |
| 排序 | 针对查询返回的视图变量进行默认、升降、排序排列。 |
| 是否隐藏 | 开启该功能后，在非编辑模式下，该变量不可见，顶部导航栏显示「添加视图变量」按钮 |

## 如何使用视图变量

视图变量创建完成后，要在图表中关联此变量，实现图表与视图变量的联动筛选。

1）在图表查询中，筛选字段时，value值选中该变量即可。(此处下拉中显示的是变量名)

![](img/8.variable_11.png)

2）在场景视图中切换变量值，图表将根据变量标签进行筛选展示

![](img/8.variable_12.png)

## 修改/删除视图变量

点击「编辑」，点击视图变量编辑图标，进入变量管理页面，即可「修改」，点击删除图标即可「删除」。

## 对象映射

针对基础设施对象数据可以设置字段映射，字段映射只是用作显示，不会影响原字段数据。

### 添加映射

选择【数据来源】【对象分类】以及需要映射的两个【属性字段】。如下图所示：将`container_id` 映射显示为`container_name`。

![](img/variable001.png)

### 如何使用对象映射

字段映射的结果可以应用在两个地方：1）视图变量的下拉显示中；2）图表的显示中。

#### 在视图变量中应用

在视图变量中添加对象的【属性字段】，若该字段同样设置了字段映射，那么在视图变量中显示为：映射的字段（查询的字段）。

举例说明：

1）在【视图变量】中添加了`container_id`变量（如下图所示）。

![](img/variable002.png)

2）在【对象映射】中设置`container_id`映射为`container_name`。

![](img/variable001.png)

3）此时在视图中变量显示为：`container_name(container_id)`。

![](img/x10.png)

#### 在图表中应用

在图表中查询了对象的【属性字段】，并在设置中开启【字段映射】，若该字段同样设置了字段映射，那么在图表变量中显示为：映射的字段（查询的字段）。

举例说明：

1）在【对象映射】中设置`host`映射为`name`（如下图所示）。

![](img/variable003.png)


2）在图表查询中使用该字段，并且在【设置】中开启【字段映射】，那么在图表中显示格式为`name(host)`。

![](img/x12.png)

注意：

- 对象映射只支持设置对象类数据
- 使用对象映射时，必须先定义一个基于对象类字段的视图变量
- 同一对象分类的查询字段，不支持设置两个映射，即查询字段下拉中不存在该对象分类已添加的字段
- 开启字段映射时，图表中显示查询的「分组字段」和对应的「映射字段」，未指定映射的分组字段不显示
- 关闭字段映射时，图表中不显示映射的字段，正常显示。

