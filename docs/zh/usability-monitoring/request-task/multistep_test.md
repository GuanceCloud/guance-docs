# 多步拨测
---


多步拨测是一种高级监测工具，通过串联多个 API 请求来模拟复杂的业务流程或用户操作路径。它允许使用多个 API 连接的响应数据创建测试，从而验证关键业务交易、模拟端到端的用户旅程，并支持认证和授权。这种测试方式可以主动监测服务的可用性和性能，确保复杂流程的正常运行，并在出现问题时及时告警。

## 开始创建

点击**任务 > 新建 > 多步拨测**。


### :material-numeric-1-circle: 基本信息

1. 定义拨测任务名称；
2. 按需填写描述；

### :material-numeric-2-circle: 选择拨测节点

目前<<< custom_key.brand_name >>>已覆盖全球 14 个拨测节点。您可以选择中国地区或海外地区（仅限商业版及以上用户）的一个或多个节点，快速开启站点服务质量监测。


### :material-numeric-3-circle: 选择拨测频率

选择拨测任务的执行频率，支持以下选项：

- 1 分钟（仅限商业版及以上用户）
- 5 分钟（仅限商业版及以上用户）
- 15 分钟（仅限商业版及以上用户）
- 30 分钟
- 1 小时
- 6 小时
- 12 小时
- 24 小时

### :material-numeric-4-circle: 定义请求步骤 {#request_step}

点击**创建第一个请求**。

<img src="../../img/multitest_1.png" width="70%" >

#### 名称

定义请求名称。

#### 定义请求格式

1. 定义请求 URL;
2. 按需进行[高级设置](./http.md#advanced)。

#### 可用判断

##### 默认模式

即通过添加判断条件来定义拨测结果的成功条件。

多个条件之间可以选择“所有”或“任意”来实现 AND 或 OR 逻辑关系。

| 类型 | 运算符 |
| --- | --- |
| 响应体 | `包含`，`不包含`，`是`，`不是`，`正则匹配`，`正则不匹配` |
| 请求头 |  `包含`，`不包含`，`是`，`不是`，`正则匹配`，`正则不匹配` |
| 响应时间 | `小于` |
| 状态码 | `是`，`不是`，`正则匹配`，`正则不匹配` |

##### 脚本模式 {#script}

在多步拨测任务中，脚本模式通过编写 Pipeline 脚本，可实现以下功能：

- 设置判断条件：根据业务需求，自定义复杂的判断逻辑，支持单条件或多条件组合判断；
- 处理结果数据：对拨测结果进行自定义处理，包括数据清洗、格式转换等；
- 提取字段并定义变量：从响应中提取特定字段，并将其定义为变量，以便在后续步骤中复用。

脚本模式可灵活满足从响应中提取特定字段或进行复杂条件判断的需求。

示例：

```
body = load_json(response["body"])

if body["code"] == "200" {
  result["is_failed"] = false
  vars["token"] = body["token"]
} else {
  result["is_failed"] = true
  result["error_message"] = body["message"]
}
```

上面的脚本中，首先使用 `load_json` 将响应内容解析为 JSON 对象，然后判断响应状态码是否为 200，如果为 200，则将响应内容中的 `token` 提取出来，通过 `vars` 存储，供后续请求使用；否则将 `result` 的 `is_failed` 设置为 `true`， 且 `error_message` 设置为响应内容中的 `message`。


> 更多阅读，可参考 [自定义拨测任务](../../integrations/dialtesting_json.md#post_script)。

###### 局部变量 {#variables}

在当前多步拨测任务中定义的局部变量，可在后续请求步骤中引用。

**注意**：需先在脚本中提取对应字段，才能定义变量。

<img src="../../img/multitest_2.png" width="70%" >

1. 输入变量名，一般支持输入大写字母、数字、下划线，不可重名；
2. 选择变量值，即在脚本模式中定义为变量的字段；
3. 按需选择是否加密变量值。勾选后，即可在测试结果中隐藏当前变量值。

创建的变量统一在左上角“变量”区域显示。

<img src="../../img/multitest_5.png" width="70%" >

您可以在定义请求格式 > 高级设置 > 请求头中引用局部变量。

如图，步骤 1 中已定义局部变量 `{{DS_ID}}`，其值为 `dashboard_id`。在请求 2 中，可直接在 URL 中引用该变量取值。

<img src="../../img/multitest_9.png" width="70%" >

如需管理这些变量，请在“局部变量配置”区域点击右侧的按钮，即可进行编辑或删除操作。

<img src="../../img/multitest_6.png" width="70%" >

**注意**：

- 删除局部变量后，当前多步拨测中引用该变量的请求将无法继续使用该变量；
- 修改局部变量名称后，引用原名称的步骤将无法识别该变量。

#### 执行设置

选择“若此步骤失败，将继续执行下一步”，可在当前步骤失败时跳过错误，继续执行后续步骤。

<img src="../../img/multitest_3.png" width="70%" >


#### 测试

任务步骤创建完成后，点击“测试”按钮即可快速验证测试结果。系统将同步提供以下信息供参考：

- 测试性能：展示测试过程中的性能指标。
- 响应详情：提供详细的响应内容，帮助排查问题。
- 变量：可查看当前任务下请求和 URL 中配置的变量。

<img src="../../img/multitest_7.png" width="70%" >

如果您从第一个请求任务之后的步骤开始测试，可直接对当前任务进行测试，也可选择从第一个任务开始测试。

<img src="../../img/multitest_8.png" width="70%" >

如果测试失败，可能存在未知变量。可点击“测试从第一步至当前请求”按钮重新发起测试进行排查。



#### 继续创建请求步骤


创建完第一步拨测任务后，可继续“[创建 HTTP 请求](#request_step)”或“[创建等待步骤](#waiting)”。

**注意**：最多可创建 10 个步骤（包含 HTTP 请求和等待）

##### 等待步骤 {#waiting}

即表示在等待特定时长后继续执行下一步，时长可选为 1 秒、5 秒、15 秒、30 秒、1 分钟、2 分钟或 3 分钟。


<img src="../../img/multitest_4.png" width="70%" >


#### 管理任务

请求步骤创建完成后，点击保存即可。

针对已创建的任务，您可进行通过以下操作进行管理：

- 点击任务左侧拖拽图标，可改变调用步骤顺序；
- 点击任务右侧 :material-dots-vertical:，可选择克隆或删除此步骤；
- 点击“批量”，可批量克隆或删除任务。

**注意**：克隆请求步骤时，局部变量无法一起克隆。