# 高级函数 - DBSCAN



## 概述

多变量时间序列具有多变量性和高冗余性，使用聚类分析从海量、高维的多变量时间序列数据中挖掘数据模式具有重要意义。**高级函数 DBSCAN** 离群检测基于历史数据对多条时间序列进行检测。

## 算法介绍

DBSCAN 是一种基于密度的聚类算法。它将密度达到一定阈值的区域划分为簇，并将低密度区域视为噪声。DBSCAN 算法不需要预先指定簇的数量，能够发现任意形状的簇，面噪声数据呈现出较好的鲁棒性。

**核心参数：**

> 距离（eps）：float, default=0.5

距离参数表示其中一个样本与另一个样本相邻，两个样本之间的最大距离，不是簇内点距离的最大界限。（float, default=0.5）

可选择配置 range(0-3.0) 之间的任意浮点值。如果不配置，默认距离参数为0.5，距离设置越大得到的异常点越少，距离值设置过小可能检测到的离群值非常多，距离值设置过大可能导致没有任何离群检测到，所以需要根据不同的数据特征设置合适的距离参数。

## 使用场景

在**场景**中选择**时序图**，点击**查询**下的**添加函数**按钮，选择**高级函数 > DBSCAN**，选定算法参数，视图中即可展示多条时间序列的离群效果。

- 检测对象：多条时间序列数据；
- 使用场景：适合同一组时序中发现离群时序的场景；
- 传参: 检测区间 T，距离参数；
- 含义: 从 [Now- T, Now] 中的多条时间线里, 有哪些时间线异常；
- 返回: 返回 1 到 n 条离群时间线。

## 示例演示

### 中心函数

用户加入观测云空间时，支持选择 DBSCAN。

DQL 查询示例写法：

```
DBSCAN(`M::cpu:(usage_idle)`, 0.5)
```

### 本地函数

本地函数数据处理流程如下：		

```
# 观测云前端UI——> DQL ——>Func 函数
```

示例算法：

```
'''
高级函数示例算法

示例处理内容为：    
1. 数据传入 DQL 语句
2. 返回算法处理后的结果

注意：  
    检测算法的入口函数固定为`AlgorithmScriptName(data,**kwargs)`
    data 为 DQL 查询数据后里面'series'的结构，示例结构如下：
        [
            {
              'name': 'cpu',
              'tags': {'image': 'nginx'},
              'columns': ['usage_total', 'last'],
              'values': [[1681200000000, 8],[1681202880000, 23],......]
              }
              ...
           ]
    **kwargs 为算法可选参数

入口函数：DBSCAN(data,eps)
输出示例：  
    [
        {
            'status'        : "abnormal_series",
                            # 标记此条时序数据是正常还是离群，离群 status 为 "abnormal_series"，正常 status 为 "normal_series"
            'name'          : 'cpu',
            "tags"          : {'image': 'nginx'},
            'colums'        : ['usage_total', 'last'],
            "values"        : [[1681274880000,8],[1681277760000,20],……],
        },
        ...
    ]
'''
```

用户 category 类别写法如下：

```
@DFF.API('用户自定义函数名称', category='guance.dqlFunc')
```

DQL 查询示例写法：

```
('用户自定义函数名称'`M::cpu:(usage_idle)`, **kwargs)
```

### 显示样式（todo）

- 配置后离群的效果：



- 如果没有离群，前端原数据展示：

