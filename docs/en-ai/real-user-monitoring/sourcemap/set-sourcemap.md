# SourceMap Configuration
---

Sourcemap (source code mapping) is used to map the compressed code in production environments back to the original source code. RUM supports this mapping of source file information by zipping and uploading corresponding symbol table files, allowing for automatic transformation of reported `error` Metrics data.

## Zip Package Preparation {#sourcemap-zip}

<!-- markdownlint-disable MD046 -->
=== "Web"

    Compress and zip the *.map* files generated from webpack-obfuscated and minified js files. Ensure that the file paths after unzipping match the URL paths in the `error_stack`. For example, consider the following `error_stack`:

    ```
    ReferenceError
      at a.hideDetail @ http://localhost:8080/static/js/app.7fb548e3d065d1f48f74.js:1:1037
      at a.showDetail @ http://localhost:8080/static/js/app.7fb548e3d065d1f48f74.js:1:986
      at <anonymous> @ http://localhost:8080/static/js/app.7fb548e3d065d1f48f74.js:1:1174
    ```

    The path to be converted is */static/js/app.7fb548e3d065d1f48f74.js*, with its corresponding sourcemap path being */static/js/app.7fb548e3d065d1f48f74.js.map*. Therefore, the directory structure after unzipping should be as follows:

    ```
    static/
    └── js
        └── app.7fb548e3d065d1f48f74.js.map
    ```

    Converted `error_stack_source`:
    
    ```
    ReferenceError
      at a.hideDetail @ webpack:///src/components/header/header.vue:94:0
      at a.showDetail @ webpack:///src/components/header/header.vue:91:0
      at <anonymous> @ webpack:///src/components/header/header.vue:101:0
    ```

=== "Mini Program"

    The packaging method is largely consistent with Web.

=== "Android"

    There are two types of `sourcemap` files on Android: one is the mapping file generated by Java bytecode compression and obfuscation using `R8`/`Proguard`, and the other is the unstripped `.so` file containing symbol tables and debugging information for C/C++ native code. If your Android application contains both types of `sourcemap` files, you need to include both in the zip package. The directory structure after unzipping is similar to:

    ```
    <app_id>-<env>-<version>/
    ├── mapping.txt
    ├── armeabi-v7a/
    │   ├── libgameengine.so
    │   ├── libothercode.so
    │   └── libvideocodec.so
    ├── arm64-v8a/
    │   ├── libgameengine.so
    │   ├── libothercode.so
    │   └── libvideocodec.so
    ├── x86/
    │   ├── libgameengine.so
    │   ├── libothercode.so
    │   └── libvideocodec.so
    └── x86_64/
        ├── libgameengine.so
        ├── libothercode.so
        └── libvideocodec.so
    ```

    By default, the mapping file is located at: *<project folder\>/<Module\>/build/outputs/mapping/<build-type\>/*, and `.so` files are located at: *<project folder\>/<Module\>/build/intermediates/cmake/debug/obj/* when using CMake (debug build) or *<project folder\>/<Module\>/build/intermediates/ndk/release/obj/* (release build).

    Conversion effect:

    === "Java/Kotlin"

        Original `error_stack`:

        ```
        java.lang.ArithmeticException: divide by zero
            at prof.wang.activity.TeamInvitationActivity.o0(Unknown Source:1)
            at prof.wang.activity.TeamInvitationActivity.k0(Unknown Source:0)
            at j9.f7.run(Unknown Source:0)
            at java.lang.Thread.run(Thread.java:1012)
        ```
        
        Converted `error_stack_source`:
    
        ```
        java.lang.ArithmeticException: divide by zero
        at prof.wang.activity.TeamInvitationActivity.onClick$lambda-0(TeamInvitationActivity.java:1)
        at java.lang.Thread.run(Thread.java:1012)
        ```

    === "C/C++ Native Code"

        Original `error_stack`:
    
        ```
        backtrace:
        #00 pc 00000000000057fc  /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_4+12)
        #01 pc 00000000000058a4  /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_3+8)
        #02 pc 00000000000058b4  /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_2+12)
        #03 pc 00000000000058c4  /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_1+12)
        #04 pc 0000000000005938  /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_crash+112)
        ...
        ```
        
        Converted `error_stack_source`:
    
        ```
        backtrace:
        
        Abort message: 'abort message for ftNative internal testing'
        #00 0x00000000000057fc /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_4+12)
        xc_test_call_4
        /Users/Brandon/Documents/workplace/working/StudioPlace/xCrash/xcrash_lib/src/main/cpp/xcrash/xc_test.c:65:9
        #01 0x00000000000058a4 /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_3+8)
        xc_test_call_3
        /Users/Brandon/Documents/workplace/working/StudioPlace/xCrash/xcrash_lib/src/main/cpp/xcrash/xc_test.c:73:13
        #02 0x00000000000058b4 /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_2+12)
        xc_test_call_2
        /Users/Brandon/Documents/workplace/working/StudioPlace/xCrash/xcrash_lib/src/main/cpp/xcrash/xc_test.c:79:13
        #03 0x00000000000058c4 /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_call_1+12)
        xc_test_call_1
        /Users/Brandon/Documents/workplace/working/StudioPlace/xCrash/xcrash_lib/src/main/cpp/xcrash/xc_test.c:85:13
        #04 0x0000000000005938 /data/app/~~Taci3mQyw7W7iWT7Jxo-ag==/com.ft-Q8m2flQFG1MbGImPiuAZmQ==/lib/arm64/libft_native_exp_lib.so (xc_test_crash+112)
        xc_test_crash
        /Users/Brandon/Documents/workplace/working/StudioPlace/xCrash/xcrash_lib/src/main/cpp/xcrash/xc_test.c:126:9
        ...
        ```

=== "iOS"

    On iOS platforms, `sourcemap` files have a `.dSYM` extension and contain debug symbols. Typically, they are located in the same directory as the `.app` file after compilation, as shown below:

    ``` shell
    $ ls -l Build/Products/Debug-iphonesimulator/
    total 0
    drwxr-xr-x   6 zy  staff  192  8  9 15:27 Fishing.app
    drwxr-xr-x   3 zy  staff   96  8  9 14:02 Fishing.app.dSYM
    drwxr-xr-x  15 zy  staff  480  8  9 15:27 Fishing.doccarchive
    drwxr-xr-x   6 zy  staff  192  8  9 13:55 Fishing.swiftmodule
    ```

    Note that Xcode Release builds generate `.dSYM` files by default, while Debug builds do not unless configured as follows:

    ```not-set
    Build Settings -> Code Generation -> Generate Debug Symbols -> Yes
    Build Settings -> Build Option -> Debug Information Format -> DWARF with dSYM File
    ```

    When zipping, include the corresponding `.dSYM` files in the zip package. If your project involves multiple `.dSYM` files, zip them together. Place the zip package in *<DataKit installation directory\>/data/rum/ios*. The directory structure after unzipping should resemble the following (`.dSYM` files are directories like macOS executable *.app* files):

    ```
    <app_id>-<env>-<version>/
    ├── AFNetworking.framework.dSYM
    │   └── Contents
    │       ├── Info.plist
    │       └── Resources
    │           └── DWARF
    │               └── AFNetworking
    └── App.app.dSYM
        └── Contents
            ├── Info.plist
            └── Resources
                └── DWARF
                    └── App
    ```

=== "React Native"

    React Native `sourcemap` includes native iOS, Android, and js parts, totaling three types of source maps.
    
    Refer to the respective packaging instructions for obtaining native iOS and Android `sourcemap` files.

    To obtain the js part of the sourcemap:
    
    **Android** source mapping is enabled by default. The source map file is located at `android/app/build/generated/sourcemaps/react/release/index.android.bundle.map`.
   
    **iOS** requires additional configuration to enable source map generation. Open Xcode and edit the "Bundle React Native code and images" build phase. Add a `SOURCEMAP_FILE` entry with the desired output path above other export items.
    
    ```shell
    set -e
    # output source maps
    export SOURCEMAP_FILE="./main.jsbundle.map";
    ```
    
    **With Hermes, React Native <0.71**
    
    ```shell
    set -e
    # output source maps
    export SOURCEMAP_FILE="./main.jsbundle.map";
    # For React Native 0.70, set USE_HERMES to true if Hermes is used; otherwise, source maps won't be generated.
    export USE_HERMES=true 
    
    # keep the rest of the script unchanged
    
    # For React Native (0.69, 0.71) and using Hermes
    # add these lines to compose the packager and compiler source maps into one file
    REACT_NATIVE_DIR=../node_modules/react-native
    
    if [ -f "$REACT_NATIVE_DIR/scripts/find-node-for-xcode.sh" ]; then
        source "$REACT_NATIVE_DIR/scripts/find-node-for-xcode.sh"
    else
        # Before RN 0.70, the script was named find-node.sh
        source "$REACT_NATIVE_DIR/scripts/find-node.sh"
    fi
    source "$REACT_NATIVE_DIR/scripts/node-binary.sh"
    "$NODE_BINARY" "$REACT_NATIVE_DIR/scripts/compose-source-maps.js" "$CONFIGURATION_BUILD_DIR/main.jsbundle.map" "$CONFIGURATION_BUILD_DIR/$UNLOCALIZED_RESOURCES_FOLDER_PATH/main.jsbundle.map" -o "../$SOURCEMAP_FILE"
    ```

    After obtaining the js sourcemap file, zip it along with the corresponding native sourcemaps according to the following format:
    
    ```
    // Android
    <app_id>-<env>-<version>/
    ├── js/
        ├── main.jsbundle.map 
    └── android/
        ├── mapping.txt
        ├── armeabi-v7a/
        │   ├── libgameengine.so
        │   ├── libothercode.so
        │   └── libvideocodec.so
        └── arm64-v8a/
            ├── libgameengine.so
            ├── libothercode.so
            └── libvideocodec.so	
    ```
    
    ```
    // iOS
    <app_id>-<env>-<version>/
    ├── js/
        ├── main.jsbundle.map 
    └── ios/
        ├── AFNetworking.framework.dSYM
        │   └── Contents
        │       ├── Info.plist
        │       └── Resources
        │           └── DWARF
        │               └── AFNetworking
        └── App.app.dSYM
            └── Contents
                ├── Info.plist
                └── Resources
                    └── DWARF
                        └── App
    ```

<!-- markdownlint-enable -->

---

You can use tools such as [**source-map-visualization**](https://evanw.github.io/source-map-visualization/) to verify the availability of the files.

## File Upload and Deletion {#upload}

After configuring the packaging, users can directly upload and delete files via the front-end page.

![SourceMap Upload](../../img/sourcemap_01.png)

Below the 🔍 bar, you can view uploaded file names and application types, search by file name, and click :fontawesome-regular-trash-can: to delete the current file.

**Upload Guidelines**:

1. File size must not exceed 500M;
2. File format must be `.zip`;
3. Ensure the file paths after unzipping match the URL paths in the `error_stack`;
4. Do not upload multiple files simultaneously;
5. Uploading files with the same name will result in an overwrite prompt, so please be cautious.

Additionally, Datakit collector configuration supports SourceMap conversion.

> For more details, see [SourceMap Conversion](../../integrations/rum.md#sourcemap).