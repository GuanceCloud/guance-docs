# Uploading SourceMap During Project Build

Guance currently provides a `webpack` plugin that can easily upload the corresponding directory's SourceMap files during the Web project build process, solving the complicated manual upload process.

**Note**: Currently supports uploading for Web applications.

## Preparation

1. [Obtain](../../open-api/index.md) the `OpenApi` domain address for the corresponding site;
2. Obtain the required `API KEY` for the corresponding `OpenApi` from Guance [here](../../open-api/signature-certification.md);
3. Obtain the `applicationId`, `env`, and `version` information for the Web application on the Guance platform. If there is no application, you need to [create a new application](../web/app-access.md);
4. Preparation complete.

## Webpack

Install [@cloudcare/webpack-plugin](https://www.npmjs.com/package/@cloudcare/webpack-plugin)

```js
npm install @cloudcare/webpack-plugin --save-dev
```

Modify the `plugins` option in the `webpack.config.js` file

```js
// ....
const { GuanceSourceMapUploadWebpackPlugin } = require('@cloudcare/webpack-plugin')
module.exports = ({ mode }) => ({
  //.....
  devtool: 'hidden-source-map',
  plugins: [
    //.....
    new GuanceSourceMapUploadWebpackPlugin({
      applicationId: 'xxxxx', // Guance application appid
      apiKey: 'xxxxxxxx', // Open API key
      server: 'https://console.guance-xxx.cn',
      filepaths: ['dist/'], // Directories/files to search, can be a file or directory
      logLevel: 'verbose', // Log level, optional
      root: 'dist/', // Directory for relative path calculation, optional
      env: 'production', // Environment of the Guance application, optional
      version: '1.0.0', // Version of the Guance application, optional
    }),
  ],
})
```

### Configuration Explanation for SourceMap WebpackPlugin

```typescript
interface Options {
  /**
   *
   * Files/directories to search for sourcemaps.
   * All files matching the "extensions configuration" list but not matching the "ignore configuration" will be searched
   * for sourcemap JSON or `//#sourceMappingURL=` comments to find generated files + source mappings pairs, which will then be uploaded.
   */
  filepaths: Array<string> | string

  /**
   * OpenApi Key generated by the Guance platform, refer to (https://docs.guance.com/management/api-key/open-api/#_1) for generation method
   */
  apiKey: string

  /**
   * Guance OpenAPI service
   */
  server: string
  /**
   * ApplicationId of the corresponding RUM application on the Guance platform (required)
   */
  applicationId: string
  /**
   * Version of the corresponding RUM application on the Guance platform (optional)
   */
  version?: string
  /**
   * Environment of the corresponding RUM application on the Guance platform (optional)
   */
  env?: string

  /**
   * Find all matching files but do not upload them, useful for debugging
   */
  dryRun?: boolean

  /**
   * Delete all found source map files after upload.
   */
  deleteAfterUpload?: boolean
  /**
   * If a source map cannot be matched to a generated file via sourceMappingURL, try to match by filename on the local disk
   */
  matchSourcemapsByFilename?: boolean

  /**
   * List of file extensions to search within directories
   * Default [".js", ".map"].
   */
  extensions?: Array<string>

  /**
   * List of files to ignore
   */
  ignore?: Array<string>

  /**
   * Directory for relative path calculation. The relative path of the uploaded sourcemaps should be included in the error path,
   * so this parameter controls the relative directory for uploads
   * Default is `process.cwd()`.
   */
  root?: string
  /**
   * Debug log level
   */
  logLevel?: 'quiet' | 'normal' | 'verbose'
}
```

### Visibility of SourceMap in Production

In production environments, for security reasons, we typically do not retain SourceMap files. These files allow developers to map minified or compiled code back to original source code, but if exposed publicly, they may reveal the internal logic of the application, increasing security risks.

To securely handle SourceMaps, you can enable the `deleteAfterUpload: true` option when configuring the `GuanceSourceMapUploadWebpackPlugin`. This ensures that once the SourceMap is uploaded to the server, it is immediately deleted from the local file system, ensuring it does not remain in the production environment.

Additionally, by setting Webpack's `devtool` to `"hidden-source-map"`, you can generate SourceMaps without including any references to them in the JavaScript files. This prevents browsers from attempting to download and view the source code.

If `"hidden-source-map"` is enabled, you should also set `matchSourcemapsByFilename: true` in the `GuanceSourceMapUploadWebpackPlugin` plugin. This configuration ensures the plugin can identify and upload the corresponding SourceMap files based on the JavaScript file names, even if they are not explicitly referenced in the generated code.

Through these measures, you can maintain the convenience of debugging while effectively protecting the security of your source code.

```js
const { GuanceSourceMapUploadWebpackPlugin } = require('@cloudcare/webpack-plugin')

module.exports = {
  // Ensure that Webpack has been configured to output sourcemaps,
  // but without the `sourceMappingURL` references in build artifacts.
  devtool: 'hidden-source-map',
  // ...
  plugins: [
    // Enable our plugin to upload the sourcemaps once the build has completed.
    // This assumes NODE_ENV is how you distinguish production builds. If that
    // is not the case for you, you will have to tweak this logic.
    process.env.NODE_ENV === 'production'
      ? [
          new GuanceSourceMapUploadWebpackPlugin({
            ...
            deleteAfterUpload: true,
            matchSourcemapsByFilename: true,
          }),
        ]
      : [],
  ],
}
```

### How to DEBUG

If the correct SourceMap is not found during execution, you can set the environment variable `DEBUG=guance:sourcemap-upload` or configure `logLevel: verbose` and run the build command to view detailed logs.

### Precautions

### Node Version `> 10.13`

### Important Notes for `filepaths` and `root` Configuration:

1. In the Guance console, an error line might appear as `at SVGGElement.<anonymous> @ http://localhost:8000/js/chunk-vendors.732b3b98.js:1:93427`

2. The relative path of the file causing the error is `js/chunk-vendors.732b3b98.js`

3. If the static directory for JS files on the server is `dist/js/*.js` `dist/js/*.js.map`

4. Plugin configuration `filepaths: ['dist']`

5. Without configuring `root`, the default upload path for SourceMap files to the Guance server would be `dist/js/**.js.map`

6. In this case, the **upload file path** would not match the **error path**, so you should add the configuration `root:'dist/'` to ensure the upload path is `js/**.js.map`.