# Integration of Mini Programs Based on the Uniapp Development Framework
---

???- quote "Changelog"

    **2022.9.29**: A new initialization parameter `isIntakeUrl` has been added to determine whether to collect data for corresponding resources based on the request resource URL. By default, all resources are collected.

	**2022.3.29**:

	- Added the `traceType` configuration to specify the tracing tool type. If not configured, it defaults to `ddtrace`. Currently supports 6 types: `ddtrace`, `zipkin`, `skywalking_v3`, `jaeger`, `zipkin_single_header`, and `w3c_traceparent`.
	- Added `allowedTracingOrigins` to allow a list of origins or regular expressions where trace headers can be injected.


## Prerequisites

- Install [DataKit](../../datakit/datakit-install.md).

## Application Integration

Log in to the Guance console, navigate to the **User Analysis** page, and click the [Create New Application](../index.md#create) button in the top-left corner to start creating a new application.

On the right side, select the integration method, click **Parameter Configuration**, fill in the required parameters, and then copy the code to your project.

![](../img/6.rum_uniapp.png)

## Usage Instructions

In the entry file `main.js` of your Uniapp project, add the following code at the top:

### NPM

=== "VUE 2" 

	Include (refer to the official [NPM inclusion method](https://uniapp.dcloud.net.cn/frame?id=npm%e6%94%af%e6%8c%81))
	
	```javascript
	...
	import Vue from 'vue'
	//#ifndef H5 || APP-PLUS || APP-NVUE || APP-PLUS-NVUE
	const { datafluxRum } = require('@cloudcare/rum-uniapp')
	// Initialize RUM
	datafluxRum.init(Vue, {
	  datakitOrigin: '<DATAKIT ORIGIN>', // Required, DataKit domain name; must be added to the whitelist in the WeChat Mini Program management backend
      applicationId: '<Application ID>', // Required, generated by the dataflux platform
      env: 'testing', // Optional, environment of the mini program
      version: '1.0.0', // Optional, version of the mini program
      service: 'miniapp', // Service name of the current application
      trackInteractions: true, // User interaction data
      sampleRate: 100, // Percentage of metrics data collection, 100 means full collection, 0 means no collection
      allowedTracingOrigins: ['https://api.example.com',/https:\/\/.*\.my-api-domain\.com/],  // Optional, list of origins or regex patterns that allow injection of trace headers
	})
	//#endif
	....
	```
=== "VUE 3" 

	Include (refer to the official [NPM inclusion method](https://uniapp.dcloud.net.cn/frame?id=npm%e6%94%af%e6%8c%81))
	
	```javascript hl_lines="5"
	...
	//#ifndef H5 || APP-PLUS || APP-NVUE || APP-PLUS-NVUE
	import { datafluxRum } from '@cloudcare/rum-uniapp'
	// Initialize RUM
	datafluxRum.initVue3({
	  datakitOrigin: '<DATAKIT ORIGIN>', // Required, DataKit domain name; must be added to the whitelist in the WeChat Mini Program management backend
      applicationId: '<Application ID>', // Required, generated by the dataflux platform
      env: 'testing', // Optional, environment of the mini program
      version: '1.0.0', // Optional, version of the mini program
      service: 'miniapp', // Service name of the current application
      trackInteractions: true, // User interaction data
      sampleRate: 100, // Percentage of metrics data collection, 100 means full collection, 0 means no collection
      allowedTracingOrigins: ['https://api.example.com',/https:\/\/.*\.my-api-domain\.com/],  // Optional, list of origins or regex patterns that allow injection of trace headers
	})
	//#endif
	....
	```
### CDN

=== "VUE 2" 

	Download and include locally ([download link](https://static.guance.com/miniapp-sdk/v2/dataflux-rum-uniapp.js))
	
	```javascript
	...
	import Vue from 'vue'
	//#ifndef H5 || APP-PLUS || APP-NVUE || APP-PLUS-NVUE
	const { datafluxRum } = require('./dataflux-rum-miniapp.js'); // Local path to JS file
	// Initialize RUM
	datafluxRum.init(Vue, {
	  datakitOrigin: '<DATAKIT ORIGIN>', // Required, DataKit domain name; must be added to the whitelist in the WeChat Mini Program management backend
      applicationId: '<Application ID>', // Required, generated by the dataflux platform
      env: 'testing', // Optional, environment of the mini program
      version: '1.0.0', // Optional, version of the mini program
      service: 'miniapp', // Service name of the current application
      trackInteractions: true, // User interaction data
      sampleRate: 100, // Percentage of metrics data collection, 100 means full collection, 0 means no collection
      allowedTracingOrigins: ['https://api.example.com',/https:\/\/.*\.my-api-domain\.com/],  // Optional, list of origins or regex patterns that allow injection of trace headers
	})
	//#endif
	....
	```
=== "VUE 3" 

	Download and include locally ([download link](https://static.guance.com/miniapp-sdk/v2/dataflux-rum-uniapp.js))
	
	```javascript hl_lines="5"
	...
	//#ifndef H5 || APP-PLUS || APP-NVUE || APP-PLUS-NVUE
	import { datafluxRum } from './dataflux-rum-miniapp.js'; // Local path to JS file
	// Initialize RUM
	datafluxRum.initVue3({
	  datakitOrigin: '<DATAKIT ORIGIN>', // Required, DataKit domain name; must be added to the whitelist in the WeChat Mini Program management backend
      applicationId: '<Application ID>', // Required, generated by the dataflux platform
      env: 'testing', // Optional, environment of the mini program
      version: '1.0.0', // Optional, version of the mini program
      service: 'miniapp', // Service name of the current application
      trackInteractions: true, // User interaction data
      sampleRate: 100, // Percentage of metrics data collection, 100 means full collection, 0 means no collection
      allowedTracingOrigins: ['https://api.example.com',/https:\/\/.*\.my-api-domain\.com/],  // Optional, list of origins or regex patterns that allow injection of trace headers
	})
	//#endif
	....
	```

## Configuration

### Initialization Parameters

| Parameter                        | Type   | Required | Default Value | Description                                                                                                                                                                                                                                                                                                                                                                                     |
| --------------------------------- | ------ | -------- | ------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `applicationId`                  | String | Yes     |               | The Application ID created in Guance.                                                                                                                                                                                                                                                                                                                                                          |
| `datakitOrigin`                  | String | Yes     |               | DataKit data reporting Origin.<br/>:warning: Must be added to the request whitelist in the Mini Program management backend.                                                                                                                                                                                                                                                                 |
| `env`                            | String | No      |               | Current environment of the mini program, such as prod: production environment; gray: gray release environment; pre: pre-release environment; common: daily environment; local: local environment.                                                                                                                                                                                        |
| `version`                        | String | No      |               | Version number of the mini program.                                                                                                                                                                                                                                                                                                                                                            |
| `service`                        | String | No      | `miniapp`     | Service name of the current application, default is `miniapp`, supports custom configuration. |
| `sampleRate`                     | Number | No      | `100`         | Percentage of metrics data collection. <br>`100` indicates full collection, `0` indicates no collection.                                                                                                                                                                                                                                                                                      |
| `trackInteractions`              | Boolean | No     | `false`       | Whether to enable user interaction tracking.                                                                                                                                                                                                                                                                                                                                                    |
| `traceType`                      | Enum   | No      | `ddtrace`     | Specifies the tracing tool type. If not configured, defaults to `ddtrace`. Currently supports 6 types: `ddtrace`, `zipkin`, `skywalking_v3`, `jaeger`, `zipkin_single_header`, `w3c_traceparent`.<br> :warning: <br>1. `opentelemetry` supports `zipkin_single_header`, `w3c_traceparent`, `zipkin`, `jaeger`.<br>2. Configuring `traceType` requires setting different `Access-Control-Allow-Headers` for API services, refer to [APM Connecting RUM](../../application-performance-monitoring/collection/connect-web-app.md). |
| `traceId128Bit`                  | Boolean | No     | `false`       | Whether to generate `traceID` using 128-bit format, corresponding to `traceType`. Supports `zipkin` and `jaeger`.                                                                                                                                                                                                                                                                               |
| `allowedTracingOrigins`          | Array  | No      | `[]`          | List of origins or regex patterns that allow injection of trace headers. Can be an origin or a regex pattern, e.g., `["https://api.example.com", /https:\\/\\/.*\\.my-api-domain\\.com/]`.                                                                                                                                                                                                    |
| `isIntakeUrl`                    | Function | No     | `function(url) {return false}` | Custom function to determine whether to collect data for specific resources based on the request URL. Returns `false` to collect, `true` to skip. <br>:warning: <br>1. The function must return a Boolean value, otherwise it is considered invalid.<br>2. Requires version 2.1.13 or higher. |

**Note**:

1. The `datakitOrigin` domain must be added to the request whitelist in the Mini Program management backend.
2. Due to lack of unified performance APIs across platforms, some performance data may not be fully collected, such as `Mini Program startup`, `package download`, `script injection`, etc., which might be missing on platforms other than WeChat.
3. The `profile` field in the response data of `uni.request` and `uni.downloadFile` is not supported on iOS WeChat Mini Programs, leading to incomplete timing-related data collection. There is currently no solution: [request](https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html), [downloadFile](https://developers.weixin.qq.com/miniprogram/dev/api/network/download/wx.downloadFile.html), [API support status](https://developers.weixin.qq.com/community/develop/doc/000ecaa8b580c80601cac8e6f56000?highLine=%2520request%2520profile).
4. When `trackInteractions` is enabled, due to restrictions in WeChat Mini Programs, structural and content data of UI elements cannot be collected. In the SDK, declarative programming is used by setting the `data-name` attribute to identify interactive elements for easier tracking and analysis, e.g.:

```javascript
 <button bindtap="bindSetData" data-name="setData">setData</button>
```