# Integration of Mini Programs Based on the Uniapp Development Framework
---

???- quote "Changelog"

    **2022.9.29**: Added `isIntakeUrl` configuration to the initialization parameters, used to determine whether to collect data for corresponding resources based on request resource URLs. By default, all resources are collected.

	**2022.3.29**:

	- Added `traceType` configuration to specify the type of tracing tool. If not configured, it defaults to `ddtrace`. Currently supports 6 data types: `ddtrace`, `zipkin`, `skywalking_v3`, `jaeger`, `zipkin_single_header`, and `w3c_traceparent`.
	- Added `allowedTracingOrigins` to allow a list of origins or regex patterns for requests that can inject trace headers.


## Prerequisites

- Install [DataKit](../../datakit/datakit-install.md).

## Application Integration

Log in to the <<< custom_key.brand_name >>> console, navigate to the **Synthetic Tests** page, click on the top-left [Create] button to start creating a new application.

On the right side, select the installation method, click on **Parameter Configuration**, fill in the relevant configuration parameters, and then copy them into your project.

![](../img/6.rum_uniapp.png)

## Usage Instructions

In the entry file of your Uniapp project `main.js`, introduce the code as follows at the top:

### NPM

=== "VUE 2" 

	Include (refer to the official [npm introduction method](https://uniapp.dcloud.net.cn/frame?id=npm%e6%94%af%e6%8c%81))
	
	```javascript
	...
	import Vue from 'vue'
	//#ifndef H5 || APP-PLUS || APP-NVUE || APP-PLUS-NVUE
	const { datafluxRum } = require('@cloudcare/rum-uniapp')
	// Initialize RUM
	datafluxRum.init(Vue, {
	  datakitOrigin: '<DATAKIT ORIGIN>', // Required, Datakit domain address; needs to be added to the whitelist in the WeChat Mini Program management backend
      applicationId: '<Application ID>', // Required, application ID generated by dataflux platform
      env: 'testing', // Optional, environment of the mini program
      version: '1.0.0', // Optional, version of the mini program
      service: 'miniapp', // Service name of the current application
      trackInteractions: true, // User interaction data
      sampleRate: 100, // Percentage of metric data collection, 100 means full collection, 0 means no collection
      allowedTracingOrigins: ['https://api.example.com', /https:\/\/.*\.my-api-domain\.com/],  // Optional, list of origins or regex patterns for requests that can inject trace headers
	})
	//#endif
	....
	```
=== "VUE 3" 

	Include (refer to the official [npm introduction method](https://uniapp.dcloud.net.cn/frame?id=npm%e6%94%af%e6%8c%81))
	
	```javascript hl_lines="5"
	...
	//#ifndef H5 || APP-PLUS || APP-NVUE || APP-PLUS-NVUE
	import { datafluxRum } from '@cloudcare/rum-uniapp'
	// Initialize RUM
	datafluxRum.initVue3({
	  datakitOrigin: '<DATAKIT ORIGIN>', // Required, Datakit domain address; needs to be added to the whitelist in the WeChat Mini Program management backend
      applicationId: '<Application ID>', // Required, application ID generated by dataflux platform
      env: 'testing', // Optional, environment of the mini program
      version: '1.0.0', // Optional, version of the mini program
      service: 'miniapp', // Service name of the current application
      trackInteractions: true, // User interaction data
      sampleRate: 100, // Percentage of metric data collection, 100 means full collection, 0 means no collection
      allowedTracingOrigins: ['https://api.example.com', /https:\/\/.*\.my-api-domain\.com/],  // Optional, list of origins or regex patterns for requests that can inject trace headers
	})
	//#endif
	....
	```
### CDN

=== "VUE 2" 

	Local inclusion by downloading files ([download link](https://<<< custom_key.static_domain >>>/miniapp-sdk/v2/dataflux-rum-uniapp.js))
	
	```javascript
	...
	import Vue from 'vue'
	//#ifndef H5 || APP-PLUS || APP-NVUE || APP-PLUS-NVUE
	const { datafluxRum } = require('./dataflux-rum-miniapp.js'); // Local path to JS file
	// Initialize RUM
	datafluxRum.init(Vue, {
	  datakitOrigin: '<DATAKIT ORIGIN>', // Required, Datakit domain address; needs to be added to the whitelist in the WeChat Mini Program management backend
      applicationId: '<Application ID>', // Required, application ID generated by dataflux platform
      env: 'testing', // Optional, environment of the mini program
      version: '1.0.0', // Optional, version of the mini program
      service: 'miniapp', // Service name of the current application
      trackInteractions: true, // User interaction data
      sampleRate: 100, // Percentage of metric data collection, 100 means full collection, 0 means no collection
      allowedTracingOrigins: ['https://api.example.com', /https:\/\/.*\.my-api-domain\.com/],  // Optional, list of origins or regex patterns for requests that can inject trace headers
	})
	//#endif
	....
	```
=== "VUE 3" 

	Local inclusion by downloading files ([download link](https://<<< custom_key.static_domain >>>/miniapp-sdk/v2/dataflux-rum-uniapp.js))
	
	```javascript hl_lines="5"
	...
	//#ifndef H5 || APP-PLUS || APP-NVUE || APP-PLUS-NVUE
	import { datafluxRum } from './dataflux-rum-miniapp.js'; // Local path to JS file
	// Initialize RUM
	datafluxRum.initVue3({
	  datakitOrigin: '<DATAKIT ORIGIN>', // Required, Datakit domain address; needs to be added to the whitelist in the WeChat Mini Program management backend
      applicationId: '<Application ID>', // Required, application ID generated by dataflux platform
      env: 'testing', // Optional, environment of the mini program
      version: '1.0.0', // Optional, version of the mini program
      service: 'miniapp', // Service name of the current application
      trackInteractions: true, // User interaction data
      sampleRate: 100, // Percentage of metric data collection, 100 means full collection, 0 means no collection
      allowedTracingOrigins: ['https://api.example.com', /https:\/\/.*\.my-api-domain\.com/],  // Optional, list of origins or regex patterns for requests that can inject trace headers
	})
	//#endif
	....
	```

## Configuration

### Initialization Parameters

| Parameter                       | Type   | Required | Default Value | Description                                                                                                                                                                                                                                                                                                                                                                                               |
| ------------------------------- | ------ | -------- | ------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `applicationId`                 | String | Yes      |               | Application ID created in <<< custom_key.brand_name >>>.                                                                                                                                                                                                                                                                                                                                                 |
| `datakitOrigin`                 | String | Yes      |               | DataKit data reporting Origin;<br/>:warning: Must be added to the request whitelist in the mini program management backend.                                                                                                                                                                                                                                                                              |
| `env`                           | String | No       |               | Current environment of the mini program, such as prod: production environment; gray: gray release environment; pre: pre-release environment; common: daily environment; local: local environment.                                                                                                                                                                                                 |
| `version`                       | String | No       |               | Version number of the mini program.                                                                                                                                                                                                                                                                                                                                                                     |
| `service`                       | String | No       | `miniapp`     | Service name of the current application, default is `miniapp`, supports custom configuration.                                                                                                                                                                                                                                                                                                          |
| `sampleRate`                    | Number | No       | `100`         | Percentage of metric data collection.                                                                                                                                                                                                                                                                                                                                                                   |
| `trackInteractions`             | Boolean| No       | `false`       | Whether to enable user interaction collection.                                                                                                                                                                                                                                                                                                                                                          |
| `traceType`                     | Enum   | No       | `ddtrace`     | Configure the type of tracing tool. Defaults to `ddtrace` if not configured. Supports 6 data types: `ddtrace`, `zipkin`, `skywalking_v3`, `jaeger`, `zipkin_single_header`, `w3c_traceparent`.<br>:warning:<br>1. `opentelemetry` supports `zipkin_single_header`, `w3c_traceparent`, `zipkin`, `jaeger` four types.<br>2. Configuring the corresponding `traceType` requires setting different `Access-Control-Allow-Headers` for the API service. Refer to [How APM Connects with RUM](../../application-performance-monitoring/collection/connect-web-app.md). |
| `traceId128Bit`                 | Boolean| No       | `false`       | Whether to generate `traceID` using 128-bit format, corresponding to `traceType`. Currently supports types `zipkin`, `jaeger`.                                                                                                                                                                                                                                                                         |
| `allowedTracingOrigins`         | Array  | No       | `[]`          | List of origins or regex patterns for requests that can inject trace headers. Can be an origin or a regex pattern, e.g., `["https://api.example.com", /https:\\/\\/.*\\.my-api-domain\\.com/]`.                                                                                                                                                                                                      |
| `isIntakeUrl`                   | Function| No       | `function(url) {return false}` | Custom function to determine whether to collect data for specific resource URLs. Returns `false` to collect, `true` to skip. <br>:warning:<br>1. The return value must be of Boolean type, otherwise it is considered invalid.<br>2. Requires version 2.1.13 or higher. |

**Note**:

1. The DataKit domain specified by `datakitOrigin` must be added to the request whitelist in the mini program management backend.
2. Due to lack of unified exposure of performance data APIs across platforms, some performance data may not be fully collected, such as `mini program launch`, `mini program package download`, `script injection`, etc. This issue exists on platforms other than WeChat.
3. The `profile` field in the response data of `uni.request` and `uni.downloadFile` is currently unsupported on iOS systems for WeChat Mini Programs, leading to incomplete collection of timing-related data. There is currently no solution: [request](https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html), [downloadFile](https://developers.weixin.qq.com/miniprogram/dev/api/network/download/wx.downloadFile.html), [API Support Status](https://developers.weixin.qq.com/community/develop/doc/000ecaa8b580c80601cac8e6f56000?highLine=%2520request%2520profile).
4. When `trackInteractions` is enabled, due to restrictions in WeChat Mini Programs, it is not possible to collect control content and structure data. Therefore, we use declarative programming in the SDK, setting the `data-name` attribute to add names to interactive elements for easier statistical analysis and operation record location, for example:

```javascript
 <button bindtap="bindSetData" data-name="setData">setData</button>
```