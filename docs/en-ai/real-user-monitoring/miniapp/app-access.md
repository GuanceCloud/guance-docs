# WeChat Mini Program Application Integration
---

<<< custom_key.brand_name >>> application monitoring can collect metric data from various mini programs. By introducing the SDK file, it monitors the performance metrics, error logs, and resource request data of mini programs. After reporting this data to the <<< custom_key.brand_name >>> platform, it analyzes the performance of each mini program in a visual manner.

## Prerequisites

**Note**: If you have enabled the [RUM Headless](../../dataflux-func/headless.md) service, the prerequisites are automatically configured for you, so you can directly integrate the application.

- Install [DataKit](../../datakit/datakit-install.md);
- Configure the [RUM Collector](../../integrations/rum.md);
- Ensure DataKit is [accessible over the public network and has the IP geolocation database installed](../../datakit/datakit-tools-how-to.md#install-ipdb).

## Application Integration

Log in to the <<< custom_key.brand_name >>> console, go to the **User Analysis** page, click on **[Create](../index.md#create)** in the top-left corner to start creating a new application.

![](../img/6.rum_miniapp.png)

## Usage

Introduce the code into the app.js file of the mini program as follows:

**Note**: The introduction position must be before the App() initialization.

=== "NPM"

	NPM package introduction can refer to the official WeChat documentation on [npm introduction](https://developers.weixin.qq.com/miniprogram/dev/devtools/npm.html)
	
	```javascript
    const { datafluxRum } = require('@cloudcare/rum-miniapp')
    // Initialize Rum
    datafluxRum.init({
      datakitOrigin: '<DATAKIT ORIGIN>',// Required, DataKit domain address; needs to be added to the whitelist in the WeChat Mini Program management backend
      applicationId: '<Application ID>', // Required, application ID generated by the dataflux platform
      env: 'testing', // Optional, environment of the mini program
      version: '1.0.0', // Optional, version of the mini program
      service: 'miniapp', // Service name of the current application
      trackInteractions: true,
      traceType: 'ddtrace', // Not required, defaults to ddtrace; currently supports 6 types: ddtrace, zipkin, skywalking_v3, jaeger, zipkin_single_header, w3c_traceparent
      allowedTracingOrigins: ['https://api.example.com',/https:\/\/.*\.my-api-domain\.com/],  // Not required, list of origins or regex patterns for requests that allow trace headers
    })
	```

=== "CDN"

	[Download file](https://<<< custom_key.static_domain >>>/miniapp-sdk/v2/dataflux-rum-miniapp.js) for local inclusion
	
	```javascript
    const { datafluxRum } = require('./lib/dataflux-rum-miniapp.js')
    // Initialize Rum
    datafluxRum.init({
      datakitOrigin: '<DATAKIT ORIGIN>',// Required, DataKit domain address; needs to be added to the whitelist in the WeChat Mini Program management backend
      applicationId: '<Application ID>', // Required, application ID generated by the dataflux platform
      env: 'testing', // Optional, environment of the mini program
      version: '1.0.0', // Optional, version of the mini program
      service: 'miniapp', // Service name of the current application
      trackInteractions: true,
      traceType: 'ddtrace', // Not required, defaults to ddtrace; currently supports 6 types: ddtrace, zipkin, skywalking_v3, jaeger, zipkin_single_header, w3c_traceparent
      allowedTracingOrigins: ['https://api.example.com',/https:\/\/.*\.my-api-domain\.com/],  // Not required, list of origins or regex patterns for requests that allow trace headers
    })
	```

## Configuration

### Initialization Parameters

| Parameter                        | Type    | Required | Default Value | Description                                                         |
| --------------------------------- | ------- | -------- | ------------- | ------------------------------------------------------------------- |
| `applicationId`                  | String  | Yes      |               | Application ID created in <<< custom_key.brand_name >>>.            |
| `datakitOrigin`                  | String  | Yes      |               | DataKit Origin for data reporting;<br/>:warning: must be added to the request whitelist in the mini program management backend. |
| `env`                            | String  | No       |               | Current environment of the mini program, e.g., prod: production; gray: gray release; pre: pre-release; common: daily; local: local. |
| `version`                        | String  | No       |               | Version number of the mini program.                                 |
| `service`                        | String  | No       | `miniapp`     | Service name of the current application, default is `miniapp`, supports custom configuration. |
| `sampleRate`                     | Number  | No       | `100`         | Percentage of metric data collection: `100` means full collection, `0` means no collection. |
| `trackInteractions`              | Boolean | No       | `false`       | Whether to enable user interaction tracking.                        |
| `traceType`                      | Enum    | No       | `ddtrace`     | Tracing tool type, defaults to `ddtrace`. Currently supports 6 types: `ddtrace`, `zipkin`, `skywalking_v3`, `jaeger`, `zipkin_single_header`, `w3c_traceparent`.<br> :warning: <br>1. `opentelemetry` supports 4 types: `zipkin_single_header`, `w3c_traceparent`, `zipkin`, `jaeger`.<br>2. Configuring different `traceType` requires setting different `Access-Control-Allow-Headers` for corresponding API services; see [How APM Connects with RUM](../../application-performance-monitoring/collection/connect-web-app.md). |
| `traceId128Bit`                  | Boolean | No       | `false`       | Whether to generate `traceID` using 128 bits, corresponding to `traceType`; currently supports `zipkin`, `jaeger`. |
| `allowedTracingOrigins`          | Array   | No       | `[]`          | 【New】List of origins or regex patterns for requests that allow trace headers. Can be origin (protocol://domain[:port]) or regex, e.g., `["https://api.example.com", /https:\\/\\/.*\\.my-api-domain\\.com/]`. |
| `isIntakeUrl`                    | Function | No       | `function(url) {return false}` | Custom method to determine if resource data should be collected based on the URL. Returns `false` to collect, `true` to skip.<br>:warning: <br>1. The return value must be Boolean, otherwise it's considered invalid.<br>2. Requires version 2.1.10 or higher. |

## Notes

1. The DataKit domain corresponding to `datakitOrigin` must be added to the request whitelist in the mini program management backend.
2. Due to limitations in the current WeChat Mini Program API (`wx.request`, `wx.downloadFile`), the `profile` field in the returned data is not supported on iOS systems, leading to incomplete collection of timing-related data. There is currently no solution: [request](https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html), [downloadFile](https://developers.weixin.qq.com/miniprogram/dev/api/network/download/wx.downloadFile.html), [API Support Status](https://developers.weixin.qq.com/community/develop/doc/000ecaa8b580c80601cac8e6f56000?highLine=%2520request%2520profile).
3. When `trackInteractions` is enabled, due to WeChat Mini Program restrictions, it cannot capture control content and structure data. Therefore, we use declarative programming in the mini program SDK by setting the `data-name` attribute in the WXML file to add names to interactive elements for easier statistical analysis and operation record location, for example:

```javascript
 <button bindtap="bindSetData" data-name="setData">setData</button>
```