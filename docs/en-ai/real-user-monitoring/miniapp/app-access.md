# WeChat Mini Program Application Integration
---

Guance can collect metrics data from various mini program applications. By introducing the SDK file, it monitors mini program performance metrics, error logs, and resource request data. After reporting this data to the Guance platform, it analyzes the performance of each mini program in a visual manner.

## Prerequisites

**Note**: If you have enabled the [RUM Headless](../../dataflux-func/headless.md) service, the prerequisites have been automatically configured for you, and you can directly integrate the application.

- Install [DataKit](../../datakit/datakit-install.md);
- Configure the [RUM Collector](../../integrations/rum.md);
- Configure DataKit to be [accessible via the public network and install the IP geolocation database](../../datakit/datakit-tools-how-to.md#install-ipdb).

## Application Integration

Log in to the Guance console, go to the **User Access Monitoring** page, click on **[Create New Application](../index.md#create)** in the top-left corner, and start creating a new application.

![](../img/6.rum_miniapp.png)

## Usage

Introduce the code into the app.js file of the mini program as follows:

**Note**: The introduction position must be before the App() initialization.

=== "NPM"

    NPM package introduction method can refer to the official WeChat documentation on [npm introduction](https://developers.weixin.qq.com/miniprogram/dev/devtools/npm.html)
    
    ```javascript
    const { datafluxRum } = require('@cloudcare/rum-miniapp')
    // Initialize RUM
    datafluxRum.init({
      datakitOrigin: '<DATAKIT ORIGIN>',// Required, DataKit domain name address, which needs to be added to the domain whitelist in the WeChat Mini Program management backend
      applicationId: '<Application ID>', // Required, application ID generated by the dataflux platform
      env: 'testing', // Optional, environment of the mini program
      version: '1.0.0', // Optional, version of the mini program
      service: 'miniapp', // Service name of the current application
      trackInteractions: true,
      traceType: 'ddtrace', // Not required, defaults to ddtrace, currently supports 6 types: ddtrace, zipkin, skywalking_v3, jaeger, zipkin_single_header, w3c_traceparent
      allowedTracingOrigins: ['https://api.example.com',/https:\/\/.*\.my-api-domain\.com/],  // Not required, list of origins or regex patterns that allow injecting trace headers
    })
    ```

=== "CDN"

    [Download File](https://static.guance.com/miniapp-sdk/v2/dataflux-rum-miniapp.js) for local introduction
    
    ```javascript
    const { datafluxRum } = require('./lib/dataflux-rum-miniapp.js')
    // Initialize RUM
    datafluxRum.init({
      datakitOrigin: '<DATAKIT ORIGIN>',// Required, DataKit domain name address, which needs to be added to the domain whitelist in the WeChat Mini Program management backend
      applicationId: '<Application ID>', // Required, application ID generated by the dataflux platform
      env: 'testing', // Optional, environment of the mini program
      version: '1.0.0', // Optional, version of the mini program
      service: 'miniapp', // Service name of the current application
      trackInteractions: true,
      traceType: 'ddtrace', // Not required, defaults to ddtrace, currently supports 6 types: ddtrace, zipkin, skywalking_v3, jaeger, zipkin_single_header, w3c_traceparent
      allowedTracingOrigins: ['https://api.example.com',/https:\/\/.*\.my-api-domain\.com/],  // Not required, list of origins or regex patterns that allow injecting trace headers
    })
    ```

## Configuration

### Initialization Parameters

| Parameter                     | Type   | Required | Default Value | Description                                                                 |
| ----------------------------- | ------ | -------- | ------------- | --------------------------------------------------------------------------- |
| `applicationId`               | String | Yes     |              | Application ID created from Guance.                                         |
| `datakitOrigin`               | String | Yes     |              | DataKit data reporting Origin;<br/>:warning: Needs to be added to the request whitelist in the mini program management backend. |
| `env`                         | String | No      |              | Current environment of the mini program application, such as prod: production environment; gray: gray release environment; pre: pre-release environment; common: daily environment; local: local environment. |
| `version`                     | String | No      |              | Version number of the mini program application.                             |
| `service`                     | String | No      | `miniapp`    | Service name of the current application, default is `miniapp`, supports custom configuration. |
| `sampleRate`                  | Number | No      | `100`        | Percentage of metric data collection: `100` means full collection, `0` means no collection. |
| `trackInteractions`           | Boolean | No      | `false`      | Whether to enable user interaction tracking.                                |
| `traceType`                   | Enum   | No      | `ddtrace`    | Configuration for tracing tool type, defaults to `ddtrace`. Currently supports 6 types: `ddtrace`, `zipkin`, `skywalking_v3`, `jaeger`, `zipkin_single_header`, `w3c_traceparent`.<br>:warning:<br>1. `opentelemetry` supports `zipkin_single_header`, `w3c_traceparent`, `zipkin`, `jaeger` 4 types.<br>2. Configuring corresponding `traceType` requires setting different `Access-Control-Allow-Headers` for corresponding API services, refer to [How APM Connects with RUM](../../application-performance-monitoring/collection/connect-web-app.md). |
| `traceId128Bit`               | Boolean | No      | `false`      | Whether to generate `traceID` in 128-bit format, corresponding to `traceType`, currently supports types `zipkin`, `jaeger`. |
| `allowedTracingOrigins`       | Array  | No      | `[]`         | 【New】List of origins or regex patterns that allow injecting `ddtrace` collector headers. Can be an origin or a regex pattern, origin: `protocol (including: //), domain name (or IP address)[and port]`. *Example: `["https://api.example.com", /https:\\/\\/.*\\.my-api-domain\\.com/]`* |
| `isIntakeUrl`                 | Function | No      | `function(url) {return false}` | Custom method to determine whether to collect data for a specific resource URL based on the request URL. Returns `false` to collect, `true` to skip.<br>:warning:<br>1. The return value must be of Boolean type, otherwise it is considered invalid.<br>2. Requires version 2.1.10 or higher. |

## Notes

1. The domain name corresponding to `datakitOrigin` must be added to the request whitelist in the mini program management backend.
2. Due to current limitations of the WeChat Mini Program's request resources APIs `wx.request`, `wx.downloadFile`, the `profile` field in returned data is not supported on iOS systems, leading to incomplete collection of resource information related to timing data. There is currently no solution: [request](https://developers.weixin.qq.com/miniprogram/dev/api/network/request/wx.request.html), [downloadFile](https://developers.weixin.qq.com/miniprogram/dev/api/network/download/wx.downloadFile.html), [API Support Status](https://developers.weixin.qq.com/community/develop/doc/000ecaa8b580c80601cac8e6f56000?highLine=%2520request%2520profile).
3. When `trackInteractions` is enabled, due to restrictions in WeChat Mini Programs, control content and structure data cannot be collected. Therefore, declarative programming is used in the mini program SDK. By setting the `data-name` attribute in the wxml file, names can be added to interactive elements for easier tracking and positioning of operation records. For example:

```javascript
 <button bindtap="bindSetData" data-name="setData">setData</button>
```