---
title     : 'Profiling .Net'
summary   : '.Net Profiling Integration'
tags:
  - '.Net'
  - 'PROFILE'
__int_icon: 'icon/profiling'
---

Support for using [`dd-trace-dotnet`](https://github.com/DataDog/dd-trace-dotnet){:target="_blank"} as an APM tool for the `.NET` platform has been available since Datakit [:octicons-tag-24: Version-1.12.0](../datakit/changelog.md#cl-1.12.0){:target="_blank"}.

## Prerequisites {#prerequisites}

- `.NET Framework 4.5.2+` / `.NET Core 2.1, 3.1, 5, 6, 7`
- `Linux with glibc 2.17+` / `Windows 10+` / `Windows Server 2012+`

## Install `dd-trace-dotnet` {#install-dd-trace-dotnet}

<!-- markdownlint-disable MD046 -->
=== "Linux"

    Add the `Datadog.Trace.Bundle` package:

    ```shell
    dotnet add package Datadog.Trace.Bundle
    ```

=== "Windows"

    Download the `datadog-dotnet-apm-<VERSION>-x64.msi` file, such as `datadog-dotnet-apm-2.34.0-x64.msi`, from the [`https://github.com/DataDog/dd-trace-dotnet/releases`](https://github.com/DataDog/dd-trace-dotnet/releases){:target="_blank"} page and install it using administrator privileges.


???+ Note

    The highest supported version is currently `dd-trace-dotnet v2.34.0`. Higher versions have not been systematically tested, and compatibility is unknown. If you encounter any issues during use, please contact us.
<!-- markdownlint-enable -->


## Enable Profiling {#start-profiling}

### On Linux {#on-linux}

Navigate to the output directory after compiling or publishing your project. There should be a `datadog` directory containing the target files generated by `dd-trace-dotnet`, with different subdirectories for different platforms.

<!-- markdownlint-disable MD046 -->
???+ Note "Directory Description"

    The output directory for a .NET Core build (build) is typically located in *./bin/<Configuration\>/<Framework\>*, which can be specified using `-o|--output <OUTPUT_DIR>`. In this document, we assume it to be *./bin/Release/net7.0*.
    The output directory for a .NET Core publish (publish) is typically located in *./bin/<Configuration\>/<Framework\>/publish*, which can also be specified using `-o|--output <OUTPUT_DIR>`. In this document, we assume it to be *./bin/Release/net7.0/publish*.
<!-- markdownlint-enable -->


```shell
$ ls -l bin/Release/net7.0/datadog/
total 8
-rwxr--r--   1 zy  staff  101  7  3 21:06 createLogPath.sh
drwxr-xr-x   8 zy  staff  256  7 27 16:16 linux-arm64
drwxr-xr-x   8 zy  staff  256  7 27 16:16 linux-musl-x64
drwxr-xr-x   8 zy  staff  256  7 27 16:16 linux-x64
drwxr-xr-x   8 zy  staff  256  7 27 16:16 net461
drwxr-xr-x   7 zy  staff  224  7 27 16:16 net6.0
drwxr-xr-x   7 zy  staff  224  7 27 16:16 netcoreapp3.1
drwxr-xr-x  12 zy  staff  384  7 27 16:16 netstandard2.0
drwxr-xr-x   6 zy  staff  192  7 27 16:16 osx
drwxr-xr-x   7 zy  staff  224  7 27 16:16 win-x64
drwxr-xr-x   7 zy  staff  224  7 27 16:16 win-x86
```

Set the `DDTRACE_HOME` environment variable:

```shell
DDTRACE_HOME="$(pwd)/bin/Release/net7.0/datadog"
```

Verify the environment variable setting:

```shell
ls -l $DDTRACE_HOME
```

Set the environment variables and start the project:

```shell
DD_DOTNET_TRACER_HOME="$DDTRACE_HOME" \
CORECLR_ENABLE_PROFILING=1 \
CORECLR_PROFILER="{846F5F1C-F9AE-4B07-969E-05C26BC060D8}" \
CORECLR_PROFILER_PATH="$DDTRACE_HOME/linux-x64/Datadog.Trace.ClrProfiler.Native.so" \
LD_PRELOAD="$DDTRACE_HOME/linux-x64/Datadog.Linux.ApiWrapper.x64.so" \
DD_PROFILING_ENABLED=1 \
DD_PROFILING_WALLTIME_ENABLED=1 \
DD_PROFILING_CPU_ENABLED=1 \
DD_PROFILING_EXCEPTION_ENABLED=1 \
DD_PROFILING_ALLOCATION_ENABLED=1 \
DD_PROFILING_LOCK_ENABLED=1 \
DD_PROFILING_HEAP_ENABLED=1 \
DD_PROFILING_GC_ENABLED=1 \
DD_SERVICE=dotnet-profiling-demo DD_ENV=testing DD_VERSION=1.2.3 \
DD_AGENT_HOST=127.0.0.1 DD_TRACE_AGENT_PORT=9529 \
dotnet bin/Release/net7.0/<your-project-name>.dll
```

<!-- markdownlint-disable MD046 -->
???+ Note

    If your architecture is `Linux arm64`, modify the settings to `CORECLR_PROFILER_PATH="$DDTRACE_HOME/linux-arm64/Datadog.Trace.ClrProfiler.Native.so"` and
    `LD_PRELOAD="$DDTRACE_HOME/linux-arm64/Datadog.Linux.ApiWrapper.x64.so"`
<!-- markdownlint-enable -->

After a few minutes, you can view the related data in the [Guance Console](https://console.guance.com/tracing/profile){:target="_blank"}.

### On Windows IIS {#on-windows-iis}

- Install the [*datadog-dotnet-apm-2.34.0-x64.msi*](https://github.com/DataDog/dd-trace-dotnet/releases/download/v2.34.0/datadog-dotnet-apm-2.34.0-x64.msi){:target="_blank"} component on the server.

- Edit the `web.config` configuration file in the root path of the project deployed on `IIS`. Add the `<environmentVariables></environmentVariables>` tag within the `<aspNetCore>...</aspNetCore>` tags (if it already exists, skip this step), and include the following environment variables:

```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
    <location path="." inheritInChildApplications="false">
        <system.webServer>
            <handlers>
                <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
            </handlers>
            <aspNetCore processPath=".\dotnet-profiling-demo.exe" stdoutLogEnabled="false" stdoutLogFile=".\logs\stdout" hostingModel="InProcess">
                
              <environmentVariables>
                  <!-- Add the following environment variables here, adjusting DD_ENV, DD_SERVICE, and DD_VERSION values according to your actual situation -->
                  <!-- DD_AGENT_HOST and DD_TRACE_AGENT_PORT are the address and port listened by Datakit -->
                <environmentVariable name="CORECLR_ENABLE_PROFILING" value="1" />
                <environmentVariable name="CORECLR_PROFILER" value="{846F5F1C-F9AE-4B07-969E-05C26BC060D8}" />
                <environmentVariable name="DD_PROFILING_ENABLED" value="1" />
                <environmentVariable name="DD_PROFILING_CPU_ENABLED" value="1" />
                <environmentVariable name="DD_PROFILING_WALLTIME_ENABLED" value="1" />
                <environmentVariable name="DD_PROFILING_ALLOCATION_ENABLED" value="1" />
                <environmentVariable name="DD_PROFILING_HEAP_ENABLED" value="1" />
                <environmentVariable name="DD_PROFILING_EXCEPTION_ENABLED" value="1" />
                <environmentVariable name="DD_PROFILING_LOCK_ENABLED" value="1" />
                <environmentVariable name="DD_PROFILING_GC_ENABLED" value="1" />
                <environmentVariable name="DD_ENV" value="production" />
                <environmentVariable name="DD_VERSION" value="1.2.3" />
                <environmentVariable name="DD_SERVICE" value="my-dotnet-core-app" />
                <environmentVariable name="DD_AGENT_HOST" value="127.0.0.1" />
                <environmentVariable name="DD_TRACE_AGENT_PORT" value="9529" />
              </environmentVariables>
                
            </aspNetCore>
        </system.webServer>
    </location>
</configuration>
```

- Restart the `IIS` server and access your project.

```shell
net stop /y was
net start w3svc
```

After a few minutes, you can view the related data in the [Guance Console](https://console.guance.com/tracing/profile){:target="_blank"}.