# DataKit面对复杂传输网络抖动的配置能力
---

## 概述
Datakit 是运行在用户本地机器上的一种基础数据采集工具，主要用于采集系统运行的各种指标、日志等数据，将它们汇总发送给观测云，在观测云中，用户可以查看并分析自己的各种指标、日志等数据。DataKit 是观测云中至关重要的一个数据采集组件，几乎所有观测云中的数据都是来源于 DataKit ，所以 DataKit 拥有完善的数据保障设计，用以保障避免用户上报的数据发生丢失。

本指南为您介绍 DataKit 的数据保障能力。

## 前置条件
您需要先创建一个 [观测云账号](https://www.guance.com)，并在您的主机上 [安装 DataKit](../../datakit/datakit-install.md) 。
## DataKit 基础网络模型
DataKit 网络模型主要分为三层，可以简单概括为用户环境、DataWay 以及观测云中心，如下图所示：

![](../img/9.datakit_network_1.png)

1. DataKit 主要通过定期采集的方式，采集各种不同的指标，然后定时、定量通过 HTTP(s) 将数据发送给 DataWay。每个 DataKit 都会配置对应的 token，用于标识不同的用户
> 如果用户内网环境没有开通外网请求，可以通过 [Nginx 做一层代理](http://wiznote-desktop/proxy#6778a8b6)出来，也可以通过 DataKit 内置的 [Proxy 采集器](http://wiznote-desktop/proxy) 来实现流量代理

2. DataWay 收到数据后，转发给观测云，在发给观测云的数据中，带有 API 签名  
3. 观测云收到合法的数据后，根据不同的数据类型，通过kodo的队列分别写入不同的存储中

对于采集类的数据业务，目前整个数据传输链路做了如下丢失保护：

1. DataKit 因为某些网络原因，发送 DataWay 失败，此时 DataKit 会缓存最大一千个点的数据。当缓存的数据超过这个量，这个缓存会被清理掉
> 在 Datakit 配置文件 [io] 模块中开启 enable_cache 选项，并且可以根据自己的需求更改最大保存数量（max_cache_count）

![](../img/9.datakit_network_2.png)

2. DataWay 可能因为某些原因，发送观测云失败，或者因为流量较大，来不及发送给观测云，DataWay 会将这些数据持久化到磁盘。后续待流量降低或网络恢复时，再将这些数据发送给观测云。延迟发送的数据，不影响时效性，时间戳是附着在缓存的数据中的。
3. 通过 kodo 的队列进行缓存保障数据正确的被分别写入不同的存储中

在 DataWay 上，为保护磁盘，这个磁盘的最大用量也是可以配置的，以免将所在节点的存储撑爆。对于超过用量的数据，DataWay 也是选择丢弃数据。不过这个容量一般设置得比较大。
